"use strict";exports.id=9521,exports.ids=[9521],exports.modules={83178:(e,t,i)=>{i.r(t),i.d(t,{default:()=>c});var n=i(53524);let r=globalThis,a="phase-production-build"===process.env.NEXT_PHASE||!0,o=r.prisma??(()=>{let e=new n.PrismaClient({log:["error"],datasources:{db:{url:function(){let e=process.env.DATABASE_URL||"";if(e.includes("connection_limit")||e.includes("pool_timeout"))return e;let t=e.includes("?")?"&":"?";return`${e}${t}connection_limit=${a?1:10}&pool_timeout=${a?60:20}&connect_timeout=10&socket_timeout=20&pgbouncer=true&statement_cache_size=0`}()}}});return e.$use(async(t,i)=>{let n=0;for(;n<=5;)try{let e=await i(t);return r.lastConnectTime=Date.now(),e}catch(i){let t=i instanceof Error?i.message:String(i);if((t.includes("idle-session timeout")||t.includes("terminating connection")||t.includes("ECONNRESET")||t.includes("Connection refused")||t.includes("connection closed")||t.includes("socket")||t.includes("ETIMEDOUT")||t.includes("connection timed out")||t.includes("prepared statement"))&&n<5){if(n++,console.log(`[Prisma] Connection error, retry ${n}/5: ${t.substring(0,100)}`),n>=2)try{await e.$disconnect(),await e.$connect(),console.log("[Prisma] Reconnected successfully")}catch{}await new Promise(e=>setTimeout(e,100*Math.pow(2,n-1)));continue}throw i}}),e})();r.prisma=o,"undefined"!=typeof process&&process.on("beforeExit",async()=>{await o.$disconnect()});let s=null;"undefined"==typeof process||a||!s&&(a||(s=setInterval(async()=>{try{await o.$queryRaw`SELECT 1`}catch(e){console.warn("[Prisma KeepAlive] Bağlantı hatası, yeniden bağlanılıyor:",e.message?.substring(0,80));try{await o.$connect(),console.log("[Prisma KeepAlive] Yeniden bağlantı başarılı")}catch(e){console.error("[Prisma KeepAlive] Yeniden bağlantı başarısız!")}}},12e4)).unref());let c=o},59521:(e,t,i)=>{i.d(t,{H9:()=>y,Ky:()=>c,LW:()=>w,QB:()=>r,Sw:()=>p,Vm:()=>f,d5:()=>d,dt:()=>g,et:()=>s,ij:()=>m,n$:()=>a,oy:()=>u});var n=i(83178);async function r(e){try{let t=await n.default.iPBlacklist.findFirst({where:{ip:e,isActive:!0,OR:[{expiresAt:null},{expiresAt:{gt:new Date}}]}});if(t)return await n.default.iPBlacklist.update({where:{id:t.id},data:{hitCount:{increment:1},lastHitAt:new Date}}),{allowed:!1,reason:`IP blacklisted: ${t.reason||"G\xfcvenlik ihlali"}`};let i=await n.default.adminIPWhitelist.count({where:{isActive:!0}});if(0===i)return{allowed:!0};if(!await n.default.adminIPWhitelist.findFirst({where:{ip:e,isActive:!0,OR:[{expiresAt:null},{expiresAt:{gt:new Date}}]}}))return await u({eventType:"suspicious_request",ip:e,severity:"high",metadata:{reason:"Admin access from non-whitelisted IP"}}),{allowed:!1,reason:"IP adresi admin erişimi i\xe7in yetkilendirilmemiş"};return{allowed:!0}}catch(e){return console.error("IP whitelist check error:",e),{allowed:!1,reason:"G\xfcvenlik kontrol\xfc başarısız"}}}async function a(e){try{let t=await n.default.iPBlacklist.findFirst({where:{ip:e,isActive:!0,OR:[{expiresAt:null},{expiresAt:{gt:new Date}}]}});if(t)return await n.default.iPBlacklist.update({where:{id:t.id},data:{hitCount:{increment:1},lastHitAt:new Date}}),{blocked:!0,reason:t.reason||"IP engellendi"};return{blocked:!1}}catch(e){return console.error("IP blacklist check error:",e),{blocked:!1}}}async function o(e,t,i,r){try{await n.default.iPBlacklist.upsert({where:{ip:e},update:{reason:t,addedBy:i,isActive:!0,expiresAt:r?new Date(Date.now()+36e5*r):null},create:{ip:e,reason:t,addedBy:i,expiresAt:r?new Date(Date.now()+36e5*r):null}})}catch(e){console.error("Add to blacklist error:",e)}}async function s(e,t,i,r){try{for(let[a,s]of Object.entries(i))if(s&&""!==s.trim())return await n.default.honeypotLog.create({data:{ip:e,userAgent:r,endpoint:t,fieldName:a,fieldValue:s.substring(0,500)}}),await u({eventType:"suspicious_request",ip:e,userAgent:r,severity:"high",metadata:{reason:"Honeypot triggered",endpoint:t,fieldName:a}}),await n.default.honeypotLog.count({where:{ip:e,createdAt:{gte:new Date(Date.now()-36e5)}}})>=3&&await o(e,"Multiple honeypot triggers","system",24),{isBot:!0,fieldTriggered:a};return{isBot:!1}}catch(e){return console.error("Honeypot check error:",e),{isBot:!1}}}async function c(e,t,i,r){try{if(await n.default.accountLockoutNotification.findFirst({where:{email:e,sentAt:{gte:new Date(Date.now()-36e5)}}}))return;await n.default.accountLockoutNotification.create({data:{email:e,ip:t,userId:r,reason:`${i} başarısız giriş denemesi`,attempts:i}});let a=process.env.NOTIF_ID_ACCOUNT_LOCKOUT;if(a)try{(await fetch(`${process.env.NEXTAUTH_URL}/api/send-notification`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({notification_id:a,to_email:e,subject:"⚠️ Hesap G\xfcvenlik Uyarısı - TAKAS-A",html_body:`
              <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                <h2 style="color: #dc2626;">⚠️ Hesabınız Ge\xe7ici Olarak Kilitlendi</h2>
                <p>Sayın Kullanıcı,</p>
                <p>Hesabınıza <strong>${i}</strong> başarısız giriş denemesi yapıldı.</p>
                <p><strong>Detaylar:</strong></p>
                <ul>
                  <li>IP Adresi: ${t}</li>
                  <li>Tarih: ${new Date().toLocaleString("tr-TR")}</li>
                </ul>
                <p style="color: #dc2626; font-weight: bold;">
                  Hesabınız g\xfcvenlik nedeniyle 30 dakika s\xfcreyle kilitlenmiştir.
                </p>
                <p>Bu sizin girişiminiz değilse, şifrenizi değiştirmenizi \xf6neririz.</p>
                <hr style="border: 1px solid #eee; margin: 20px 0;">
                <p style="color: #666; font-size: 12px;">
                  Bu email TAKAS-A g\xfcvenlik sistemi tarafından otomatik g\xf6nderilmiştir.
                </p>
              </div>
            `})})).ok||console.error("Lockout notification email failed")}catch(e){console.error("Email send error:",e)}await u({eventType:"account_locked",ip:t,email:e,userId:r,severity:"high",metadata:{attempts:i,notificationSent:!0}})}catch(e){console.error("Send lockout notification error:",e)}}let l={maxAttempts:5,windowMs:9e5,lockoutMs:18e5};async function u(e){let{eventType:t,ip:i,userAgent:r,userId:a,email:o,metadata:s,severity:c="low"}=e;try{await n.default.securityLog.create({data:{eventType:t,ip:i,userAgent:r||null,userId:a||null,email:o||null,metadata:s?JSON.stringify(s):null,severity:c,createdAt:new Date}}),("high"===c||"critical"===c)&&console.warn(`[SECURITY ${c.toUpperCase()}] ${t} from IP: ${i}`,s)}catch(e){console.error("Security log error:",e)}}async function d(e,t){let i=new Date,r=new Date(i.getTime()-l.windowMs);try{let a=await n.default.securityLog.count({where:{ip:e,eventType:"login_failed",createdAt:{gte:r}}}),o=0;t&&(o=await n.default.securityLog.count({where:{email:t,eventType:"login_failed",createdAt:{gte:r}}}));let s=Math.max(a,o);if(s>=l.maxAttempts){let a=await n.default.securityLog.findFirst({where:{OR:[{ip:e,eventType:"login_failed"},t?{email:t,eventType:"login_failed"}:{}],createdAt:{gte:r}},orderBy:{createdAt:"desc"}});if(a){let n=new Date(a.createdAt.getTime()+l.lockoutMs);if(i<n)return await u({eventType:"brute_force_detected",ip:e,email:t,severity:"high",metadata:{totalAttempts:s,lockedUntil:n.toISOString()}}),{allowed:!1,remainingAttempts:0,lockedUntil:n}}}return{allowed:!0,remainingAttempts:Math.max(0,l.maxAttempts-s)}}catch(e){return console.error("Login attempt check error:",e),{allowed:!0,remainingAttempts:l.maxAttempts}}}async function f(e,t,i,n){await u({eventType:"login_failed",ip:e,email:t,userAgent:i,severity:"medium",metadata:{reason:n||"Invalid credentials"}})}async function w(e,t,i,n){await u({eventType:"login_success",ip:e,userId:t,email:i,userAgent:n,severity:"low",metadata:{timestamp:new Date().toISOString()}})}async function p(e){let t=process.env.RECAPTCHA_SECRET_KEY;if(!t)return console.warn("reCAPTCHA secret key not configured"),{success:!0};try{let i=await fetch("https://www.google.com/recaptcha/api/siteverify",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`secret=${t}&response=${e}`}),n=await i.json();return{success:n.success&&(void 0===n.score||n.score>=.5),score:n.score}}catch(e){return console.error("reCAPTCHA verification error:",e),{success:!1}}}function y(e){let t=e.headers.get("x-real-ip");if(t)return t.trim();let i=e.headers.get("x-forwarded-for");if(i){let e=i.split(",").map(e=>e.trim()).filter(Boolean);return e[e.length-1]||"unknown"}return"unknown"}function m(e){return e.headers.get("user-agent")||"unknown"}async function g(){let e=new Date,t=new Date(e.getTime()-864e5),i=new Date(e.getTime()-6048e5),[r,a,o,s,c,l]=await Promise.all([n.default.securityLog.count(),n.default.securityLog.count({where:{createdAt:{gte:t}}}),n.default.securityLog.count({where:{createdAt:{gte:i}}}),n.default.securityLog.groupBy({by:["eventType"],_count:!0,where:{createdAt:{gte:i}}}),n.default.securityLog.groupBy({by:["severity"],_count:!0,where:{createdAt:{gte:i}}}),n.default.$queryRaw`
      SELECT ip, COUNT(*) as count 
      FROM "SecurityLog" 
      WHERE "createdAt" >= ${t} AND "eventType" = 'login_failed'
      GROUP BY ip 
      ORDER BY count DESC 
      LIMIT 10
    `]);return{total:r,last24h:a,last7d:o,byType:s,bySeverity:c,topIPs:l}}}};