"use strict";exports.id=5578,exports.ids=[5578],exports.modules={11826:(e,t,a)=>{a.d(t,{L:()=>u});var r=a(66291),i=a(64617),s=a(3390),n=a.n(s),d=a(83178),o=a(59521);let u={adapter:(0,i.N)(d.default),providers:[(0,r.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e,t){if(!e?.email||!e?.password)return null;let a=t?.headers?.["x-real-ip"],r=t?.headers?.["x-forwarded-for"],i=a?Array.isArray(a)?a[0]:a:r&&(Array.isArray(r)?r[0]:r).split(",").pop()?.trim()||"unknown",s=t?.headers?.["user-agent"]||"unknown";if(!(await (0,o.d5)(i,e.email)).allowed)throw await (0,o.Ky)(e.email,i,5,void 0),Error("ACCOUNT_LOCKED");let u=await d.default.user.findUnique({where:{email:e.email}});return u?await n().compare(e.password,u.password)?(await (0,o.LW)(i,u.id,u.email,s),await d.default.user.update({where:{id:u.id},data:{lastLoginAt:new Date}}),{id:u.id,email:u.email,name:u.name,role:u.role}):(await (0,o.Vm)(i,e.email,s,"Invalid password"),null):(await (0,o.Vm)(i,e.email,s,"User not found"),null)}})],session:{strategy:"jwt",maxAge:86400,updateAge:300},jwt:{maxAge:86400},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.role=t.role),e),session:async({session:e,token:t})=>(e?.user&&(e.user.id=t?.id,e.user.role=t?.role),e)},pages:{signIn:"/giris"},secret:process.env.NEXTAUTH_SECRET,cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}}}},83940:(e,t,a)=>{a.d(t,{C8:()=>l,CW:()=>E,MW:()=>g,ow:()=>m,zm:()=>y});var r=a(83178),i=a(68247),s=a(59628);async function n(e,t,a,s,n){try{let l=await r.default.swapRequest.findUnique({where:{id:e},include:{product:{include:{category:!0}},requester:{select:{id:!0,name:!0}},owner:{select:{id:!0,name:!0}}}});if(!l)return{success:!1,error:"Takas bulunamadı"};let c=l.status,p=i.Sq[c]||[];if(!p.includes(t))return{success:!1,error:`Ge\xe7ersiz durum ge\xe7işi: ${c} → ${t}. İzin verilen: ${p.join(", ")}`};let w=await d(l,t,a);if(w)return{success:!1,error:w};let f=await o(l,t),m=await r.default.$transaction(async r=>{let i=await r.swapRequest.update({where:{id:e},data:{status:t,...f},include:{product:!0,requester:{select:{id:!0,name:!0,email:!0}},owner:{select:{id:!0,name:!0,email:!0}}}});return await r.swapStatusLog.create({data:{swapRequestId:e,fromStatus:c,toStatus:t,changedBy:a,reason:s,metadata:n||{}}}),i});return await u(m,c,t,a),{success:!0,newStatus:t,swap:m}}catch(e){return console.error("State transition error:",e),{success:!1,error:"Durum g\xfcncellenirken hata oluştu"}}}async function d(e,t,a){let r=e.requesterId===a,i=e.ownerId===a;if(!r&&!i)return"Bu takas işlemi \xfczerinde yetkiniz yok";switch(t){case"accepted":if(!i)return"Sadece \xfcr\xfcn sahibi teklifi kabul edebilir";if("price_agreed"!==e.negotiationStatus)return"Fiyat \xfczerinde anlaşma sağlanmalı";break;case"rejected":if(!i)return"Sadece \xfcr\xfcn sahibi teklifi reddedebilir";break;case"cancelled":if("pending"===e.status&&!r)return"Bekleyen teklifi sadece teklif eden iptal edebilir";break;case"delivered":if(!e.ownerConfirmed||!e.receiverConfirmed)return"Her iki taraf da teslimatı onaylamalı";break;case"completed":if(e.disputeWindowEndsAt&&new Date<e.disputeWindowEndsAt)return"İtiraz s\xfcresi hen\xfcz dolmadı";break;case"disputed":if("delivered"!==e.status)return"İtiraz sadece teslim edilmiş takaslar i\xe7in a\xe7ılabilir";if(e.disputeWindowEndsAt&&new Date>e.disputeWindowEndsAt)return"İtiraz s\xfcresi dolmuş"}return null}async function o(e,t){let a={};switch(t){case"accepted":let r=e.agreedPriceRequester||e.product?.valorPrice||0,s=e.product?.category?.name;a.riskTier=(0,i.nk)(r,s);break;case"delivered":a.deliveredAt=new Date,a.disputeWindowEndsAt=(0,i.AN)(new Date),"low"===e.riskTier&&(a.autoCompleteEligible=!0);break;case"completed":a.valorReleased=!0;break;case"disputed":a.autoCompleteEligible=!1}return a}async function u(e,t,a,r){try{let i=e.requesterId===r?e.ownerId:e.requesterId,n={accepted:{title:"✅ Teklif Kabul Edildi",body:`${e.product.title} i\xe7in teklifiniz kabul edildi!`},rejected:{title:"❌ Teklif Reddedildi",body:`${e.product.title} i\xe7in teklifiniz reddedildi.`},cancelled:{title:"\uD83D\uDEAB Takas İptal Edildi",body:`${e.product.title} takası iptal edildi.`},delivered:{title:"\uD83D\uDCE6 Teslimat Onaylandı",body:`${e.product.title} teslimatı tamamlandı. 48 saat itiraz s\xfcresi başladı.`},completed:{title:"\uD83C\uDF89 Takas Tamamlandı",body:`${e.product.title} takası başarıyla tamamlandı!`},disputed:{title:"⚠️ İtiraz A\xe7ıldı",body:`${e.product.title} takası i\xe7in itiraz a\xe7ıldı.`}}[a];n&&await (0,s.LX)(i,s.j_.SWAP_REQUEST,{title:n.title,body:n.body,swapId:e.id,productTitle:e.product.title,fromStatus:t,toStatus:a})}catch(e){console.error("Failed to send transition notification:",e)}}async function l(e,t){try{let a=await r.default.swapRequest.findUnique({where:{id:e},include:{product:!0,requester:{select:{id:!0,name:!0}},owner:{select:{id:!0,name:!0}},negotiationHistory:{orderBy:{createdAt:"desc"},take:10}}});if(!a)return{success:!1,error:"Takas bulunamadı"};let i=a.requesterId===t.userId,s=a.ownerId===t.userId;if(!i&&!s)return{success:!1,error:"Bu takas i\xe7in yetkiniz yok"};if(!["pending","negotiating"].includes(a.status))return{success:!1,error:"Pazarlık sadece bekleyen veya pazarlık aşamasındaki takaslar i\xe7in yapılabilir"};if(a.negotiationDeadline&&new Date>a.negotiationDeadline)return{success:!1,error:"Pazarlık s\xfcresi dolmuş"};switch(t.type){case"propose":return await c(a,t,i);case"counter":return await p(a,t,i);case"accept":return await w(a,t,i);case"reject":return await f(a,t);default:return{success:!1,error:"Ge\xe7ersiz işlem tipi"}}}catch(e){return console.error("Negotiation error:",e),{success:!1,error:"Pazarlık işlemi başarısız"}}}async function c(e,t,a){let i=t.proposedPrice;if(!i||i<=0)return{success:!1,error:"Ge\xe7erli bir fiyat giriniz"};let n=a?e.agreedPriceRequester:e.agreedPriceOwner;await r.default.$transaction(async r=>{await r.swapRequest.update({where:{id:e.id},data:{...a?{agreedPriceRequester:i}:{agreedPriceOwner:i},..."pending"===e.status?{status:"negotiating"}:{},negotiationStatus:"price_proposed",lastCounterOfferAt:new Date}}),await r.negotiationHistory.create({data:{swapRequestId:e.id,userId:t.userId,actionType:"propose",proposedPrice:i,previousPrice:n,message:t.message}})});let d=a?e.ownerId:e.requesterId;return await (0,s.LX)(d,s.j_.SWAP_REQUEST,{title:"\uD83D\uDCB0 Yeni Fiyat Teklifi",body:`${e.product.title} i\xe7in ${i} Valor teklif edildi`,swapId:e.id}),{success:!0,negotiationStatus:"price_proposed"}}async function p(e,t,a){if(e.counterOfferCount>=e.maxCounterOffers)return{success:!1,error:`Maksimum karşı teklif sayısına (${e.maxCounterOffers}) ulaşıldı`};let i=t.proposedPrice;if(!i||i<=0)return{success:!1,error:"Ge\xe7erli bir fiyat giriniz"};let n=a?e.agreedPriceOwner:e.agreedPriceRequester;await r.default.$transaction(async r=>{await r.swapRequest.update({where:{id:e.id},data:{...a?{agreedPriceRequester:i}:{agreedPriceOwner:i},..."pending"===e.status?{status:"negotiating"}:{},negotiationStatus:"price_proposed",counterOfferCount:{increment:1},lastCounterOfferAt:new Date}}),await r.negotiationHistory.create({data:{swapRequestId:e.id,userId:t.userId,actionType:"counter",proposedPrice:i,previousPrice:n,message:t.message}})});let d=a?e.ownerId:e.requesterId;return await (0,s.LX)(d,s.j_.SWAP_REQUEST,{title:"\uD83D\uDD04 Karşı Teklif",body:`${e.product.title} i\xe7in ${i} Valor karşı teklif yapıldı`,swapId:e.id}),{success:!0,negotiationStatus:"price_proposed"}}async function w(e,t,a){let i=a?e.agreedPriceOwner:e.agreedPriceRequester;if(!i)return{success:!1,error:"Kabul edilecek bir teklif yok"};await r.default.$transaction(async a=>{await a.swapRequest.update({where:{id:e.id},data:{agreedPriceRequester:i,agreedPriceOwner:i,negotiationStatus:"price_agreed",priceAgreedAt:new Date}}),await a.negotiationHistory.create({data:{swapRequestId:e.id,userId:t.userId,actionType:"accept",proposedPrice:i,message:t.message}})});let n=a?e.ownerId:e.requesterId;return await (0,s.LX)(n,s.j_.SWAP_ACCEPTED,{title:"\uD83E\uDD1D Fiyat Kabul Edildi!",body:`${e.product.title} i\xe7in ${i} Valor \xfczerinde anlaşıldı`,swapId:e.id}),{success:!0,negotiationStatus:"price_agreed",agreedPrice:i}}async function f(e,t){return await r.default.$transaction(async a=>{await a.swapRequest.update({where:{id:e.id},data:{negotiationStatus:"cancelled"}}),await a.negotiationHistory.create({data:{swapRequestId:e.id,userId:t.userId,actionType:"reject",message:t.message}})}),{success:!0,negotiationStatus:"cancelled"}}async function m(e){return await r.default.negotiationHistory.findMany({where:{swapRequestId:e},orderBy:{createdAt:"asc"}})}async function y(e){return await r.default.swapStatusLog.findMany({where:{swapRequestId:e},orderBy:{createdAt:"asc"}})}async function g(e,t,a,i){let s=await r.default.swapRequest.findUnique({where:{id:e}});if(!s)return{success:!1,error:"Takas bulunamadı"};if("delivered"!==s.status)return{success:!1,error:"İtiraz sadece teslim edilmiş takaslar i\xe7in a\xe7ılabilir"};if(s.disputeWindowEndsAt&&new Date>s.disputeWindowEndsAt)return{success:!1,error:"İtiraz s\xfcresi dolmuş"};let d=s.requesterId===t?s.ownerId:s.requesterId;return await r.default.$transaction(async r=>{await r.disputeReport.create({data:{swapRequestId:e,reporterId:t,reportedUserId:d,type:a,description:i,status:"open"}})}),await n(e,"disputed",t,a)}async function E(e){let t=await r.default.swapRequest.findUnique({where:{id:e},select:{id:!0,status:!0,deliveredAt:!0,disputeWindowEndsAt:!0,riskTier:!0,autoCompleteEligible:!0}});if(!t)return null;let a=new Date,i=!!t.disputeWindowEndsAt&&a<t.disputeWindowEndsAt,s=t.disputeWindowEndsAt?Math.max(0,Math.ceil((t.disputeWindowEndsAt.getTime()-a.getTime())/36e5)):0;return{...t,isInDisputeWindow:i,remainingHours:s,canOpenDispute:"delivered"===t.status&&i,canAutoComplete:t.autoCompleteEligible&&!i}}},68247:(e,t,a)=>{a.d(t,{AN:()=>l,F6:()=>d,Qi:()=>i,Sq:()=>o,kg:()=>r,nk:()=>u,u2:()=>c,uF:()=>p});let r=parseInt(process.env.DISPUTE_WINDOW_HOURS||"48"),i=(parseInt(process.env.LOCK_TIMEOUT_HOURS||"48"),parseInt(process.env.QR_CODE_VALIDITY_HOURS||"72"),parseInt(process.env.VERIFICATION_CODE_VALIDITY_HOURS||"24"),"false"!==process.env.AUTO_COMPLETE_LOW_RISK),s=(parseInt(process.env.AUTO_COMPLETE_DELAY_HOURS||"0"),parseFloat(process.env.PREMIUM_RATE_BASE||"0.015"),parseFloat(process.env.PREMIUM_RATE_MIN||"0.01"),parseFloat(process.env.PREMIUM_RATE_MAX||"0.03"),parseFloat(process.env.TARGET_RESERVE_RATIO_30D||"0.05"),parseFloat(process.env.POOL_REBALANCE_STEP||"0.0025"),{LOW_MAX:parseInt(process.env.RISK_LOW_MAX||"100"),MEDIUM_MAX:parseInt(process.env.RISK_MEDIUM_MAX||"500")}),n={Elektronik:1.5,Bilgisayar:1.5,Telefon:1.5,"Oyun Konsolu":1.3,Mücevher:2,Saat:1.5,Antika:2,Sanat:2,default:1},d={PENDING:"pending",ACCEPTED:"accepted",REJECTED:"rejected",IN_DELIVERY:"in_delivery",DELIVERED:"delivered",COMPLETED:"completed",CANCELLED:"cancelled",DISPUTED:"disputed",RESOLVED:"resolved"},o={pending:["accepted","rejected","cancelled"],accepted:["in_delivery","delivered","completed","cancelled","disputed"],rejected:[],in_delivery:["delivered","disputed"],delivered:["completed","disputed"],completed:[],cancelled:[],disputed:["resolved","completed","cancelled"],resolved:["completed","cancelled"]};function u(e,t){let a=e*(t?n[t]||n.default:1);return a<=s.LOW_MAX?"low":a<=s.MEDIUM_MAX?"medium":"high"}function l(e){let t=new Date(e);return t.setHours(t.getHours()+r),t}let c={completedSwap:2,positiveReview:1,negativeReview:-5,disputeLost:-10,cancelledByUser:-3,noShow:-15,fakeProduct:-25,reportedAbuse:-20,phoneVerification:5,identityVerification:5,accountAgePerMonth:0};function p(e,t){return Math.max(0,Math.min(100,e+t))}}};