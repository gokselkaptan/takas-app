"use strict";exports.id=3184,exports.ids=[3184],exports.modules={53184:(e,a,t)=>{t.d(a,{ER:()=>$,F6:()=>r,FR:()=>o,Hw:()=>Q,IN:()=>_,JW:()=>l,MJ:()=>K,Mw:()=>U,Of:()=>C,Oq:()=>q,R2:()=>k,RD:()=>X,TK:()=>O,UE:()=>A,WJ:()=>u,WT:()=>N,Wm:()=>y,ZQ:()=>L,_P:()=>p,cE:()=>z,checkFirstSwapGainLimit:()=>H,completeSwapWithFee:()=>V,dO:()=>S,fP:()=>I,fj:()=>c,getCompletedSwapCount:()=>J,getUsableBonusValor:()=>W,kw:()=>G,nx:()=>E,p1:()=>d,pL:()=>F,previewSwapFee:()=>T,pt:()=>M,rS:()=>v,w:()=>B,y2:()=>D,zz:()=>Y});var n=t(83178);let r=[{level:0,name:"Yeni \xdcye",emoji:"\uD83C\uDF31",minSwaps:0,minTrust:0,dailyBonus:1,productBonus:0,reviewBonus:0,referralBonus:0,swapBonusMin:0,swapBonusMax:0,streakEnabled:!1,monthlyCap:50},{level:1,name:"BaÅŸlangÄ±\xe7",emoji:"â­",minSwaps:1,minTrust:0,dailyBonus:2,productBonus:5,reviewBonus:2,referralBonus:3,swapBonusMin:3,swapBonusMax:8,streakEnabled:!1,monthlyCap:100},{level:2,name:"Aktif",emoji:"\uD83D\uDD25",minSwaps:3,minTrust:0,dailyBonus:3,productBonus:8,reviewBonus:3,referralBonus:5,swapBonusMin:5,swapBonusMax:12,streakEnabled:!0,monthlyCap:150},{level:3,name:"G\xfcvenilir",emoji:"\uD83C\uDFC6",minSwaps:5,minTrust:70,dailyBonus:4,productBonus:10,reviewBonus:5,referralBonus:8,swapBonusMin:5,swapBonusMax:15,streakEnabled:!0,monthlyCap:200},{level:4,name:"Uzman",emoji:"\uD83D\uDC8E",minSwaps:10,minTrust:80,dailyBonus:5,productBonus:12,reviewBonus:5,referralBonus:10,swapBonusMin:5,swapBonusMax:20,streakEnabled:!0,monthlyCap:250},{level:5,name:"Efsane",emoji:"\uD83D\uDC51",minSwaps:25,minTrust:90,dailyBonus:5,productBonus:15,reviewBonus:5,referralBonus:10,swapBonusMin:8,swapBonusMax:25,streakEnabled:!0,monthlyCap:300}],i=new Map;function s(e){i.delete(e)}let u="false"!==process.env.PROGRESSIVE_ECONOMY;async function o(e,a=!0){if(a){let a=i.get(e);if(a&&Date.now()<a.expiresAt)return a.data}let[t,s]=await Promise.all([n.default.user.findUnique({where:{id:e},select:{trustScore:!0}}),n.default.swapRequest.count({where:{OR:[{requesterId:e},{ownerId:e}],status:"completed"}})]),u=t?.trustScore||0,o=r[0];for(let e of r)s>=e.minSwaps&&u>=e.minTrust&&(o=e);let l={...o,swapCount:s};return i.set(e,{data:l,expiresAt:Date.now()+3e5}),l}async function l(e){let a=new Date;return a.setDate(1),a.setHours(0,0,0,0),(await n.default.valorTransaction.aggregate({where:{toUserId:e,type:{in:b.map(e=>e.toString())},createdAt:{gte:a}},_sum:{amount:!0}}))._sum.amount||0}let d=5,c=5,m=[{days:3,bonus:2},{days:7,bonus:5},{days:14,bonus:10},{days:30,bonus:20}],f=[{id:"first_swap",swaps:1,bonus:5,message:"\uD83C\uDF89 Ä°lk takasÄ±nÄ±z! +5 Valor"},{id:"swap_3",swaps:3,bonus:10,message:"â­ 3 takas tamamlandÄ±! Seviye atladÄ±nÄ±z! +10 Valor"},{id:"swap_5",swaps:5,bonus:15,message:"\uD83C\uDFC6 G\xfcvenilir TakaÅŸ\xe7Ä±! +15 Valor"},{id:"swap_10",swaps:10,bonus:25,message:"\uD83D\uDD25 Takas UzmanÄ±! +25 Valor"},{id:"swap_25",swaps:25,bonus:50,message:"\uD83D\uDC51 Takas Efsanesi! +50 Valor"},{id:"swap_50",swaps:50,bonus:100,message:"\uD83D\uDC8E Elmas TakaÅŸ\xe7Ä±! +100 Valor"}],w=[50,100,150,200,250,300],p=5,y=10,k=5,v=3,b=["welcome_bonus","survey_bonus","referral_bonus","referral_active_bonus","daily_bonus","product_bonus","review_bonus","achievement_bonus","milestone_bonus"];async function h(e){let a=new Date;return a.setDate(1),a.setHours(0,0,0,0),(await n.default.escrowLedger.aggregate({where:{userId:e,type:{in:b.map(e=>e.toString())},createdAt:{gte:a}},_sum:{amount:!0}}))._sum.amount||0}async function g(e,a){let t=w[(await o(e)).level]||50,n=await h(e);return n>=t?0:Math.min(a,t-n)}let B=[{limit:200,rate:.005},{limit:500,rate:.01},{limit:1e3,rate:.015},{limit:2500,rate:.02},{limit:5e3,rate:.025},{limit:1/0,rate:.03}];function D(e){let a={bracket1:0,bracket2:0,bracket3:0,bracket4:0,bracket5:0,bracket6:0,total:0,effectiveRate:0},t=e,n=0;return B.forEach((e,r)=>{let i=e.limit===1/0?t:e.limit-n,s=Math.min(t,i);if(s<=0)return;let u=s*e.rate,o=`bracket${r+1}`;"number"==typeof a[o]&&(a[o]=Math.round(100*u)/100),a.total+=u,t-=s,n=e.limit}),a.total=Math.max(1,Math.round(a.total)),a.effectiveRate=e>0?Math.round(a.total/e*1e4)/100:0,a}async function x(){let e=await n.default.systemConfig.findUnique({where:{id:"main"}});return e||(e=await n.default.systemConfig.create({data:{id:"main",totalValorSupply:BigInt(1e9),distributedValor:BigInt(0),communityPoolValor:BigInt(0),reserveValor:BigInt(2e8)}})),e}async function A(e){let a=await n.default.user.findUnique({where:{id:e}});if(!a||a.welcomeBonusGiven)return!1;let t=await x();return Number(t.distributedValor)+d>Number(t.totalValorSupply)?(console.log("Valor arzÄ± t\xfckendi, hoÅŸgeldin bonusu verilemedi"),!1):(await n.default.$transaction([n.default.user.update({where:{id:e},data:{valorBalance:{increment:d},welcomeBonusGiven:!0,lastActiveAt:new Date}}),n.default.systemConfig.update({where:{id:"main"},data:{distributedValor:{increment:d},totalTransactions:{increment:1}}}),n.default.valorTransaction.create({data:{toUserId:e,amount:d,fee:0,netAmount:d,type:"welcome_bonus",description:"HoÅŸgeldin bonusu - TAKAS-A topluluÄŸuna katÄ±ldÄ±nÄ±z!"}})]),!0)}async function C(e){let a=await n.default.user.findUnique({where:{id:e}});if(!a||a.surveyCompleted)return!1;let t=await x();return!(Number(t.distributedValor)+c>Number(t.totalValorSupply))&&(await n.default.$transaction([n.default.user.update({where:{id:e},data:{valorBalance:{increment:c},surveyCompleted:!0,lastActiveAt:new Date}}),n.default.systemConfig.update({where:{id:"main"},data:{distributedValor:{increment:c},totalTransactions:{increment:1}}}),n.default.valorTransaction.create({data:{toUserId:e,amount:c,fee:0,netAmount:c,type:"survey_bonus",description:"Anket tamamlama bonusu - G\xf6r\xfcÅŸleriniz i\xe7in teÅŸekk\xfcrler!"}})]),!0)}async function V(e,a,t){if(await n.default.valorTransaction.findFirst({where:{swapRequestId:e,type:"swap_complete"}}))return console.warn(`[IDEMPOTENCY] Swap ${e} valor transferi zaten yapÄ±lmÄ±ÅŸ, atlanÄ±yor`),{success:!0,alreadyProcessed:!0,fee:0,netAmount:0,breakdown:{},isProductSwap:!1};let r=await n.default.swapRequest.findUnique({where:{id:e},include:{product:!0,requester:!0,owner:!0,offeredProduct:!0}});if(!r)return{success:!1,fee:0,netAmount:0,breakdown:{},isProductSwap:!1,error:"Takas talebi bulunamadÄ±"};if("accepted"!==r.status)return{success:!1,fee:0,netAmount:0,breakdown:{},isProductSwap:!1,error:"Takas hen\xfcz onaylanmamÄ±ÅŸ"};let i=!!r.offeredProductId,l=t||r.offeredProduct?.valorPrice||0;if(i&&l>0){let t=a-l,i=D(l),d=D(a),c=i.total,m=d.total,w=c+m,p=await o(r.ownerId),y=await o(r.requesterId),k=Math.min(.1,.05+l/5e4*.05),v=u&&p.swapBonusMax>0?Math.min(p.swapBonusMax,Math.max(p.swapBonusMin,Math.round(l*k))):Math.min(8,Math.max(3,Math.round(l*k))),b=Math.min(.1,.05+a/5e4*.05),h=u&&y.swapBonusMax>0?Math.min(y.swapBonusMax,Math.max(y.swapBonusMin,Math.round(a*b))):Math.min(8,Math.max(3,Math.round(a*b))),g=r.pendingValorAmount||0;try{if(await n.default.$transaction(async t=>{let n=await t.swapRequest.findUnique({where:{id:e},select:{id:!0,status:!0,version:!0}});if(!n||"accepted"!==n.status)throw Error("Takas durumu deÄŸiÅŸmiÅŸ, iÅŸlem iptal edildi");let s=await t.swapRequest.updateMany({where:{id:e,version:n.version},data:{status:"completed",version:{increment:1}}});if(0===s.count)throw Error("BaÅŸka bir iÅŸlem devam ediyor, l\xfctfen tekrar deneyin");await t.product.update({where:{id:r.productId},data:{status:"swapped"}}),await t.product.update({where:{id:r.offeredProductId},data:{status:"swapped"}}),await t.user.update({where:{id:r.ownerId},data:{valorBalance:{increment:l-c+v+g},lastActiveAt:new Date}}),await t.user.update({where:{id:r.requesterId},data:{valorBalance:{increment:a-m+h-g},lastActiveAt:new Date}}),await t.systemConfig.update({where:{id:"main"},data:{communityPoolValor:{increment:w},totalFeesCollected:{increment:w},totalSwapsCompleted:{increment:1},totalTransactions:{increment:6}}}),await t.valorTransaction.create({data:{fromUserId:r.requesterId,toUserId:r.ownerId,amount:l+g,fee:c,netAmount:l-c+g,type:"swap_complete",swapRequestId:e,feeBreakdown:JSON.stringify(i),description:`\xdcr\xfcn takasÄ± tamamlandÄ±: ${r.offeredProduct?.title||"Teklif \xfcr\xfcn\xfc"} alÄ±ndÄ±`}}),await t.valorTransaction.create({data:{fromUserId:r.ownerId,toUserId:r.requesterId,amount:a,fee:m,netAmount:a-m,type:"swap_complete",swapRequestId:e,feeBreakdown:JSON.stringify(d),description:`\xdcr\xfcn takasÄ± tamamlandÄ±: ${r.product.title} alÄ±ndÄ±`}}),await t.valorTransaction.create({data:{fromUserId:r.ownerId,toUserId:null,amount:c,fee:0,netAmount:c,type:"swap_fee",swapRequestId:e,description:`Topluluk katkÄ±sÄ± - Owner (%${i.effectiveRate})`}}),await t.valorTransaction.create({data:{fromUserId:r.requesterId,toUserId:null,amount:m,fee:0,netAmount:m,type:"swap_fee",swapRequestId:e,description:`Topluluk katkÄ±sÄ± - Requester (%${d.effectiveRate})`}}),await t.valorTransaction.create({data:{fromUserId:null,toUserId:r.ownerId,amount:v,fee:0,netAmount:v,type:"swap_bonus",swapRequestId:e,description:"\xdcr\xfcn takasÄ± bonusu (owner)"}}),await t.valorTransaction.create({data:{fromUserId:null,toUserId:r.requesterId,amount:h,fee:0,netAmount:h,type:"swap_bonus",swapRequestId:e,description:"\xdcr\xfcn takasÄ± bonusu (requester)"}})}),s(r.ownerId),s(r.requesterId),u)for(let e of[r.ownerId,r.requesterId]){let a=await o(e,!1),t=f.find(e=>e.swaps===a.swapCount);t&&!await n.default.valorTransaction.findFirst({where:{toUserId:e,type:"achievement_bonus",description:{contains:t.id}}})&&await n.default.$transaction([n.default.valorTransaction.create({data:{fromUserId:null,toUserId:e,amount:t.bonus,fee:0,netAmount:t.bonus,type:"achievement_bonus",description:`Milestone: ${t.id} - ${t.message}`}}),n.default.user.update({where:{id:e},data:{valorBalance:{increment:t.bonus}}})])}return{success:!0,fee:w,netAmount:0,breakdown:i,isProductSwap:!0,ownerReceives:{valor:l-c+v+g,product:!0,fee:c,bonus:v},requesterReceives:{valor:a-m+h-g,product:!0,fee:m,bonus:h},valorDifference:t}}catch(e){return console.error("\xdcr\xfcn takasÄ± tamamlama hatasÄ±:",e),{success:!1,fee:0,netAmount:0,breakdown:{},isProductSwap:!0,error:"\xdcr\xfcn takasÄ± tamamlanÄ±rken hata oluÅŸtu"}}}let d=D(a),c=d.total,m=a-c,w=await o(r.ownerId),p=Math.min(.1,.05+a/5e4*.05),y=u&&w.swapBonusMax>0?Math.min(w.swapBonusMax,Math.max(w.swapBonusMin,Math.round(a*p))):0;try{if(await n.default.$transaction(async t=>{let n=await t.swapRequest.findUnique({where:{id:e},select:{id:!0,status:!0,version:!0}});if(!n||"accepted"!==n.status)throw Error("Takas durumu deÄŸiÅŸmiÅŸ, iÅŸlem iptal edildi");let i=await t.swapRequest.updateMany({where:{id:e,version:n.version},data:{status:"completed",version:{increment:1}}});if(0===i.count)throw Error("BaÅŸka bir iÅŸlem devam ediyor, l\xfctfen tekrar deneyin");await t.product.update({where:{id:r.productId},data:{status:"swapped"}}),await t.user.update({where:{id:r.ownerId},data:{valorBalance:{increment:m+y},lastActiveAt:new Date}}),await t.user.update({where:{id:r.requesterId},data:{lastActiveAt:new Date}}),await t.systemConfig.update({where:{id:"main"},data:{communityPoolValor:{increment:c},totalFeesCollected:{increment:c},totalSwapsCompleted:{increment:1},totalTransactions:{increment:3}}}),await t.valorTransaction.create({data:{fromUserId:null,toUserId:r.ownerId,amount:a,fee:c,netAmount:m,type:"swap_complete",swapRequestId:e,feeBreakdown:JSON.stringify(d),description:`Takas tamamlandÄ±: ${r.product.title}`}}),await t.valorTransaction.create({data:{fromUserId:r.ownerId,toUserId:null,amount:c,fee:0,netAmount:c,type:"swap_fee",swapRequestId:e,feeBreakdown:JSON.stringify(d),description:`Topluluk katkÄ±sÄ± (%${d.effectiveRate})`}}),await t.valorTransaction.create({data:{fromUserId:null,toUserId:r.ownerId,amount:y,fee:0,netAmount:y,type:"swap_bonus",swapRequestId:e,description:"BaÅŸarÄ±lÄ± takas bonusu"}})}),s(r.ownerId),s(r.requesterId),u)for(let e of[r.ownerId,r.requesterId]){let a=await o(e,!1),t=f.find(e=>e.swaps===a.swapCount);t&&!await n.default.valorTransaction.findFirst({where:{toUserId:e,type:"achievement_bonus",description:{contains:t.id}}})&&await n.default.$transaction([n.default.valorTransaction.create({data:{fromUserId:null,toUserId:e,amount:t.bonus,fee:0,netAmount:t.bonus,type:"achievement_bonus",description:`Milestone: ${t.id} - ${t.message}`}}),n.default.user.update({where:{id:e},data:{valorBalance:{increment:t.bonus}}})])}return{success:!0,fee:c,netAmount:m+y,breakdown:d,isProductSwap:!1}}catch(e){return console.error("Takas tamamlama hatasÄ±:",e),{success:!1,fee:0,netAmount:0,breakdown:{},isProductSwap:!1,error:"Takas tamamlanÄ±rken hata oluÅŸtu"}}}async function M(e,a=20,t=0){return(await n.default.valorTransaction.findMany({where:{OR:[{fromUserId:e},{toUserId:e}]},include:{swapRequest:{include:{product:{select:{title:!0,images:!0}}}}},orderBy:{createdAt:"desc"},take:a,skip:t})).map(a=>({...a,isIncoming:a.toUserId===e,displayAmount:a.toUserId===e?a.netAmount:-a.amount}))}async function I(){let e=await x(),a=await n.default.user.count(),t=await n.default.user.count({where:{lastActiveAt:{gte:new Date(Date.now()-2592e6)}}});return{totalSupply:Number(e.totalValorSupply),distributed:Number(e.distributedValor),communityPool:Number(e.communityPoolValor),reserve:Number(e.reserveValor),remaining:Number(e.totalValorSupply)-Number(e.distributedValor),totalFeesCollected:Number(e.totalFeesCollected),totalSwapsCompleted:e.totalSwapsCompleted,totalTransactions:e.totalTransactions,totalMelted:Number(e.totalMeltedValor),totalUsers:a,activeUsers:t,distributionPercent:(Number(e.distributedValor)/Number(e.totalValorSupply)*100).toFixed(2)}}function T(e){let a=D(e),t=Math.min(.1,.05+e/5e4*.05),n=Math.min(8,Math.max(3,Math.round(e*t)));return{productValue:e,fee:a.total,feeBreakdown:a,netAfterFee:e-a.total,estimatedBonus:n,totalReceive:e-a.total+n,effectiveRate:a.effectiveRate}}async function S(e){let a=await n.default.user.findUnique({where:{id:e},select:{id:!0,lastDailyBonusAt:!0,loginStreak:!0,lastStreakDate:!0}});if(!a)return{success:!1,message:"KullanÄ±cÄ± bulunamadÄ±"};let t=await o(e),r=new Date,i=new Date(r.getFullYear(),r.getMonth(),r.getDate());if(a.lastDailyBonusAt){let e=new Date(a.lastDailyBonusAt),n=new Date(e.getFullYear(),e.getMonth(),e.getDate());if(i.getTime()===n.getTime())return{success:!1,message:"Bug\xfcn zaten bonus aldÄ±nÄ±z. YarÄ±n tekrar gelin!",streak:a.loginStreak||0,level:{level:t.level,name:t.name}}}let s=1;if(a.lastStreakDate){let e=new Date(a.lastStreakDate),t=new Date(i);t.setDate(t.getDate()-1);let n=new Date(e.getFullYear(),e.getMonth(),e.getDate());n.getTime()===t.getTime()?s=Math.min((a.loginStreak||0)+1,30):n.getTime()<t.getTime()&&(s=1)}let u=t.dailyBonus,l=0,d="";if(t.streakEnabled){for(let e of m)if(s===e.days){l=e.bonus,d=` ğŸ‰ ${e.days} g\xfcnl\xfck streak! +${e.bonus}V extra bonus!`;break}}let c=u+l,f=await g(e,c);if(0===f)return{success:!1,message:"Bu ay i\xe7in bonus tavanÄ±na ulaÅŸtÄ±nÄ±z. Gelecek ay tekrar gelin!",reason:"monthly_cap_reached",level:{level:t.level,name:t.name}};c=f;let w=await x();if(Number(w.distributedValor)+c>Number(w.totalValorSupply))return{success:!1,message:"Sistem bonusu ÅŸu an i\xe7in t\xfckenmiÅŸ durumda"};let p=t.streakEnabled&&m.find(e=>e.days>s)||null;return await n.default.$transaction([n.default.user.update({where:{id:e},data:{valorBalance:{increment:c},lastDailyBonusAt:r,loginStreak:s,lastStreakDate:i,totalValorEarned:{increment:c},lastActiveAt:r}}),n.default.systemConfig.update({where:{id:"main"},data:{distributedValor:{increment:c},totalTransactions:{increment:1}}}),n.default.valorTransaction.create({data:{toUserId:e,amount:c,fee:0,netAmount:c,type:"daily_bonus",description:l>0?`G\xfcnl\xfck bonus (Seviye ${t.level}: ${t.name}, ${s}. g\xfcn) + Streak \xf6d\xfcl\xfc!`:`G\xfcnl\xfck bonus (Seviye ${t.level}: ${t.name}, ${s}. g\xfcn)`}})]),{success:!0,message:`+${c} Valor kazandÄ±nÄ±z!${d}`,bonus:c,streak:s,nextMilestone:p?{days:p.days,bonus:p.bonus}:void 0,level:{level:t.level,name:t.name}}}async function q(e){let a=await n.default.user.findUnique({where:{id:e},select:{productBonusCount:!0,pendingProductBonus:!0}});return a?(a.productBonusCount||0)+(a.pendingProductBonus||0)>=5?{success:!0,message:"Maksimum bonus limitine ulaÅŸÄ±ldÄ±"}:(await n.default.user.update({where:{id:e},data:{pendingProductBonus:{increment:1}}}),{success:!0,message:"\xdcr\xfcn eklendi! Ä°lk takasÄ±nÄ±z tamamlandÄ±ÄŸÄ±nda 30 Valor bonus kazanacaksÄ±nÄ±z."}):{success:!1,message:"KullanÄ±cÄ± bulunamadÄ±"}}async function _(e){let a=await o(e);if(0===a.productBonus)return{success:!0,message:"\xdcr\xfcn bonusu Seviye 1'den itibaren aktif. Takas yaparak seviye atlayÄ±n!",reason:"level_too_low",bonus:0};let t=await n.default.user.findUnique({where:{id:e},select:{id:!0,productBonusCount:!0,pendingProductBonus:!0}});if(!t)return{success:!1,message:"KullanÄ±cÄ± bulunamadÄ±"};if(0>=(t.pendingProductBonus||0))return{success:!0,message:"Bekleyen \xfcr\xfcn bonusu yok"};if((t.productBonusCount||0)>=5)return await n.default.user.update({where:{id:e},data:{pendingProductBonus:0}}),{success:!0,message:"Maksimum \xfcr\xfcn bonusuna zaten ulaÅŸÄ±lmÄ±ÅŸ"};let r=a.productBonus;if(0===(r=await g(e,r)))return{success:!0,message:"AylÄ±k bonus tavanÄ±na ulaÅŸÄ±ldÄ±",reason:"monthly_cap_reached"};let i=await x();if(Number(i.distributedValor)+r>Number(i.totalValorSupply))return{success:!1,message:"Sistem bonusu ÅŸu an i\xe7in t\xfckenmiÅŸ durumda"};let s=(t.productBonusCount||0)+1,u=Math.max(0,(t.pendingProductBonus||0)-1);return await n.default.$transaction([n.default.user.update({where:{id:e},data:{valorBalance:{increment:r},productBonusCount:s,pendingProductBonus:u,totalValorEarned:{increment:r},lastActiveAt:new Date}}),n.default.systemConfig.update({where:{id:"main"},data:{distributedValor:{increment:r},totalTransactions:{increment:1}}}),n.default.valorTransaction.create({data:{toUserId:e,amount:r,fee:0,netAmount:r,type:"product_bonus",description:`Takas tamamlama bonusu! Seviye ${a.level} (${s}/5)`}})]),{success:!0,message:`ğŸ‰ Takas tamamlama bonusu! +${r} Valor (${s}/5)`,bonus:r}}async function U(e){let a=await o(e);if(0===a.reviewBonus)return{success:!0,message:"DeÄŸerlendirme bonusu Seviye 1'den itibaren aktif.",reason:"level_too_low",bonus:0};let t=await n.default.user.findUnique({where:{id:e}});if(!t)return{success:!1,message:"KullanÄ±cÄ± bulunamadÄ±"};if((t.reviewBonusCount||0)>=10)return{success:!1,message:`Bu ay maksimum 10 deÄŸerlendirme bonusuna ulaÅŸtÄ±nÄ±z`};let r=a.reviewBonus;if(0===(r=await g(e,r)))return{success:!0,message:"AylÄ±k bonus tavanÄ±na ulaÅŸÄ±ldÄ±",reason:"monthly_cap_reached"};let i=await x();if(Number(i.distributedValor)+r>Number(i.totalValorSupply))return{success:!1,message:"Sistem bonusu ÅŸu an i\xe7in t\xfckenmiÅŸ durumda"};let s=(t.reviewBonusCount||0)+1;return await n.default.$transaction([n.default.user.update({where:{id:e},data:{valorBalance:{increment:r},reviewBonusCount:s,totalValorEarned:{increment:r},lastActiveAt:new Date}}),n.default.systemConfig.update({where:{id:"main"},data:{distributedValor:{increment:r},totalTransactions:{increment:1}}}),n.default.valorTransaction.create({data:{toUserId:e,amount:r,fee:0,netAmount:r,type:"review_bonus",description:`DeÄŸerlendirme bonusu - Seviye ${a.level} (${s}/10 bu ay)`}})]),{success:!0,message:`DeÄŸerlendirme bonusu alÄ±ndÄ±! +${r}V`,bonus:r}}async function R(e){let a=await n.default.user.findUnique({where:{id:e},select:{lastReferralResetAt:!0,monthlyReferralCount:!0}});if(!a)return;let t=new Date,r=a.lastReferralResetAt?new Date(a.lastReferralResetAt):null;r&&r.getMonth()===t.getMonth()&&r.getFullYear()===t.getFullYear()||await n.default.user.update({where:{id:e},data:{monthlyReferralCount:0,lastReferralResetAt:t}})}async function z(e,a){let t=await o(e);if(0===t.referralBonus)return await n.default.referral.create({data:{referrerId:e,referredUserId:a,bonusGiven:!1,friendLoginCount:0,activeBonusGiven:!1}}),{success:!0,message:"Davet bonusu Seviye 1'den itibaren aktif. Takas yaparak seviye atlayÄ±n!",reason:"level_too_low",bonus:0};await R(e);let r=await n.default.user.findUnique({where:{id:e},select:{monthlyReferralCount:!0,valorBalance:!0}});if(!r)return{success:!1,message:"Davet eden kullanÄ±cÄ± bulunamadÄ±"};if(r.monthlyReferralCount>=p)return{success:!1,message:`Bu ay maksimum ${p} davet bonusuna ulaÅŸtÄ±nÄ±z.`};let i=t.referralBonus;if(0===(i=await g(e,i)))return await n.default.referral.create({data:{referrerId:e,referredUserId:a,bonusGiven:!1,friendLoginCount:0,activeBonusGiven:!1}}),{success:!0,message:"AylÄ±k bonus tavanÄ±na ulaÅŸÄ±ldÄ±",reason:"monthly_cap_reached"};let s=await x();if(Number(s.distributedValor)+i>Number(s.totalValorSupply))return{success:!1,message:"Sistem bonusu ÅŸu an i\xe7in t\xfckenmiÅŸ durumda"};let u=r.monthlyReferralCount+1;return await n.default.$transaction([n.default.user.update({where:{id:e},data:{valorBalance:{increment:i},totalValorEarned:{increment:i},totalReferrals:{increment:1},monthlyReferralCount:u,lastReferralAt:new Date,lastActiveAt:new Date}}),n.default.referral.create({data:{referrerId:e,referredUserId:a,bonusGiven:!0,friendLoginCount:0,activeBonusGiven:!1}}),n.default.systemConfig.update({where:{id:"main"},data:{distributedValor:{increment:i},totalTransactions:{increment:1}}}),n.default.valorTransaction.create({data:{toUserId:e,amount:i,fee:0,netAmount:i,type:"referral_bonus",description:`ArkadaÅŸ davet bonusu - Seviye ${t.level} (${u}/${p} bu ay)`}})]),{success:!0,message:`Davet bonusu alÄ±ndÄ±! +${i}V (${u}/${p} bu ay)`,bonus:i}}async function $(e){await R(e);let a=await n.default.user.findUnique({where:{id:e},select:{monthlyReferralCount:!0}}),t=new Date,r=new Date(t.getFullYear(),t.getMonth(),1),i=await n.default.referral.count({where:{referrerId:e,createdAt:{gte:r},activeBonusGiven:!1,friendLoginCount:{lt:y}}}),s=a?.monthlyReferralCount||0;return{monthlyCount:s,maxCount:p,canInvite:s<p,pendingActiveBonus:i}}let P=[{id:"first_swap",title:"Ä°lk Takas",description:"Ä°lk takasÄ±nÄ±zÄ± tamamlayÄ±n",reward:5,icon:"\uD83C\uDFAF",requirement:{type:"swaps",count:1}},{id:"swap_master_5",title:"Takas UstasÄ±",description:"5 takas tamamlayÄ±n",reward:10,icon:"\uD83C\uDFC6",requirement:{type:"swaps",count:5}},{id:"swap_legend_10",title:"Takas Efsanesi",description:"10 takas tamamlayÄ±n",reward:20,icon:"\uD83D\uDC51",requirement:{type:"swaps",count:10}},{id:"first_product",title:"SatÄ±cÄ±",description:"Ä°lk \xfcr\xfcn\xfcn\xfcz\xfc ekleyin",reward:3,icon:"\uD83D\uDCE6",requirement:{type:"products",count:1}},{id:"product_collector_5",title:"Koleksiyoncu",description:"5 \xfcr\xfcn ekleyin",reward:8,icon:"\uD83D\uDDC3ï¸",requirement:{type:"products",count:5}},{id:"first_review",title:"EleÅŸtirmen",description:"Ä°lk deÄŸerlendirmenizi yapÄ±n",reward:2,icon:"â­",requirement:{type:"reviews",count:1}},{id:"reviewer_5",title:"G\xfcvenilir DeÄŸerlendirici",description:"5 deÄŸerlendirme yapÄ±n",reward:5,icon:"\uD83C\uDF1F",requirement:{type:"reviews",count:5}},{id:"first_referral",title:"Davet\xe7i",description:"Ä°lk arkadaÅŸÄ±nÄ±zÄ± davet edin",reward:3,icon:"\uD83E\uDD1D",requirement:{type:"referrals",count:1}},{id:"referral_master_5",title:"Topluluk Lideri",description:"5 arkadaÅŸ davet edin",reward:8,icon:"\uD83D\uDC65",requirement:{type:"referrals",count:5}},{id:"phone_verified",title:"DoÄŸrulanmÄ±ÅŸ",description:"Telefon numaranÄ±zÄ± doÄŸrulayÄ±n",reward:5,icon:"\uD83D\uDCF1",requirement:{type:"verifications",condition:"phone"}},{id:"identity_verified",title:"G\xfcvenilir \xdcye",description:"KimliÄŸinizi doÄŸrulayÄ±n",reward:10,icon:"\uD83D\uDEE1ï¸",requirement:{type:"verifications",condition:"identity"}},{id:"survey_complete",title:"Anket\xf6r",description:"Anket formunu doldurun",reward:3,icon:"\uD83D\uDCCB",requirement:{type:"special",condition:"survey"}}];async function E(e){let a=await n.default.user.findUnique({where:{id:e},include:{products:{select:{id:!0}},swapRequestsSent:{where:{status:"completed"},select:{id:!0}},swapRequestsReceived:{where:{status:"completed"},select:{id:!0}},reviewsGiven:{select:{id:!0}},referrals:{select:{id:!0}}}});if(!a)return{completed:[],available:[],claimable:[]};let t=a.completedAchievements?JSON.parse(a.completedAchievements):[],r={swaps:a.swapRequestsSent.length+a.swapRequestsReceived.length,products:a.products.length,reviews:a.reviewsGiven.length,referrals:a.referrals.length,phoneVerified:a.isPhoneVerified,identityVerified:a.isIdentityVerified,surveyCompleted:a.surveyCompleted},i=[],s=[],u=[];for(let e of P){if(t.includes(e.id)){i.push(e);continue}let a=!1;switch(e.requirement.type){case"swaps":a=r.swaps>=(e.requirement.count||0);break;case"products":a=r.products>=(e.requirement.count||0);break;case"reviews":a=r.reviews>=(e.requirement.count||0);break;case"referrals":a=r.referrals>=(e.requirement.count||0);break;case"verifications":"phone"===e.requirement.condition?a=r.phoneVerified:"identity"===e.requirement.condition&&(a=r.identityVerified);break;case"special":"survey"===e.requirement.condition&&(a=r.surveyCompleted)}a?u.push(e):s.push(e)}return{completed:i,available:s,claimable:u}}async function N(e,a){let{claimable:t}=await E(e),r=t.find(e=>e.id===a);if(!r)return{success:!1,message:"Bu baÅŸarÄ± hen\xfcz kazanÄ±lmadÄ± veya zaten alÄ±ndÄ±"};let i=await n.default.user.findUnique({where:{id:e}});if(!i)return{success:!1,message:"KullanÄ±cÄ± bulunamadÄ±"};let s=i.completedAchievements?JSON.parse(i.completedAchievements):[];s.push(a);let u=await x(),o=Number(u.distributedValor),l=Number(u.totalValorSupply);return o+r.reward>l?{success:!1,message:"Sistem bonusu ÅŸu an i\xe7in t\xfckenmiÅŸ durumda"}:(await n.default.$transaction([n.default.user.update({where:{id:e},data:{valorBalance:{increment:r.reward},completedAchievements:JSON.stringify(s),totalValorEarned:{increment:r.reward},lastActiveAt:new Date}}),n.default.systemConfig.update({where:{id:"main"},data:{distributedValor:{increment:r.reward},totalTransactions:{increment:1}}}),n.default.valorTransaction.create({data:{toUserId:e,amount:r.reward,fee:0,netAmount:r.reward,type:"achievement_bonus",description:`BaÅŸarÄ± \xf6d\xfcl\xfc: ${r.title}`}})]),{success:!0,message:`${r.title} baÅŸarÄ±sÄ± tamamlandÄ±!`,bonus:r.reward})}async function F(e){let a=await n.default.user.findUnique({where:{id:e},select:{lastDailyBonusAt:!0,productBonusCount:!0,reviewBonusCount:!0,totalValorEarned:!0,surveyCompleted:!0,welcomeBonusGiven:!0}});if(!a)return null;let t=new Date,r=!0,i=0;if(a.lastDailyBonusAt){let e=(t.getTime()-new Date(a.lastDailyBonusAt).getTime())/36e5;e<24&&(r=!1,i=Math.ceil(24-e))}return{dailyBonus:{amount:1,canClaim:r,hoursUntilNext:i},productBonus:{amount:5,claimed:a.productBonusCount||0,max:5,remaining:5-(a.productBonusCount||0)},reviewBonus:{amount:2,claimed:a.reviewBonusCount||0,max:10},surveyBonus:{amount:c,claimed:a.surveyCompleted},welcomeBonus:{amount:d,claimed:a.welcomeBonusGiven},totalEarned:a.totalValorEarned||0}}async function G(e){let a=await n.default.user.findUnique({where:{id:e},select:{id:!0,email:!0,role:!0,createdAt:!0,isPhoneVerified:!0,isIdentityVerified:!0,products:{where:{status:"active"},select:{id:!0,valorPrice:!0}}}});if(!a)return{eligible:!1,reason:"KullanÄ±cÄ± bulunamadÄ±"};if("admin"===a.role||["join@takas-a.com"].includes(a.email||""))return{eligible:!0,details:{activeProductCount:a.products.length,qualifiedProductCount:a.products.length,minProductsRequired:0,minProductValor:0,accountAgeDays:999,isNewUser:!1,swapRequestCount:0,maxSwapRequestsForNewUser:999,isVerified:!0}};let t=Math.floor((new Date().getTime()-new Date(a.createdAt).getTime())/864e5),r=t<30,i=a.isPhoneVerified||a.isIdentityVerified,s=a.products.length,u=a.products.filter(e=>(e.valorPrice??0)>=60).length,o={activeProductCount:s,qualifiedProductCount:u,minProductsRequired:1,minProductValor:60,accountAgeDays:t,isNewUser:r,swapRequestCount:0,maxSwapRequestsForNewUser:3,isVerified:i};if(t<7&&!i)return{eligible:!1,reason:`Takas teklifi g\xf6nderebilmek i\xe7in hesabÄ±nÄ±zÄ±n en az 7 g\xfcnl\xfck olmasÄ± veya telefon/kimlik doÄŸrulamasÄ± yapÄ±lmasÄ± gerekiyor. Kalan s\xfcre: ${7-t} g\xfcn`,details:o};if(s<1)return{eligible:!1,reason:`Takas teklifi g\xf6nderebilmek i\xe7in en az 1 aktif \xfcr\xfcn eklemiÅŸ olmanÄ±z gerekiyor. \xd6nce bir \xfcr\xfcn ekleyin ve takas topluluÄŸuna katÄ±lÄ±n!`,details:o};if(u<1){let e=a.products.reduce((e,a)=>(a.valorPrice??0)>(e?.valorPrice??0)?a:e,a.products[0]),t=e?.valorPrice??0;return{eligible:!1,reason:`Takas teklifi g\xf6nderebilmek i\xe7in en az 60 Valor deÄŸerinde bir \xfcr\xfcn\xfcn\xfcz olmasÄ± gerekiyor. Mevcut en y\xfcksek \xfcr\xfcn deÄŸeriniz: ${t} Valor. Daha deÄŸerli bir \xfcr\xfcn ekleyin veya mevcut \xfcr\xfcn\xfcn\xfcz\xfc g\xfcncelleyin.`,details:o}}if(r){let a=new Date;a.setDate(a.getDate()-30);let r=await n.default.swapRequest.count({where:{requesterId:e,createdAt:{gte:a}}});if(o.swapRequestCount=r,r>=3)return{eligible:!1,reason:`Yeni kullanÄ±cÄ± olarak ilk 30 g\xfcn i\xe7inde en fazla 3 takas teklifi g\xf6nderebilirsiniz. HesabÄ±nÄ±z ${30-t} g\xfcn sonra bu limiti aÅŸacak.`,details:o}}return{eligible:!0,details:o}}async function O(){let e=await x(),a=new Date,t=e.lastWeeklyResetAt?new Date(e.lastWeeklyResetAt):null,r=a.getDay(),i=new Date(a);return i.setDate(a.getDate()-(0===r?6:r-1)),i.setHours(0,0,0,0),(!t||t<i)&&(await n.default.systemConfig.update({where:{id:"main"},data:{weeklyDistributedValor:BigInt(0),lastWeeklyResetAt:a}}),!0)}async function Y(){let e;await O();let a=await x(),t=Number(a.totalValorSupply),n=t-Number(a.distributedValor),r=Number(a.weeklyDistributedValor),i=4.33*r,s=52*r,u=s/t*100,o=r>0?n/(52*r):1/0,l="healthy";return u>15?(l="critical",e="YÄ±llÄ±k enflasyon %15'i aÅŸtÄ±! Bonus miktarlarÄ±nÄ± azaltmayÄ± veya doÄŸrulama ÅŸartlarÄ±nÄ± sÄ±kÄ±laÅŸtÄ±rmayÄ± d\xfcÅŸ\xfcn\xfcn."):u>10?(l="warning",e="YÄ±llÄ±k enflasyon %10'u aÅŸtÄ±. Bonus politikalarÄ±nÄ± g\xf6zden ge\xe7irin."):o<5&&(l="warning",e=`Mevcut hÄ±zla Valor arzÄ± ${o.toFixed(1)} yÄ±l i\xe7inde t\xfckenebilir.`),{weekly:{distributed:r,percentOfTotal:Math.round(r/t*1e5)/1e3,percentOfRemaining:Math.round(1e3*(n>0?r/n*100:100))/1e3},monthly:{estimated:Math.round(i),percentOfTotal:Math.round(i/t*1e4)/100},yearly:{estimated:Math.round(s),percentOfTotal:Math.round(100*u)/100,yearsUntilExhaustion:Math.round(10*o)/10},healthStatus:l,recommendation:e}}async function K(){let e=await x();return{welcomeBonusAmount:e.welcomeBonusAmount||d,dailyBonusBase:e.dailyBonusBase||1,productBonusAmount:e.productBonusAmount||5,referralBonusAmount:e.referralBonusAmount||k,reviewBonusAmount:e.reviewBonusAmount||2,minAccountAgeDays:e.minAccountAgeDays||7,requireVerification:e.requireVerification??!0}}async function L(e){try{return await n.default.systemConfig.update({where:{id:"main"},data:{...e,updatedAt:new Date}}),{success:!0,message:"Konfig\xfcrasyon g\xfcncellendi"}}catch(e){return console.error("Config g\xfcncelleme hatasÄ±:",e),{success:!1,message:"G\xfcncelleme baÅŸarÄ±sÄ±z oldu"}}}async function J(e){return await n.default.swapRequest.count({where:{OR:[{requesterId:e},{product:{userId:e}}],status:"completed"}})}async function j(e){let a=await n.default.valorTransaction.aggregate({where:{toUserId:e,type:{in:b}},_sum:{amount:!0}});return a._sum?.amount??0}async function W(e){let[a,t]=await Promise.all([J(e),j(e)]);if(a>0)return{totalBonus:t,usableBonus:t,lockedBonus:0,hasCompletedFirstSwap:!0};let n=Math.floor(50*t/100);return{totalBonus:t,usableBonus:n,lockedBonus:t-n,hasCompletedFirstSwap:!1}}async function H(e,a){let t=await J(e);if(t>=3)return{allowed:!0};let r=await n.default.valorTransaction.aggregate({where:{toUserId:e,type:"swap_complete"},_sum:{netAmount:!0}}),i=await n.default.valorTransaction.aggregate({where:{fromUserId:e,type:{in:["swap_fee","swap_complete"]}},_sum:{amount:!0}}),s=Math.max(0,(r._sum?.netAmount??0)-(i._sum?.amount??0)),u=400-s,o={completedSwaps:t,currentNetGain:s,proposedGain:a,maxAllowedGain:400,remainingAllowance:u};return s+a>400?{allowed:!1,reason:`Ä°lk 3 takasÄ±nÄ±zda toplam 400 Valor'dan fazla net kazan\xe7 elde edemezsiniz. Mevcut kazancÄ±nÄ±z: ${s}V, kalan hakkÄ±nÄ±z: ${Math.max(0,u)}V. Bu kural yeni kullanÄ±cÄ±larÄ±n sistemi tanÄ±masÄ± ve adil takas yapmasÄ± i\xe7in uygulanmaktadÄ±r.`,details:o}:{allowed:!0,details:o}}async function Q(e,a,t){let r=await n.default.user.findUnique({where:{id:e},select:{valorBalance:!0}});if(!r)return{canSwap:!1,reason:"KullanÄ±cÄ± bulunamadÄ±",usableBalance:0,lockedBonus:0,gainLimitOk:!1};let i=await W(e),s=Math.max(0,(r.valorBalance??0)-i.lockedBonus),u=await H(e,t);return s<a?{canSwap:!1,reason:i.lockedBonus>0?`Yeterli kullanÄ±labilir bakiyeniz yok. ${i.lockedBonus}V bonus'unuz ilk takasÄ±nÄ±zÄ± tamamlayana kadar kilitli. Mevcut kullanÄ±labilir bakiye: ${s}V, gereken: ${a}V, eksik: ${a-s}V`:`Yeterli Valor bakiyeniz yok. Mevcut: ${s}V, gereken: ${a}V`,usableBalance:s,lockedBonus:i.lockedBonus,gainLimitOk:u.allowed}:u.allowed?{canSwap:!0,usableBalance:s,lockedBonus:i.lockedBonus,gainLimitOk:!0}:{canSwap:!1,reason:u.reason,usableBalance:s,lockedBonus:i.lockedBonus,gainLimitOk:!1}}async function Z(e){let a=await n.default.product.findMany({where:{userId:e,status:"available"},select:{valorPrice:!0}}),t=a.reduce((e,a)=>Math.max(e,a.valorPrice??0),0),r=t>=60,i=Math.max(0,60-t),s="";return r||(s=0===a.length?"Takas yapabilmek i\xe7in \xf6nce en az 1 \xfcr\xfcn eklemeniz gerekiyor. \xdcr\xfcn deÄŸeri minimum 60 Valor olmalÄ±dÄ±r.":`Mevcut en deÄŸerli \xfcr\xfcn\xfcn\xfcz ${t} Valor. Takas yapabilmek i\xe7in en az 60 Valor deÄŸerinde bir \xfcr\xfcn eklemeniz gerekiyor. ${i} Valor daha deÄŸerli bir \xfcr\xfcn ekleyin veya mevcut \xfcr\xfcn\xfcn\xfcz\xfcn deÄŸerini g\xfcncelleyin.`),{hasQualifiedProduct:r,maxProductValue:t,minRequiredValue:60,shortfall:i,recommendation:s}}async function X(e){let[a,t,r,i]=await Promise.all([n.default.user.findUnique({where:{id:e},select:{valorBalance:!0}}),W(e),J(e),Z(e)]),s=a?.valorBalance??0,u=Math.max(0,s-t.lockedBonus),o=await n.default.valorTransaction.aggregate({where:{toUserId:e,type:"swap_complete"},_sum:{amount:!0}}),l=o._sum?.amount??0,d=r<3,c=d?Math.max(0,400-l):1/0;return{valorBalance:s,usableBalance:u,lockedBonus:t.lockedBonus,totalBonus:t.totalBonus,hasCompletedFirstSwap:t.hasCompletedFirstSwap,completedSwapCount:r,netGainFromSwaps:l,remainingGainAllowance:c===1/0?-1:c,isInFirstSwapsPeriod:d,productValueStatus:i}}}};