"use strict";(()=>{var e={};e.id=152,e.ids=[152],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},22882:(e,a,r)=>{r.r(a),r.d(a,{originalPathname:()=>b,patchFetch:()=>R,requestAsyncStorage:()=>w,routeModule:()=>k,serverHooks:()=>A,staticGenerationAsyncStorage:()=>v});var t={};r.r(t),r.d(t,{POST:()=>h,dynamic:()=>p,maxDuration:()=>x});var i=r(79182),n=r(72007),o=r(56719),s=r(93442),l=r(57978),u=r(11826),d=r(83178),c=r(28286),m=r(54413);let p="force-dynamic",x=120,y=new m.ZP({apiKey:process.env.ABACUSAI_API_KEY,baseURL:"https://routellm.abacus.ai/v1"});async function g(){let e=await (0,l.getServerSession)(u.L);if(!e?.user?.email)return null;let a=await d.default.user.findUnique({where:{email:e.user.email},select:{id:!0,role:!0}});return a&&"admin"===a.role?a:null}async function f(e,a){let r="TR"===a?`T\xfcrkiye piyasa uzmanısın. T\xfcrkiye 2025 fiyatlarını kullan. \xd6TV+KDV nedeniyle elektronik Avrupa'nın 1.5-2x, ara\xe7lar 2-3x pahalıdır. Avrupa fiyatlarını ASLA referans alma. SADECE JSON d\xf6nd\xfcr.`:`Avrupa piyasa uzmanısın. EUR fiyatı hesapla, 1 EUR = 37 TL ile \xe7evir. SADECE JSON d\xf6nd\xfcr.`,t=`Bu \xfcr\xfcn\xfcn g\xfcncel piyasa değerini TL olarak tahmin et.
\xdcr\xfcn: ${e.title}
A\xe7ıklama: ${(e.description||"").substring(0,200)}
Kategori: ${e.category?.name||"Genel"}
Durum: ${e.condition||"good"}
Şehir: ${e.city||"İzmir"}
JSON d\xf6nd\xfcr: {"estimatedTL": <sayı>}`;try{let e=await y.chat.completions.create({model:"gpt-4.1-mini",messages:[{role:"system",content:r},{role:"user",content:t}],max_tokens:200,temperature:.3}),a=(e.choices[0]?.message?.content||"{}").replace(/```json\n?/g,"").replace(/```\n?/g,"").trim(),i=JSON.parse(a);return Math.max(50,i.estimatedTL||5e3)}catch{return Math.max(5e3,50*(e.valorPrice||100))}}async function h(e){try{if(!await g())return s.NextResponse.json({error:"Admin erişimi gerekli"},{status:403});let{mode:a,categoryFilter:r,limit:t}=await e.json(),i={status:"active"};r&&"all"!==r&&(i.category={slug:r});let n=await d.default.product.findMany({where:i,select:{id:!0,title:!0,description:!0,valorPrice:!0,condition:!0,city:!0,checklistData:!0,category:{select:{name:!0,slug:!0}},user:{select:{name:!0}}},take:Math.min(t||50,200),orderBy:{createdAt:"desc"}}),o=[],l=0,u=0,m=0;for(let e of n)try{let r=(0,c.n8)(e.city||"İzmir"),t=await f(e,r),i={};try{i="string"==typeof e.checklistData?JSON.parse(e.checklistData):e.checklistData||{}}catch{i={}}let n=(0,c.pu)({estimatedTL:t,condition:e.condition||"good",city:e.city||"İzmir",categorySlug:e.category?.slug||"default",checklistData:i}),s=e.valorPrice||0,m=n.valorPrice,p=s>0?((m-s)/s*100).toFixed(1):"Yeni";l+=s,u+=m,o.push({id:e.id,title:e.title,category:e.category?.name,owner:e.user?.name,city:e.city,country:r,estimatedTL:t,oldValor:s,newValor:m,change:`${p}%`,formula:n.breakdown.formula}),"apply"===a&&await d.default.product.update({where:{id:e.id},data:{valorPrice:m,aiValorPrice:m,aiValorReason:`Yeniden değerleme (${r}): ${n.breakdown.formula}`}}),await new Promise(e=>setTimeout(e,500))}catch(a){m++,o.push({id:e.id,title:e.title,error:a.message?.substring(0,100)})}return s.NextResponse.json({mode:a,totalProducts:n.length,processed:o.length,errors:m,totalOldValor:l,totalNewValor:u,totalChange:l>0?`${((u-l)/l*100).toFixed(1)}%`:"N/A",results:o})}catch(e){return console.error("Revalue error:",e),s.NextResponse.json({error:e.message||"Hata"},{status:500})}}let k=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/revalue/route",pathname:"/api/admin/revalue",filename:"route",bundlePath:"app/api/admin/revalue/route"},resolvedPagePath:"/home/ubuntu/takas-a-kodlar/nextjs_space/app/api/admin/revalue/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:w,staticGenerationAsyncStorage:v,serverHooks:A}=k,b="/api/admin/revalue/route";function R(){return(0,o.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:v})}},11826:(e,a,r)=>{r.d(a,{L:()=>u});var t=r(66291),i=r(64617),n=r(3390),o=r.n(n),s=r(83178),l=r(59521);let u={adapter:(0,i.N)(s.default),providers:[(0,t.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e,a){if(!e?.email||!e?.password)return null;let r=a?.headers?.["x-real-ip"],t=a?.headers?.["x-forwarded-for"],i=r?Array.isArray(r)?r[0]:r:t&&(Array.isArray(t)?t[0]:t).split(",").pop()?.trim()||"unknown",n=a?.headers?.["user-agent"]||"unknown";if(!(await (0,l.d5)(i,e.email)).allowed)throw await (0,l.Ky)(e.email,i,5,void 0),Error("ACCOUNT_LOCKED");let u=await s.default.user.findUnique({where:{email:e.email}});return u?await o().compare(e.password,u.password)?(await (0,l.LW)(i,u.id,u.email,n),await s.default.user.update({where:{id:u.id},data:{lastLoginAt:new Date}}),{id:u.id,email:u.email,name:u.name,role:u.role}):(await (0,l.Vm)(i,e.email,n,"Invalid password"),null):(await (0,l.Vm)(i,e.email,n,"User not found"),null)}})],session:{strategy:"jwt",maxAge:86400,updateAge:300},jwt:{maxAge:86400},callbacks:{jwt:async({token:e,user:a})=>(a&&(e.id=a.id,e.role=a.role),e),session:async({session:e,token:a})=>(e?.user&&(e.user.id=a?.id,e.user.role=a?.role),e)},pages:{signIn:"/giris"},secret:process.env.NEXTAUTH_SECRET,cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}}}},28286:(e,a,r)=>{r.d(a,{n8:()=>u,pu:()=>d});let t={inflationMultiplier:1.025,baseValorRate:.14,displayRate:50},i={new:1,likeNew:.85,good:.7,fair:.5,poor:.3},n={İstanbul:1.15,Istanbul:1.15,İzmir:1,Izmir:1,Ankara:1.05,Antalya:1.02,Bursa:.95,Konya:.88,Adana:.9,Gaziantep:.85,Barcelona:1.1,Madrid:1.08,London:1.2,Berlin:1.08,Paris:1.18,Amsterdam:1.12,Roma:1.05,Rome:1.05,Milano:1.12,Milan:1.12,Lizbon:.95,Lisbon:.95,default:1},o={elektronik:1.15,giyim:.9,"ev-yasam":1,"spor-outdoor":1.05,kitaplar:.75,oyuncaklar:.85,"oto-yedek-parca":1.1,otomobil:1.2,gayrimenkul:1.25,"bebek-cocuk":.95,"taki-aksesuar":1.1,mutfak:.95,bahce:.9,"beyaz-esya":1,"evcil-hayvan":.85,default:1},s={"0-50.000 km":1,"50.000-100.000 km":.9,"100.000-150.000 km":.8,"150.000-200.000 km":.7,"200.000+ km":.6},l={"2024-2025":1,"2022-2023":.85,"2020-2021":.75,"2018-2019":.65,"2015-2017":.55,"2012-2014":.45,"2010-2011":.38,"2010 \xf6ncesi":.3};function u(e){return["İstanbul","Istanbul","İzmir","Izmir","Ankara","Antalya","Bursa","Konya","Adana","Gaziantep","Mersin","Kayseri","Eskişehir","Trabzon","Samsun","Denizli","Diyarbakır","Muğla","Manisa","Balıkesir"].some(a=>e.includes(a))?"TR":["Barcelona","Madrid","Valencia","Sevilla","Malaga","Bilbao","Zaragoza"].some(a=>e.includes(a))?"ES":["London","Manchester","Birmingham","Edinburgh","Glasgow","Liverpool","Bristol"].some(a=>e.includes(a))?"UK":["Berlin","M\xfcnchen","Munich","Hamburg","Frankfurt","K\xf6ln","Cologne","Stuttgart","D\xfcsseldorf"].some(a=>e.includes(a))?"DE":["Paris","Lyon","Marseille","Toulouse","Nice","Bordeaux","Lille"].some(a=>e.includes(a))?"FR":["Roma","Rome","Milano","Milan","Napoli","Torino","Firenze","Bologna"].some(a=>e.includes(a))?"IT":["Lizbon","Lisbon","Porto","Faro"].some(a=>e.includes(a))?"PT":["Amsterdam","Rotterdam","Utrecht","Den Haag"].some(a=>e.includes(a))?"NL":"TR"}function d(e){let{estimatedTL:a,condition:r,city:u,categorySlug:d,checklistData:c}=e,m=i[r]||.7,p=o[d]||1,x=n[u]||n.default,y=t.inflationMultiplier,g=t.baseValorRate*y,f=1;c?.mileage&&s[c.mileage]&&(f*=s[c.mileage]),c?.modelYear&&l[c.modelYear]&&(f*=l[c.modelYear]),c?.hasAccidentRecord===!0&&(f*=.8);let h=Math.max(10,10*Math.round(a*g*m*p*x*f/10));return{valorPrice:h,breakdown:{estimatedTL:a,baseRate:g,conditionMultiplier:m,demandMultiplier:p,regionMultiplier:x,inflationMultiplier:y,simpleFormula:`${a.toLocaleString("tr-TR")}₺ \xf7 ${t.displayRate} ≈ ${Math.round(a/t.displayRate).toLocaleString("tr-TR")} V`,formula:`${a.toLocaleString("tr-TR")}₺ \xd7 ${g.toFixed(4)} kur \xd7 ${m} durum \xd7 ${p} talep \xd7 ${x} b\xf6lge${1!==f?` \xd7 ${f.toFixed(2)} ara\xe7`:""} = ${h.toLocaleString("tr-TR")} V`}}}}};var a=require("../../../../webpack-runtime.js");a.C(e);var r=e=>a(a.s=e),t=a.X(0,[8412,7609,3390,1472,4413,9521],()=>r(22882));module.exports=t})();