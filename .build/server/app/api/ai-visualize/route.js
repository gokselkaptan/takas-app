"use strict";(()=>{var e={};e.id=8478,e.ids=[8478],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},60677:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>w,patchFetch:()=>x,requestAsyncStorage:()=>h,routeModule:()=>g,serverHooks:()=>y,staticGenerationAsyncStorage:()=>f});var r={};a.r(r),a.d(r,{GET:()=>m,POST:()=>p,dynamic:()=>c});var i=a(79182),s=a(72007),n=a(56719),o=a(93442),l=a(57978),u=a(11826),d=a(83178);let c="force-dynamic";async function p(e){try{let t=await (0,l.getServerSession)(u.L);if(!t?.user?.email)return o.NextResponse.json({error:"Oturum a\xe7manız gerekiyor"},{status:401});let a=await d.default.user.findUnique({where:{email:t.user.email},select:{id:!0,role:!0,aiVisualizationCredits:!0,aiCreditsResetAt:!0}});if(!a)return o.NextResponse.json({error:"Kullanıcı bulunamadı"},{status:404});let r=new Date,i=r.getMonth(),s=r.getFullYear(),n=a.aiCreditsResetAt?new Date(a.aiCreditsResetAt):null;n&&n.getMonth()===i&&n.getFullYear()===s||"admin"===a.role||(await d.default.user.update({where:{id:a.id},data:{aiVisualizationCredits:3,aiCreditsResetAt:r}}),a={...a,aiVisualizationCredits:3,aiCreditsResetAt:r});let c="admin"===a.role;if(!c&&a.aiVisualizationCredits<=0){let e=new Date(s,i+1,1),t=Math.ceil((e.getTime()-r.getTime())/864e5);return o.NextResponse.json({error:"Bu ay i\xe7in g\xf6rselleştirme hakkınız kalmadı",remainingCredits:0,daysUntilReset:t,message:`\xdccretsiz haklarınız ${t} g\xfcn sonra yenilenecek!`},{status:403})}let p=await e.formData(),m=p.get("environmentImage"),g=p.get("productImage"),h=p.get("productTitle"),f=p.get("category"),y=p.get("roomDescription");if(!m&&!y)return o.NextResponse.json({error:"Ortam fotoğrafı veya oda a\xe7ıklaması gerekli"},{status:400});if(!g||!h)return o.NextResponse.json({error:"\xdcr\xfcn g\xf6rseli ve başlığı gerekli"},{status:400});let w="";if(m){let e=await m.arrayBuffer();w=Buffer.from(e).toString("base64")}let x={mobilya:"furniture piece placed naturally in the room, realistic lighting and shadows",elektronik:"electronic device on a desk or table, realistic reflections and ambient lighting",giyim:"clothing item being worn by a person or displayed on a mannequin",aksesuar:"accessory being worn or displayed elegantly",spor:"sports equipment in an appropriate setting",default:"item placed naturally in the environment with realistic lighting"},A=x[f]||x.default;!g.startsWith("http")&&!g.startsWith("data:")&&g.startsWith("/")&&process.env.NEXTAUTH_URL;let k=y||"modern living room";if(w)try{let e=m.type||"image/jpeg",t=await fetch("https://routellm.abacus.ai/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${process.env.ABACUSAI_API_KEY}`},body:JSON.stringify({model:"gpt-4.1-mini",messages:[{role:"user",content:[{type:"text",text:`Analyze this room/interior photo and provide a detailed description for an AI image generator. Include:
- Room type (living room, bedroom, kitchen, etc.)
- Wall colors and textures
- Floor type (hardwood, carpet, tile, etc.)
- Lighting conditions (natural light, warm, cool, etc.)
- Existing furniture and decor style
- Overall aesthetic (modern, traditional, minimalist, etc.)
- Any distinctive features

Provide the description in a single paragraph, focusing on visual details that would help recreate this exact room style. Be specific and detailed.`},{type:"image_url",image_url:{url:`data:${e};base64,${w}`}}]}],max_tokens:500})});if(t.ok){let e=await t.json(),a=e.choices?.[0]?.message?.content;a&&"string"==typeof a&&(k=a,console.log("Room analysis:",k))}}catch(e){console.error("Room analysis failed, using default description:",e)}let v=h.toUpperCase(),C=`MAIN SUBJECT: A ${v} - this ${h} MUST be clearly visible and prominent in the center-front of the image.

ROOM CONTEXT: ${k}

IMPORTANT REQUIREMENTS:
1. The ${h} must be the FOCAL POINT of the image
2. The ${h} should be placed on a visible surface (table, counter, shelf) in the foreground
3. Show the ${h} at a natural size, clearly visible and recognizable
4. ${A}

STYLE: Photorealistic interior design photography, professional lighting, magazine-quality, 4K detail, the ${h} perfectly integrated into the space.`,b=await fetch("https://routellm.abacus.ai/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${process.env.ABACUSAI_API_KEY}`},body:JSON.stringify({model:"flux-2-pro",messages:[{role:"user",content:C}],modalities:["image"]})});if(!b.ok){let e=await b.text();return console.error("AI API error:",e),o.NextResponse.json({error:"G\xf6rselleştirme oluşturulamadı, l\xfctfen tekrar deneyin"},{status:500})}let z=await b.json();console.log("AI API response:",JSON.stringify(z,null,2));let R="";if(z.choices?.[0]?.message?.images){let e=z.choices[0].message.images;if(Array.isArray(e)&&e.length>0){let t=e.find(e=>"image_url"===e.type);t?.image_url?.url&&(R=t.image_url.url)}}else if(z.choices?.[0]?.message?.content){let e=z.choices[0].message.content;if(Array.isArray(e)){let t=e.find(e=>"image_url"===e.type);t?.image_url?.url&&(R=t.image_url.url)}else if("string"==typeof e){let t=e.match(/https:\/\/cdn\.abacus\.ai\/[^\s"'\]>]+/i);t&&(R=t[0])}}else z.data?.[0]?.url?R=z.data[0].url:z.data?.[0]?.b64_json?R=`data:image/png;base64,${z.data[0].b64_json}`:z.url?R=z.url:z.image_url&&(R=z.image_url);if(!R)return console.error("No image URL in response:",JSON.stringify(z,null,2)),o.NextResponse.json({error:"G\xf6rsel oluşturulamadı, l\xfctfen farklı bir a\xe7ıklama deneyin"},{status:500});c||await d.default.user.update({where:{id:a.id},data:{aiVisualizationCredits:{decrement:1}}});let T=c?999:a.aiVisualizationCredits-1;return o.NextResponse.json({success:!0,imageUrl:R,remainingCredits:T,isAdmin:c,message:T>0?`Kalan hakkınız: ${T}`:"Bu son \xfccretsiz hakkınızdı! Yakında TL ile satın alma se\xe7eneği eklenecek."})}catch(e){return console.error("AI visualization error:",e),o.NextResponse.json({error:"Bir hata oluştu, l\xfctfen tekrar deneyin"},{status:500})}}async function m(e){try{let e=await (0,l.getServerSession)(u.L);if(!e?.user?.email)return o.NextResponse.json({error:"Oturum a\xe7manız gerekiyor"},{status:401});let t=await d.default.user.findUnique({where:{email:e.user.email},select:{id:!0,role:!0,aiVisualizationCredits:!0,aiCreditsResetAt:!0}});if(!t)return o.NextResponse.json({error:"Kullanıcı bulunamadı"},{status:404});let a="admin"===t.role,r=new Date,i=r.getMonth(),s=r.getFullYear(),n=t.aiCreditsResetAt?new Date(t.aiCreditsResetAt):null;n&&n.getMonth()===i&&n.getFullYear()===s||a||(await d.default.user.update({where:{id:t.id},data:{aiVisualizationCredits:3,aiCreditsResetAt:r}}),t={...t,aiVisualizationCredits:3,aiCreditsResetAt:r});let c=new Date(s,i+1,1),p=Math.ceil((c.getTime()-r.getTime())/864e5),m=a?999:t.aiVisualizationCredits;return o.NextResponse.json({remainingCredits:m,monthlyLimit:3,daysUntilReset:a?null:p,isAdmin:a,pricePerCredit:49.99,message:a?"Admin olarak sınırsız kullanım hakkınız var!":m>0?`Bu ay ${m}/3 \xfccretsiz hakkınız kaldı`:`Haklarınız ${p} g\xfcn sonra yenilenecek`})}catch(e){return console.error("Credit check error:",e),o.NextResponse.json({error:"Bir hata oluştu"},{status:500})}}let g=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/ai-visualize/route",pathname:"/api/ai-visualize",filename:"route",bundlePath:"app/api/ai-visualize/route"},resolvedPagePath:"/home/ubuntu/takas-a-kodlar/nextjs_space/app/api/ai-visualize/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:h,staticGenerationAsyncStorage:f,serverHooks:y}=g,w="/api/ai-visualize/route";function x(){return(0,n.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:f})}},11826:(e,t,a)=>{a.d(t,{L:()=>u});var r=a(66291),i=a(64617),s=a(3390),n=a.n(s),o=a(83178),l=a(59521);let u={adapter:(0,i.N)(o.default),providers:[(0,r.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e,t){if(!e?.email||!e?.password)return null;let a=t?.headers?.["x-real-ip"],r=t?.headers?.["x-forwarded-for"],i=a?Array.isArray(a)?a[0]:a:r&&(Array.isArray(r)?r[0]:r).split(",").pop()?.trim()||"unknown",s=t?.headers?.["user-agent"]||"unknown";if(!(await (0,l.d5)(i,e.email)).allowed)throw await (0,l.Ky)(e.email,i,5,void 0),Error("ACCOUNT_LOCKED");let u=await o.default.user.findUnique({where:{email:e.email}});return u?await n().compare(e.password,u.password)?(await (0,l.LW)(i,u.id,u.email,s),await o.default.user.update({where:{id:u.id},data:{lastLoginAt:new Date}}),{id:u.id,email:u.email,name:u.name,role:u.role}):(await (0,l.Vm)(i,e.email,s,"Invalid password"),null):(await (0,l.Vm)(i,e.email,s,"User not found"),null)}})],session:{strategy:"jwt",maxAge:86400,updateAge:300},jwt:{maxAge:86400},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.role=t.role),e),session:async({session:e,token:t})=>(e?.user&&(e.user.id=t?.id,e.user.role=t?.role),e)},pages:{signIn:"/giris"},secret:process.env.NEXTAUTH_SECRET,cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}}}}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8412,7609,3390,1472,9521],()=>a(60677));module.exports=r})();