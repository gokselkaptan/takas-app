"use strict";(()=>{var e={};e.id=539,e.ids=[539],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},73806:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>v,patchFetch:()=>R,requestAsyncStorage:()=>h,routeModule:()=>w,serverHooks:()=>y,staticGenerationAsyncStorage:()=>g});var a={};t.r(a),t.d(a,{GET:()=>f,POST:()=>x,dynamic:()=>m});var s=t(79182),n=t(72007),i=t(56719),l=t(93442),o=t(57978),u=t(83178),d=t(11826),p=t(53184);let m="force-dynamic";function c(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",r="";for(let t=0;t<8;t++)r+=e.charAt(Math.floor(Math.random()*e.length));return r}async function f(){try{let e=await (0,o.getServerSession)(d.L);if(!e?.user?.email)return l.NextResponse.json({error:"Giriş yapmalısınız"},{status:401});let r=await u.default.user.findUnique({where:{email:e.user.email},select:{id:!0,referralCode:!0,totalReferrals:!0,monthlyReferralCount:!0,lastReferralAt:!0,valorBalance:!0}});if(!r)return l.NextResponse.json({error:"Kullanıcı bulunamadı"},{status:404});let t=r.referralCode;t||(t=c(),await u.default.user.update({where:{email:e.user.email},data:{referralCode:t}}));let a=await (0,p.ER)(r.id),s=new Date,n=r.lastReferralAt?new Date(r.lastReferralAt):null,i=!0,m=0;if(n){let e=(s.getTime()-n.getTime())/36e5;e<24&&(i=!1,m=Math.ceil(24-e))}let f=new Date(s.getFullYear(),s.getMonth(),1),x=await u.default.referral.findMany({where:{referrerId:r.id,createdAt:{gte:f},activeBonusGiven:!1},include:{referredUser:{select:{name:!0,email:!0}}}});return l.NextResponse.json({referralCode:t,totalReferrals:r.totalReferrals,valorBalance:r.valorBalance,monthlyCount:a.monthlyCount,maxMonthlyCount:p._P,canInvite:a.canInvite&&i,hoursUntilNextInvite:m,referralBonus:p.R2,activeBonusAmount:p.rS,loginThreshold:p.Wm,pendingActiveBonus:a.pendingActiveBonus,pendingReferrals:x.map(e=>({friendName:e.referredUser.name,loginCount:e.friendLoginCount,threshold:p.Wm,createdAt:e.createdAt}))})}catch(e){return console.error("Referral fetch error:",e),l.NextResponse.json({error:"Davet bilgileri y\xfcklenemedi"},{status:500})}}async function x(e){try{let r=await e.json(),{action:t,email:a,referralCode:s}=r;if("validate"===t){if(!s)return l.NextResponse.json({valid:!1});let e=await u.default.user.findUnique({where:{referralCode:s},select:{id:!0,name:!0}});return l.NextResponse.json({valid:!!e,referrerName:e?.name})}if("complete"===t){let{referrerId:e,referredUserId:t}=r;if(!e||!t)return l.NextResponse.json({error:"Eksik bilgi"},{status:400});let a=await (0,p.cE)(e,t);return l.NextResponse.json(a)}let n=await (0,o.getServerSession)(d.L);if(!n?.user?.email)return l.NextResponse.json({error:"Giriş yapmalısınız"},{status:401});let i=await u.default.user.findUnique({where:{email:n.user.email}});if(!i)return l.NextResponse.json({error:"Kullanıcı bulunamadı"},{status:404});let m=await (0,p.ER)(i.id);if(!m.canInvite)return l.NextResponse.json({error:`Bu ay maksimum ${p._P} davet hakkınızı kullandınız. Yeni ay başında tekrar davet edebilirsiniz.`},{status:429});let f=new Date;if(i.lastReferralAt){let e=(f.getTime()-new Date(i.lastReferralAt).getTime())/36e5;if(e<24)return l.NextResponse.json({error:`G\xfcnl\xfck davet limitinize ulaştınız. ${Math.ceil(24-e)} saat sonra tekrar deneyebilirsiniz.`},{status:429})}if(!a)return l.NextResponse.json({error:"Email adresi gerekli"},{status:400});if(await u.default.user.findUnique({where:{email:a}}))return l.NextResponse.json({error:"Bu email adresi zaten kayıtlı"},{status:400});let x=i.referralCode;x||(x=c()),await u.default.user.update({where:{id:i.id},data:{referralCode:x,lastReferralAt:f}});let w=`https://takas-a.com/kayit?ref=${x}`;return l.NextResponse.json({success:!0,message:`Davet başarıyla g\xf6nderildi! (${m.monthlyCount+1}/${p._P} bu ay)`,referralLink:w,remainingInvites:p._P-m.monthlyCount-1})}catch(e){return console.error("Referral send error:",e),l.NextResponse.json({error:"Davet g\xf6nderilemedi"},{status:500})}}let w=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/referral/route",pathname:"/api/referral",filename:"route",bundlePath:"app/api/referral/route"},resolvedPagePath:"/home/ubuntu/takas-a-kodlar/nextjs_space/app/api/referral/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:h,staticGenerationAsyncStorage:g,serverHooks:y}=w,v="/api/referral/route";function R(){return(0,i.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:g})}},11826:(e,r,t)=>{t.d(r,{L:()=>u});var a=t(66291),s=t(64617),n=t(3390),i=t.n(n),l=t(83178),o=t(59521);let u={adapter:(0,s.N)(l.default),providers:[(0,a.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e,r){if(!e?.email||!e?.password)return null;let t=r?.headers?.["x-real-ip"],a=r?.headers?.["x-forwarded-for"],s=t?Array.isArray(t)?t[0]:t:a&&(Array.isArray(a)?a[0]:a).split(",").pop()?.trim()||"unknown",n=r?.headers?.["user-agent"]||"unknown";if(!(await (0,o.d5)(s,e.email)).allowed)throw await (0,o.Ky)(e.email,s,5,void 0),Error("ACCOUNT_LOCKED");let u=await l.default.user.findUnique({where:{email:e.email}});return u?await i().compare(e.password,u.password)?(await (0,o.LW)(s,u.id,u.email,n),await l.default.user.update({where:{id:u.id},data:{lastLoginAt:new Date}}),{id:u.id,email:u.email,name:u.name,role:u.role}):(await (0,o.Vm)(s,e.email,n,"Invalid password"),null):(await (0,o.Vm)(s,e.email,n,"User not found"),null)}})],session:{strategy:"jwt",maxAge:86400,updateAge:300},jwt:{maxAge:86400},callbacks:{jwt:async({token:e,user:r})=>(r&&(e.id=r.id,e.role=r.role),e),session:async({session:e,token:r})=>(e?.user&&(e.user.id=r?.id,e.user.role=r?.role),e)},pages:{signIn:"/giris"},secret:process.env.NEXTAUTH_SECRET,cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}}}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[8412,7609,3390,1472,9521,3184],()=>t(73806));module.exports=a})();