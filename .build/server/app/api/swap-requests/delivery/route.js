"use strict";(()=>{var e={};e.id=2910,e.ids=[2910],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},12399:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>S,patchFetch:()=>j,requestAsyncStorage:()=>k,routeModule:()=>q,serverHooks:()=>A,staticGenerationAsyncStorage:()=>I});var a={};t.r(a),t.d(a,{GET:()=>R,POST:()=>h,dynamic:()=>x});var i=t(79182),s=t(72007),n=t(56719),o=t(93442),l=t(57978),d=t(83178),u=t(11826);let p=require("node:crypto"),c={randomUUID:p.randomUUID},m=new Uint8Array(256),y=m.length,f=[];for(let e=0;e<256;++e)f.push((e+256).toString(16).slice(1));var w=t(59628);let x="force-dynamic";function v(){var e,r;let t=Date.now().toString(36),a=(c.randomUUID?c.randomUUID():function(e,r,t){let a=(e=e||{}).random??e.rng?.()??(y>m.length-16&&((0,p.randomFillSync)(m),y=0),m.slice(y,y+=16));if(a.length<16)throw Error("Random bytes length must be >= 16");if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,r){if((t=t||0)<0||t+16>r.length)throw RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let e=0;e<16;++e)r[t+e]=a[e];return r}return function(e,r=0){return(f[e[r+0]]+f[e[r+1]]+f[e[r+2]]+f[e[r+3]]+"-"+f[e[r+4]]+f[e[r+5]]+"-"+f[e[r+6]]+f[e[r+7]]+"-"+f[e[r+8]]+f[e[r+9]]+"-"+f[e[r+10]]+f[e[r+11]]+f[e[r+12]]+f[e[r+13]]+f[e[r+14]]+f[e[r+15]]).toLowerCase()}(a)}(e,r,void 0)).replace(/-/g,"").substring(0,8);return`TAKAS-${t}-${a}`.toUpperCase()}function g(){return Math.floor(1e5+9e5*Math.random()).toString()}async function h(e){try{let r=await (0,l.getServerSession)(u.L);if(!r?.user?.email)return o.NextResponse.json({error:"Oturum a\xe7manÄ±z gerekiyor"},{status:401});let t=await d.default.user.findUnique({where:{email:r.user.email},select:{id:!0,name:!0}});if(!t)return o.NextResponse.json({error:"KullanÄ±cÄ± bulunamadÄ±"},{status:401});let{swapRequestId:a,action:i="propose",deliveryMethod:s,deliveryPointId:n,customLocation:p,senderPhotos:c,deliveryDate:m,deliveryTime:y}=await e.json();if(!a)return o.NextResponse.json({error:"Takas ID gerekli"},{status:400});let f=await d.default.swapRequest.findUnique({where:{id:a},include:{product:{select:{id:!0,title:!0}},offeredProduct:{select:{id:!0,title:!0}},owner:{select:{id:!0,name:!0,email:!0}},requester:{select:{id:!0,name:!0,email:!0}}}});if(!f)return o.NextResponse.json({error:"Takas isteÄŸi bulunamadÄ±"},{status:404});let x=f.ownerId===t.id,h=f.requesterId===t.id;if(!x&&!h)return o.NextResponse.json({error:"Bu takasa eriÅŸim yetkiniz yok"},{status:403});let R=await d.default.swapStatusLog.findFirst({where:{swapRequestId:a,reason:{startsWith:"DELIVERY_PROPOSAL|"}},orderBy:{createdAt:"desc"}}),q=null;if(R?.reason)try{let e=R.reason.replace("DELIVERY_PROPOSAL|","");q=JSON.parse(e)}catch(e){q=null}if("accept"===i){if(!q)return o.NextResponse.json({error:"Kabul edilecek teslimat \xf6nerisi bulunamadÄ±"},{status:400});if(q.proposedBy===t.id)return o.NextResponse.json({error:"Kendi \xf6nerinizi kabul edemezsiniz"},{status:400});let e=v(),r=g(),i=null,s=null;f.offeredProductId&&(i=v(),s=g());let n=null;if("delivery_point"===q.deliveryMethod&&q.deliveryPointId){let e=await d.default.deliveryPoint.findUnique({where:{id:q.deliveryPointId}});n=e?.name||null}let l=await d.default.swapRequest.update({where:{id:a},data:{qrCode:e,qrCodeGeneratedAt:new Date,qrCodeB:i,deliveryMethod:q.deliveryMethod,deliveryPointId:q.deliveryPointId||null,customLocation:q.customLocation||null,status:"qr_generated",deliveryVerificationCode:r,deliveryVerificationCodeB:s}});await d.default.swapStatusLog.create({data:{swapRequestId:a,fromStatus:f.status,toStatus:"qr_generated",changedBy:t.id,reason:`DELIVERY_ACCEPTED|${JSON.stringify({acceptedBy:t.id,acceptedAt:new Date().toISOString()})}`}});let u=`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(e)}`,p=n||q.customLocation||"Belirtilmedi",c=q.deliveryDate||"Belirtilmedi",m=q.deliveryTime||"Belirtilmedi",y=`ðŸ¤ TESLÄ°MAT ANLAÅžMASI SAÄžLANDI!

ðŸ“¦ \xdcr\xfcn: "${f.product.title}"

ðŸ“ BuluÅŸma Yeri: ${p}
ðŸ“… Tarih: ${c}
â° Saat: ${m}

âš ï¸ \xd6NEMLÄ° UYARILAR:
â€¢ Belirlenen zamanda buluÅŸma yerine gidiniz
â€¢ Maksimum 1 saat esneme payÄ±nÄ±z bulunmaktadÄ±r
â€¢ ZamanÄ±nda gelmemeniz g\xfcven puanÄ±nÄ±zÄ± olumsuz etkileyebilir
â€¢ QR kodu teslim anÄ±nda taratmayÄ± unutmayÄ±n

ðŸ“± QR Kod: ${e}
ðŸ”¢ DoÄŸrulama kodu teslim anÄ±nda size iletilecektir.

Ä°yi takaslar! ðŸŽ‰`,h=x?f.requesterId:f.ownerId;return await d.default.message.create({data:{senderId:t.id,receiverId:h,content:y,productId:f.productId,isModerated:!0,moderationResult:"approved"}}),await d.default.message.create({data:{senderId:h,receiverId:t.id,content:y,productId:f.productId,isModerated:!0,moderationResult:"approved"}}),(0,w.LX)(h,w.j_.SWAP_DELIVERY_SETUP,{productTitle:f.product.title,swapId:a,location:p}).catch(e=>console.error("Push notification error:",e)),o.NextResponse.json({success:!0,message:"âœ… Teslimat noktasÄ± anlaÅŸmasÄ± saÄŸlandÄ±! QR kod oluÅŸturuldu.",qrCode:l.qrCode,qrCodeUrl:u,deliveryLocation:p,deliveryDate:q.deliveryDate,deliveryTime:q.deliveryTime,instructions:["Teslimat anlaÅŸmasÄ± saÄŸlandÄ±","QR kod her iki tarafa da mesaj olarak g\xf6nderildi","Belirlenen tarih ve saatte buluÅŸun","AlÄ±cÄ± QR kodu taratarak teslimatÄ± baÅŸlatÄ±r"]})}if("propose"===i||"counter"===i){if(!s||!["delivery_point","custom_location"].includes(s))return o.NextResponse.json({error:"Ge\xe7erli bir teslimat y\xf6ntemi se\xe7in"},{status:400});if("delivery_point"===s&&!n)return o.NextResponse.json({error:"Teslim noktasÄ± se\xe7in"},{status:400});if("custom_location"===s&&!p)return o.NextResponse.json({error:"BuluÅŸma noktasÄ± belirtin"},{status:400});if(!["accepted","delivery_proposed"].includes(f.status)){if("qr_generated"===f.status)return o.NextResponse.json({error:"Teslimat zaten ayarlanmÄ±ÅŸ"},{status:400});return o.NextResponse.json({error:"Bu takas i\xe7in teslimat ayarlanamaz"},{status:400})}if(c&&Array.isArray(c)&&c.length>5)return o.NextResponse.json({error:"En fazla 5 fotoÄŸraf y\xfckleyebilirsiniz"},{status:400});let e=null;if("delivery_point"===s&&n){let r=await d.default.deliveryPoint.findUnique({where:{id:n}});if(!r)return o.NextResponse.json({error:"Teslim noktasÄ± bulunamadÄ±"},{status:404});e=r.name}let r={proposedBy:t.id,proposedByName:t.name,proposedAt:new Date().toISOString(),deliveryMethod:s,deliveryPointId:"delivery_point"===s?n:null,deliveryPointName:e,customLocation:"custom_location"===s?p:null,deliveryDate:m||null,deliveryTime:y||null,isCounterProposal:"counter"===i},l={status:"delivery_proposed",deliveryMethod:s,deliveryPointId:"delivery_point"===s?n:null,customLocation:"custom_location"===s?p:null};c&&Array.isArray(c)&&c.length>0&&(l.senderPhotos=c),await d.default.swapRequest.update({where:{id:a},data:l}),await d.default.swapStatusLog.create({data:{swapRequestId:a,fromStatus:f.status,toStatus:"delivery_proposed",changedBy:t.id,reason:`DELIVERY_PROPOSAL|${JSON.stringify(r)}`}});let u=x?f.requesterId:f.ownerId,v=e||p||"Belirtilmedi";return await d.default.message.create({data:{senderId:t.id,receiverId:u,content:`ðŸ“ ${"counter"===i?"KARÅžI \xd6NERÄ°":"TESLÄ°MAT \xd6NERÄ°SÄ°"}

"${f.product.title}" \xfcr\xfcn\xfc i\xe7in teslimat noktasÄ± \xf6nerisi:

ðŸ“ Yer: ${v}
ðŸ“… Tarih: ${m||"Belirtilmedi"}
â° Saat: ${y||"Belirtilmedi"}

âœ… Kabul etmek i\xe7in "Onayla" butonuna tÄ±klayÄ±n
ðŸ”„ FarklÄ± bir yer \xf6nermek i\xe7in "KarÅŸÄ± \xd6neri" yapÄ±n`,productId:f.productId,isModerated:!0,moderationResult:"approved"}}),(0,w.LX)(u,w.j_.SWAP_DELIVERY_SETUP,{productTitle:f.product.title,swapId:a,location:v}).catch(e=>console.error("Push notification error:",e)),o.NextResponse.json({success:!0,message:"counter"===i?"\uD83D\uDD04 KarÅŸÄ± \xf6neri g\xf6nderildi. SatÄ±cÄ±nÄ±n onayÄ± bekleniyor.":"\uD83D\uDCCD Teslimat \xf6nerisi g\xf6nderildi. AlÄ±cÄ±nÄ±n onayÄ± bekleniyor.",proposal:r,waitingForApproval:!0,instructions:["\xd6neri karÅŸÄ± tarafa mesaj olarak g\xf6nderildi","KarÅŸÄ± taraf onayladÄ±ÄŸÄ±nda QR kod oluÅŸturulacak","KarÅŸÄ± taraf farklÄ± bir yer \xf6nerebilir"]})}return o.NextResponse.json({error:"Ge\xe7ersiz aksiyon"},{status:400})}catch(e){return console.error("Delivery setup error:",e),o.NextResponse.json({error:"Teslimat ayarlanamadÄ±"},{status:500})}}async function R(e){try{let r=await (0,l.getServerSession)(u.L);if(!r?.user?.email)return o.NextResponse.json({error:"Oturum a\xe7manÄ±z gerekiyor"},{status:401});let t=await d.default.user.findUnique({where:{email:r.user.email},select:{id:!0}});if(!t)return o.NextResponse.json({error:"KullanÄ±cÄ± bulunamadÄ±"},{status:401});let{searchParams:a}=new URL(e.url),i=a.get("swapRequestId");if(!i)return o.NextResponse.json({error:"Takas ID gerekli"},{status:400});let s=await d.default.swapRequest.findUnique({where:{id:i},include:{product:{select:{id:!0,title:!0,images:!0,valorPrice:!0}},offeredProduct:{select:{id:!0,title:!0,images:!0,valorPrice:!0}},owner:{select:{id:!0,name:!0,image:!0}},requester:{select:{id:!0,name:!0,image:!0}}}});if(!s)return o.NextResponse.json({error:"Takas isteÄŸi bulunamadÄ±"},{status:404});if(s.ownerId!==t.id&&s.requesterId!==t.id)return o.NextResponse.json({error:"Bu takas i\xe7in yetkiniz yok"},{status:403});let n=null;return s.deliveryPointId&&(n=await d.default.deliveryPoint.findUnique({where:{id:s.deliveryPointId},select:{id:!0,name:!0,address:!0,city:!0,district:!0}})),o.NextResponse.json({...s,deliveryPoint:n,isOwner:s.ownerId===t.id,isRequester:s.requesterId===t.id})}catch(e){return console.error("Delivery info error:",e),o.NextResponse.json({error:"Teslimat bilgisi alÄ±namadÄ±"},{status:500})}}let q=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/swap-requests/delivery/route",pathname:"/api/swap-requests/delivery",filename:"route",bundlePath:"app/api/swap-requests/delivery/route"},resolvedPagePath:"/home/ubuntu/takas-a-kodlar/nextjs_space/app/api/swap-requests/delivery/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:k,staticGenerationAsyncStorage:I,serverHooks:A}=q,S="/api/swap-requests/delivery/route";function j(){return(0,n.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:I})}},11826:(e,r,t)=>{t.d(r,{L:()=>d});var a=t(66291),i=t(64617),s=t(3390),n=t.n(s),o=t(83178),l=t(59521);let d={adapter:(0,i.N)(o.default),providers:[(0,a.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e,r){if(!e?.email||!e?.password)return null;let t=r?.headers?.["x-real-ip"],a=r?.headers?.["x-forwarded-for"],i=t?Array.isArray(t)?t[0]:t:a&&(Array.isArray(a)?a[0]:a).split(",").pop()?.trim()||"unknown",s=r?.headers?.["user-agent"]||"unknown";if(!(await (0,l.d5)(i,e.email)).allowed)throw await (0,l.Ky)(e.email,i,5,void 0),Error("ACCOUNT_LOCKED");let d=await o.default.user.findUnique({where:{email:e.email}});return d?await n().compare(e.password,d.password)?(await (0,l.LW)(i,d.id,d.email,s),await o.default.user.update({where:{id:d.id},data:{lastLoginAt:new Date}}),{id:d.id,email:d.email,name:d.name,role:d.role}):(await (0,l.Vm)(i,e.email,s,"Invalid password"),null):(await (0,l.Vm)(i,e.email,s,"User not found"),null)}})],session:{strategy:"jwt",maxAge:86400,updateAge:300},jwt:{maxAge:86400},callbacks:{jwt:async({token:e,user:r})=>(r&&(e.id=r.id,e.role=r.role),e),session:async({session:e,token:r})=>(e?.user&&(e.user.id=r?.id,e.user.role=r?.role),e)},pages:{signIn:"/giris"},secret:process.env.NEXTAUTH_SECRET,cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}}}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[8412,7609,3390,1472,7853,9521,9628],()=>t(12399));module.exports=a})();