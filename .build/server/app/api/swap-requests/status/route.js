"use strict";(()=>{var e={};e.id=5811,e.ids=[5811],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},44775:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>I,patchFetch:()=>k,requestAsyncStorage:()=>m,routeModule:()=>f,serverHooks:()=>w,staticGenerationAsyncStorage:()=>x});var a={};r.r(a),r.d(a,{POST:()=>p});var s=r(79182),i=r(72007),d=r(56719),o=r(93442),n=r(57978),u=r(11826),l=r(83178),c=r(59628);async function p(e){try{let t=await (0,n.getServerSession)(u.L);if(!t?.user?.email)return o.NextResponse.json({error:"GiriÅŸ yapmalÄ±sÄ±nÄ±z"},{status:401});let r=await l.default.user.findUnique({where:{email:t.user.email},select:{id:!0,name:!0,nickname:!0,email:!0}});if(!r)return o.NextResponse.json({error:"KullanÄ±cÄ± bulunamadÄ±"},{status:404});let{swapRequestId:a,action:s,code:i,deliveryType:d}=await e.json();if(!a||!s)return o.NextResponse.json({error:"swapRequestId ve action gerekli"},{status:400});let p=await l.default.swapRequest.findUnique({where:{id:a},include:{product:{select:{id:!0,title:!0}},offeredProduct:{select:{id:!0,title:!0}},owner:{select:{id:!0,name:!0,nickname:!0,email:!0}},requester:{select:{id:!0,name:!0,nickname:!0,email:!0}}}});if(!p)return o.NextResponse.json({error:"Takas bulunamadÄ±"},{status:404});let f=p.requesterId===r.id,m=p.ownerId===r.id;if(!f&&!m)return o.NextResponse.json({error:"Bu takas size ait deÄŸil"},{status:403});let x=f?p.ownerId:p.requesterId,w=r.nickname||r.name||"KullanÄ±cÄ±";if("arrived"===s){if("qr_generated"!==p.status){if("arrived"===p.status)return o.NextResponse.json({error:"Her iki taraf da zaten geldi"},{status:400});return o.NextResponse.json({error:"Bu takas teslimat aÅŸamasÄ±nda deÄŸil"},{status:400})}let e={};if(m){if(p.ownerArrived)return o.NextResponse.json({error:"Zaten geldiÄŸinizi bildirdiniz"},{status:400});if(!(p.packagingPhotos&&p.packagingPhotos.length>0))return o.NextResponse.json({error:"Paketleme fotoÄŸrafÄ± zorunludur. L\xfctfen \xf6nce fotoÄŸraf y\xfckleyin."},{status:400});e.ownerArrived=!0}else{if(p.requesterArrived)return o.NextResponse.json({error:"Zaten geldiÄŸinizi bildirdiniz"},{status:400});e.requesterArrived=!0}let t=!!m||p.ownerArrived||!1,s=!!f||p.requesterArrived||!1;if(t&&s&&(e.status="arrived"),await l.default.swapRequest.update({where:{id:a},data:e}),t&&s){let e=`âœ… Her iki taraf da teslimat noktasÄ±na geldi! Åimdi QR kodu taratabilirsiniz.`;await l.default.message.createMany({data:[{senderId:r.id,receiverId:p.ownerId,content:e,productId:p.productId,isModerated:!0,moderationResult:"approved"},{senderId:r.id,receiverId:p.requesterId,content:e,productId:p.productId,isModerated:!0,moderationResult:"approved"}]})}else await l.default.message.create({data:{senderId:r.id,receiverId:x,content:`ğŸ“ ${w} teslimat noktasÄ±na geldiÄŸini bildirdi! Siz de geldiÄŸinizde "Geldim" butonuna basÄ±n.`,productId:p.productId,isModerated:!0,moderationResult:"approved"}});return(0,c.LX)(x,c.j_.SWAP_DELIVERY_SETUP,{productTitle:p.product.title,swapId:a}).catch(console.error),o.NextResponse.json({success:!0,message:t&&s?"Ä°ki taraf da geldi! QR tarama baÅŸlayabilir.":"GeldiÄŸiniz bildirildi. KarÅŸÄ± tarafÄ± bekliyorsunuz.",bothArrived:t&&s,ownerArrived:t,requesterArrived:s})}if("start_inspection"===s){if("qr_scanned"!==p.status)return o.NextResponse.json({error:"\xd6nce QR kod taranmalÄ±"},{status:400});return await l.default.swapRequest.update({where:{id:a},data:{status:"inspection"}}),await l.default.message.create({data:{senderId:r.id,receiverId:x,content:`ğŸ” ${w} \xfcr\xfcn\xfc kontrol ediyor. L\xfctfen bekleyin.`,productId:p.productId,isModerated:!0,moderationResult:"approved"}}),o.NextResponse.json({success:!0,message:"Kontrol baÅŸladÄ±"})}if("approve_product"===s){if("inspection"!==p.status)return o.NextResponse.json({error:"\xdcr\xfcn kontrol aÅŸamasÄ±nda olmalÄ±"},{status:400});if(!(p.receivingPhotos&&p.receivingPhotos.length>0))return o.NextResponse.json({error:"AlÄ±m fotoÄŸrafÄ± zorunludur. L\xfctfen \xf6nce fotoÄŸraf y\xfckleyin."},{status:400});if("drop_off"===p.deliveryType){await l.default.swapRequest.update({where:{id:a},data:{status:"completed"}});let e=`ğŸ‰ TAKAS G\xdcVENLÄ° BÄ°R ÅEKÄ°LDE TAMAMLANDI!

ğŸ“¦ \xdcr\xfcn: ${p.product.title}
âœ… AlÄ±cÄ± \xfcr\xfcn\xfc onayladÄ±.

â­ L\xfctfen karÅŸÄ± tarafÄ± deÄŸerlendirmeyi unutmayÄ±n!

TeÅŸekk\xfcrler, TAKAS-A ğŸ’œ`;return await l.default.message.create({data:{senderId:r.id,receiverId:p.ownerId,content:e,productId:p.productId,isModerated:!0,moderationResult:"approved"}}),await l.default.message.create({data:{senderId:r.id,receiverId:p.requesterId,content:e,productId:p.productId,isModerated:!0,moderationResult:"approved"}}),(0,c.LX)(x,c.j_.SWAP_COMPLETED,{productTitle:p.product.title,swapId:a}).catch(console.error),o.NextResponse.json({success:!0,message:"Takas tamamlandÄ±!"})}let e=p.deliveryVerificationCode;if(!e)return o.NextResponse.json({error:"DoÄŸrulama kodu bulunamadÄ±"},{status:400});return await l.default.swapRequest.update({where:{id:a},data:{status:"code_sent"}}),await l.default.message.create({data:{senderId:r.id,receiverId:r.id,content:`ğŸ”‘ DoÄŸrulama Kodunuz: ${e}

ğŸ“¦ Bu kodu satÄ±cÄ±ya s\xf6yleyin.
âš ï¸ Kodu sadece y\xfcz y\xfcze paylaÅŸÄ±n!`,productId:p.productId,isModerated:!0,moderationResult:"approved"}}),await l.default.message.create({data:{senderId:r.id,receiverId:x,content:`âœ… ${w} \xfcr\xfcn\xfc onayladÄ±! Åimdi alÄ±cÄ±dan 6 haneli doÄŸrulama kodunu isteyin ve Takas Merkezi'ne girin.`,productId:p.productId,isModerated:!0,moderationResult:"approved"}}),(0,c.LX)(x,c.j_.SWAP_CONFIRMED,{productTitle:p.product.title,swapId:a}).catch(console.error),o.NextResponse.json({success:!0,message:"\xdcr\xfcn onaylandÄ±, kod iletildi",verificationCode:e})}if("verify_code"===s){if("code_sent"!==p.status)return o.NextResponse.json({error:"Kod iletilmiÅŸ olmalÄ±"},{status:400});if(!i)return o.NextResponse.json({error:"6 haneli kodu girin"},{status:400});let e=p.deliveryVerificationCode;if(i!==e)return o.NextResponse.json({error:"DoÄŸrulama kodu yanlÄ±ÅŸ!"},{status:400});await l.default.swapRequest.update({where:{id:a},data:{status:"completed"}});let t=`ğŸ‰ TAKAS G\xdcVENLÄ° BÄ°R ÅEKÄ°LDE TAMAMLANDI!

ğŸ“¦ \xdcr\xfcn: ${p.product.title}
âœ… DoÄŸrulama kodu eÅŸleÅŸti.

â­ L\xfctfen karÅŸÄ± tarafÄ± deÄŸerlendirmeyi unutmayÄ±n!

TeÅŸekk\xfcrler, TAKAS-A ğŸ’œ`;return await l.default.message.create({data:{senderId:r.id,receiverId:p.ownerId,content:t,productId:p.productId,isModerated:!0,moderationResult:"approved"}}),await l.default.message.create({data:{senderId:r.id,receiverId:p.requesterId,content:t,productId:p.productId,isModerated:!0,moderationResult:"approved"}}),(0,c.LX)(x,c.j_.SWAP_COMPLETED,{productTitle:p.product.title,swapId:a}).catch(console.error),o.NextResponse.json({success:!0,message:"Takas tamamlandÄ±!"})}if("dispute"===s){if(!["qr_scanned","inspection","arrived"].includes(p.status))return o.NextResponse.json({error:"Bu aÅŸamada sorun bildirilemez"},{status:400});return await l.default.swapRequest.update({where:{id:a},data:{status:"disputed"}}),await l.default.message.create({data:{senderId:r.id,receiverId:x,content:`âš ï¸ ${w} bir sorun bildirdi. Destek ekibi inceleme baÅŸlatacak.`,productId:p.productId,isModerated:!0,moderationResult:"approved"}}),(0,c.LX)(x,c.j_.SWAP_DISPUTE,{productTitle:p.product.title,swapId:a}).catch(console.error),o.NextResponse.json({success:!0,message:"Sorun bildirildi"})}if("set_delivery_type"===s){if(!["face_to_face","drop_off"].includes(d))return o.NextResponse.json({error:"Ge\xe7ersiz teslimat y\xf6ntemi"},{status:400});if("accepted"!==p.status)return o.NextResponse.json({error:"Takas kabul edilmiÅŸ olmalÄ±"},{status:400});await l.default.swapRequest.update({where:{id:a},data:{deliveryType:d}});let e="face_to_face"===d?"BuluÅŸma":"Teslim NoktasÄ±na BÄ±rakma";return await l.default.message.create({data:{senderId:r.id,receiverId:x,content:`ğŸ“¦ ${w} teslimat y\xf6ntemi olarak "${e}" se\xe7ti. Åimdi teslimat noktasÄ±nÄ± belirleyin.`,productId:p.productId,isModerated:!0,moderationResult:"approved"}}),o.NextResponse.json({success:!0,message:`Teslimat y\xf6ntemi: ${e}`})}if("drop_off"===s){if("drop_off"!==p.deliveryType)return o.NextResponse.json({error:"Bu takas buluÅŸma y\xf6ntemiyle planlandÄ±"},{status:400});if(!m)return o.NextResponse.json({error:"Sadece satÄ±cÄ± \xfcr\xfcn\xfc bÄ±rakabilir"},{status:403});if("qr_generated"!==p.status)return o.NextResponse.json({error:"\xd6nce QR kod oluÅŸturulmalÄ±"},{status:400});let e=new Date,t=new Date(e),s=0;for(;s<3;){t.setDate(t.getDate()+1);let e=t.getDay();0!==e&&6!==e&&s++}let i=Math.floor(1e5+9e5*Math.random()).toString();await l.default.swapRequest.update({where:{id:a},data:{status:"dropped_off",droppedOffAt:e,dropOffDeadline:t,deliveryVerificationCode:i}});let d=p.customLocation||"Teslim noktasÄ±";return await l.default.message.create({data:{senderId:r.id,receiverId:p.requesterId,content:`ğŸ“¦ \xdcr\xfcn teslim noktasÄ±na bÄ±rakÄ±ldÄ±!

ğŸ“ Konum: ${d}
ğŸ”‘ Teslim Kodu: ${i}
â° Son tarih: ${t.toLocaleDateString("tr-TR",{day:"numeric",month:"long",year:"numeric"})}

âš ï¸ \xdcr\xfcn\xfc alÄ±rken bu kodu girmeniz gerekecek.`,productId:p.productId,isModerated:!0,moderationResult:"approved"}}),(0,c.LX)(p.requesterId,c.j_.SWAP_DELIVERY_SETUP,{productTitle:p.product.title,swapId:a}).catch(console.error),o.NextResponse.json({success:!0,message:"\xdcr\xfcn bÄ±rakÄ±ldÄ±",dropOffDeadline:t})}if("picked_up"===s){if("dropped_off"!==p.status)return o.NextResponse.json({error:"\xdcr\xfcn hen\xfcz bÄ±rakÄ±lmamÄ±ÅŸ"},{status:400});if(!f)return o.NextResponse.json({error:"Sadece alÄ±cÄ± \xfcr\xfcn\xfc alabilir"},{status:403});if(p.deliveryVerificationCode&&"drop_off"===p.deliveryType){if(!i)return o.NextResponse.json({error:"6 haneli teslim kodunu girin"},{status:400});if(i!==p.deliveryVerificationCode)return o.NextResponse.json({error:"Teslim kodu yanlÄ±ÅŸ"},{status:400})}return await l.default.swapRequest.update({where:{id:a},data:{status:"inspection",pickedUpAt:new Date}}),await l.default.message.create({data:{senderId:r.id,receiverId:p.ownerId,content:`âœ… ${w} \xfcr\xfcn\xfc teslim noktasÄ±ndan aldÄ± ve kontrol ediyor.`,productId:p.productId,isModerated:!0,moderationResult:"approved"}}),(0,c.LX)(p.ownerId,c.j_.SWAP_QR_SCANNED,{productTitle:p.product.title,swapId:a}).catch(console.error),o.NextResponse.json({success:!0,message:"\xdcr\xfcn alÄ±ndÄ±, kontrol baÅŸladÄ±"})}return o.NextResponse.json({error:"Ge\xe7ersiz action"},{status:400})}catch(e){return console.error("Swap status error:",e),o.NextResponse.json({error:"Sunucu hatasÄ±"},{status:500})}}let f=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/swap-requests/status/route",pathname:"/api/swap-requests/status",filename:"route",bundlePath:"app/api/swap-requests/status/route"},resolvedPagePath:"/home/ubuntu/takas-a-kodlar/nextjs_space/app/api/swap-requests/status/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:x,serverHooks:w}=f,I="/api/swap-requests/status/route";function k(){return(0,d.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:x})}},11826:(e,t,r)=>{r.d(t,{L:()=>u});var a=r(66291),s=r(64617),i=r(3390),d=r.n(i),o=r(83178),n=r(59521);let u={adapter:(0,s.N)(o.default),providers:[(0,a.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e,t){if(!e?.email||!e?.password)return null;let r=t?.headers?.["x-real-ip"],a=t?.headers?.["x-forwarded-for"],s=r?Array.isArray(r)?r[0]:r:a&&(Array.isArray(a)?a[0]:a).split(",").pop()?.trim()||"unknown",i=t?.headers?.["user-agent"]||"unknown";if(!(await (0,n.d5)(s,e.email)).allowed)throw await (0,n.Ky)(e.email,s,5,void 0),Error("ACCOUNT_LOCKED");let u=await o.default.user.findUnique({where:{email:e.email}});return u?await d().compare(e.password,u.password)?(await (0,n.LW)(s,u.id,u.email,i),await o.default.user.update({where:{id:u.id},data:{lastLoginAt:new Date}}),{id:u.id,email:u.email,name:u.name,role:u.role}):(await (0,n.Vm)(s,e.email,i,"Invalid password"),null):(await (0,n.Vm)(s,e.email,i,"User not found"),null)}})],session:{strategy:"jwt",maxAge:86400,updateAge:300},jwt:{maxAge:86400},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.role=t.role),e),session:async({session:e,token:t})=>(e?.user&&(e.user.id=t?.id,e.user.role=t?.role),e)},pages:{signIn:"/giris"},secret:process.env.NEXTAUTH_SECRET,cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8412,7609,3390,1472,7853,9521,9628],()=>r(44775));module.exports=a})();