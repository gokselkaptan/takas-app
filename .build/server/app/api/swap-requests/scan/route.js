"use strict";(()=>{var e={};e.id=4631,e.ids=[4631],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},28833:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>R,patchFetch:()=>A,requestAsyncStorage:()=>v,routeModule:()=>k,serverHooks:()=>w,staticGenerationAsyncStorage:()=>y});var a={};t.r(a),t.d(a,{POST:()=>g,dynamic:()=>m});var i=t(79182),n=t(72007),s=t(56719),o=t(93442),d=t(57978),l=t(83178),u=t(11826),c=t(59628),p=t(68247);let m="force-dynamic";async function f(e,r,t,a,i){try{let i=`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
        <div style="text-align: center; margin-bottom: 30px;">
          <h1 style="color: #7C3AED; margin: 0;">ğŸ’œ TAKAS-A</h1>
          <p style="color: #666; margin: 5px 0;">Teslimat DoÄŸrulama Kodu</p>
        </div>
        
        <div style="background: linear-gradient(135deg, #7C3AED 0%, #F97316 100%); padding: 3px; border-radius: 12px;">
          <div style="background: white; border-radius: 10px; padding: 25px;">
            <p style="margin: 0 0 15px; color: #333;">Merhaba <strong>${r}</strong>,</p>
            
            <p style="margin: 0 0 20px; color: #555;">
              <strong>"${t}"</strong> \xfcr\xfcn\xfc i\xe7in QR kodu baÅŸarÄ±yla tarandÄ±! \xdcr\xfcn\xfc teslim almak i\xe7in aÅŸaÄŸÄ±daki doÄŸrulama kodunu sisteme girin:
            </p>
            
            <div style="background: #F3F0FF; border-radius: 12px; padding: 25px; text-align: center; margin: 20px 0;">
              <p style="margin: 0 0 10px; color: #7C3AED; font-size: 14px; font-weight: 500;">DoÄŸrulama Kodunuz:</p>
              <div style="font-size: 36px; font-weight: bold; color: #7C3AED; letter-spacing: 8px; font-family: 'Courier New', monospace;">
                ${a}
              </div>
            </div>
            
            <div style="background: #FEF3C7; border-left: 4px solid #F59E0B; padding: 15px; border-radius: 0 8px 8px 0; margin: 20px 0;">
              <p style="margin: 0; color: #92400E; font-size: 14px;">
                âš ï¸ <strong>\xd6nemli:</strong> Bu kodu sadece \xfcr\xfcn\xfc fiziksel olarak kontrol ettikten sonra girin. Kod girildikten sonra teslimat onaylanmÄ±ÅŸ sayÄ±lÄ±r ve satÄ±cÄ±ya \xf6deme aktarÄ±lÄ±r.
              </p>
            </div>
            
            <div style="background: #F0FDF4; border-radius: 8px; padding: 15px; margin: 20px 0;">
              <p style="margin: 0 0 10px; color: #166534; font-weight: 600;">âœ… Son AdÄ±mlar:</p>
              <ol style="margin: 0; padding-left: 20px; color: #166534; font-size: 14px;">
                <li>\xdcr\xfcn\xfc detaylÄ±ca kontrol edin</li>
                <li>1-2 fotoÄŸraf \xe7ekin (kanÄ±t i\xe7in)</li>
                <li>Bu 6 haneli kodu sisteme girin</li>
                <li>Teslimat tamamlanacak!</li>
              </ol>
            </div>
            
            <p style="margin: 20px 0 0; color: #999; font-size: 12px; text-align: center;">
              Bu kod 24 saat ge\xe7erlidir. Sorun yaÅŸarsanÄ±z <a href="mailto:join@takas-a.com" style="color: #7C3AED;">join@takas-a.com</a> adresinden bize ulaÅŸÄ±n.
            </p>
          </div>
        </div>
        
        <p style="text-align: center; color: #999; font-size: 12px; margin-top: 20px;">
          \xa9 2025 TAKAS-A | Ä°zmir'in Takas Platformu
        </p>
      </div>
    `,n=await fetch("https://apps.abacus.ai/api/sendNotificationEmail",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deployment_token:process.env.ABACUSAI_API_KEY,app_id:process.env.WEB_APP_ID,notification_id:process.env.NOTIF_ID_TESLIMAT_DORULAMA,subject:`[TAKAS-A] QR TarandÄ±! DoÄŸrulama Kodu: ${a}`,body:i,is_html:!0,recipient_email:e,sender_email:"noreply@takas-a.com",sender_alias:"TAKAS-A"})});if(!n.ok){let e=await n.text();return console.error("Email API error:",n.status,e),{success:!1,error:`Email API error: ${n.status}`}}return console.log(`Verification email sent to ${e} for product "${t}"`),{success:!0}}catch(e){return console.error("Verification email error:",e),{success:!1,error:String(e)}}}async function x(e,r,t,a,i,n){try{return await l.default.message.create({data:{senderId:e,receiverId:r,content:`ğŸ” TESLÄ°MAT DOÄRULAMA KODU

"${a}" \xfcr\xfcn\xfc i\xe7in 6 haneli doÄŸrulama kodunuz:

ğŸ“Ÿ ${i}

âš ï¸ Bu kodu sadece \xfcr\xfcn\xfc teslim aldÄ±ktan ve kontrol ettikten sonra sisteme girin!

âœ… Kod girildikten sonra teslimat tamamlanmÄ±ÅŸ sayÄ±lÄ±r.`,productId:t,isModerated:!0,moderationResult:"approved",metadata:JSON.stringify({type:"verification_code",swapRequestId:n,verificationCode:i,sentAt:new Date().toISOString()})}}),console.log(`Verification code system message sent to user ${r}`),!0}catch(e){return console.error("System message error:",e),!1}}async function g(e){try{let r=await (0,d.getServerSession)(u.L);if(!r?.user?.email)return o.NextResponse.json({error:"Oturum a\xe7manÄ±z gerekiyor"},{status:401});let t=await l.default.user.findUnique({where:{email:r.user.email},select:{id:!0,email:!0,name:!0}});if(!t)return o.NextResponse.json({error:"KullanÄ±cÄ± bulunamadÄ±"},{status:401});let{qrCode:a,verificationCode:i,receiverPhotos:n,previewOnly:s,action:m,swapRequestId:g}=await e.json();if("send_code_email"===m&&g){let e=await l.default.swapRequest.findUnique({where:{id:g},include:{product:{select:{id:!0,title:!0}},owner:{select:{id:!0,name:!0,email:!0}},requester:{select:{id:!0,name:!0,email:!0}}}});if(!e)return o.NextResponse.json({error:"Takas isteÄŸi bulunamadÄ±"},{status:404});if(e.ownerId!==t.id)return o.NextResponse.json({error:"Sadece satÄ±cÄ± kodu g\xf6nderebilir"},{status:403});if(!["accepted","qr_generated","qr_scanned"].includes(e.status))return o.NextResponse.json({error:"Bu takas i\xe7in teslimat beklenmiyor"},{status:400});if(!e.deliveryVerificationCode)return o.NextResponse.json({error:"DoÄŸrulama kodu bulunamadÄ±"},{status:400});let r=await f(e.requester.email,e.requester.name||"KullanÄ±cÄ±",e.product.title,e.deliveryVerificationCode,e.owner.name||"SatÄ±cÄ±"),a=await x(e.ownerId,e.requesterId,e.product.id,e.product.title,e.deliveryVerificationCode,e.id);await l.default.swapRequest.update({where:{id:g},data:{verificationCodeSentAt:new Date,verificationCodeSentViaEmail:r.success}}),(0,c.LX)(e.requesterId,c.j_.SWAP_QR_SCANNED,{productTitle:e.product.title,swapId:e.id,receiverName:e.owner.name}).catch(e=>console.error("Push notification error:",e));let i=[];return r.success&&i.push("email"),a&&i.push("sistem mesajÄ±"),o.NextResponse.json({success:r.success||a,emailSent:r.success,messageSent:a,message:i.length>0?`âœ… DoÄŸrulama kodu ${i.join(" ve ")} olarak g\xf6nderildi!`:"âš ï¸ Kod g\xf6nderilemedi, l\xfctfen tekrar deneyin.",emailError:r.error,instructions:["AlÄ±cÄ±ya email ve mesaj olarak 6 haneli doÄŸrulama kodu g\xf6nderildi","AlÄ±cÄ± \xfcr\xfcn\xfc teslim alÄ±p kodu sisteme girecek","Kod girildiÄŸinde teslimat onaylanÄ±r ve Valor puanÄ±nÄ±z aktarÄ±lÄ±r"]})}if(!a)return o.NextResponse.json({error:"QR kod gerekli"},{status:400});let k=a.toString().trim().toUpperCase(),v=!1,y=await l.default.swapRequest.findUnique({where:{qrCode:k},include:{product:{select:{id:!0,title:!0,images:!0,valorPrice:!0,aiValorPrice:!0}},offeredProduct:{select:{id:!0,title:!0,images:!0,valorPrice:!0}},owner:{select:{id:!0,name:!0,email:!0}},requester:{select:{id:!0,name:!0,email:!0}}}});if(!y&&(y=await l.default.swapRequest.findUnique({where:{qrCodeB:k},include:{product:{select:{id:!0,title:!0,images:!0,valorPrice:!0,aiValorPrice:!0}},offeredProduct:{select:{id:!0,title:!0,images:!0,valorPrice:!0}},owner:{select:{id:!0,name:!0,email:!0}},requester:{select:{id:!0,name:!0,email:!0}}}}))&&(v=!0),y||(y=await l.default.swapRequest.findUnique({where:{qrCode:a.toString().trim()},include:{product:{select:{id:!0,title:!0,images:!0,valorPrice:!0,aiValorPrice:!0}},offeredProduct:{select:{id:!0,title:!0,images:!0,valorPrice:!0}},owner:{select:{id:!0,name:!0,email:!0}},requester:{select:{id:!0,name:!0,email:!0}}}})),!y){let e=k.replace("TAKAS-",""),r=await l.default.swapRequest.findMany({where:{OR:[{qrCode:{contains:e,mode:"insensitive"}},{qrCodeB:{contains:e,mode:"insensitive"}}]},include:{product:{select:{id:!0,title:!0,images:!0,valorPrice:!0,aiValorPrice:!0}},offeredProduct:{select:{id:!0,title:!0,images:!0,valorPrice:!0}},owner:{select:{id:!0,name:!0,email:!0}},requester:{select:{id:!0,name:!0,email:!0}}},take:1});r[0]&&(y=r[0],y.qrCodeB?.toUpperCase().includes(e)&&(v=!0))}if(!y)return console.error("QR kod bulunamadÄ±:",{original:a,normalized:k}),o.NextResponse.json({error:"Ge\xe7ersiz QR kod",hint:"QR kod sistemde bulunamadÄ±. DoÄŸru takasÄ± mÄ± tarÄ±yorsunuz?"},{status:404});let w=!!y.offeredProductId;if(s){if(!["accepted","qr_generated","qr_scanned"].includes(y.status)){if("delivered"===y.status)return o.NextResponse.json({valid:!1,error:"Bu \xfcr\xfcn zaten teslim alÄ±nmÄ±ÅŸ",status:y.status});if("completed"===y.status)return o.NextResponse.json({valid:!1,error:"Bu takas zaten tamamlanmÄ±ÅŸ",status:y.status});return o.NextResponse.json({valid:!1,error:"Bu takas i\xe7in teslimat beklenmiyor",status:y.status})}if(w){if(!v&&y.requesterId!==t.id)return o.NextResponse.json({valid:!1,error:"Bu QR kodu sadece alÄ±cÄ± (teklif eden) tarayabilir"});if(v&&y.ownerId!==t.id)return o.NextResponse.json({valid:!1,error:"Bu QR kodu sadece \xfcr\xfcn sahibi tarayabilir"})}else if(y.requesterId!==t.id)return o.NextResponse.json({valid:!1,error:"Sadece alÄ±cÄ± QR kodu tarayabilir"});let e=v?!!y.qrCodeBScannedAt:!!y.qrScannedAt,r=v?y.offeredProduct:y.product;return o.NextResponse.json({valid:!0,swapRequestId:y.id,product:r,senderPhotos:v?y.requesterSenderPhotos:y.senderPhotos,isQrScanned:e,isQrCodeB:v,isProductToProductSwap:w,requiresVerificationCode:e,instructions:e?["QR zaten tarandÄ±","Email adresinize gelen 6 haneli kodu girin","FotoÄŸraf \xe7ekin ve teslimatÄ± tamamlayÄ±n"]:["QR kodu tarayÄ±n","Email adresinize 6 haneli kod gelecek","Kodu girerek teslimatÄ± tamamlayÄ±n"]})}if("scan_qr"===m||!i&&!n){if(!["accepted","qr_generated","qr_scanned"].includes(y.status)){if("delivered"===y.status)return o.NextResponse.json({error:"Bu \xfcr\xfcn zaten teslim alÄ±nmÄ±ÅŸ"},{status:400});if("completed"===y.status)return o.NextResponse.json({error:"Bu takas zaten tamamlanmÄ±ÅŸ"},{status:400});return o.NextResponse.json({error:"Bu takas i\xe7in teslimat beklenmiyor"},{status:400})}if(w){if(v?!!y.qrCodeBScannedAt:!!y.qrScannedAt)return o.NextResponse.json({success:!0,alreadyScanned:!0,isQrCodeB:v,message:`Bu QR kod zaten tarandÄ±. Email veya mesajlarÄ±nÄ±zdan 6 haneli kodu girin.`,requiresVerificationCode:!0})}else if("qr_scanned"===y.status)return o.NextResponse.json({success:!0,alreadyScanned:!0,message:"QR kod zaten tarandÄ±. Email veya mesajlarÄ±nÄ±zdan 6 haneli kodu girin.",requiresVerificationCode:!0});if(w){if(!v&&y.requesterId!==t.id)return o.NextResponse.json({error:"Bu QR kodu sadece alÄ±cÄ± (teklif eden) tarayabilir",hint:"Her \xfcr\xfcn i\xe7in farklÄ± kiÅŸi QR kodu taramalÄ±dÄ±r"},{status:403});if(v&&y.ownerId!==t.id)return o.NextResponse.json({error:"Bu QR kodu sadece \xfcr\xfcn sahibi tarayabilir",hint:"Her \xfcr\xfcn i\xe7in farklÄ± kiÅŸi QR kodu taramalÄ±dÄ±r"},{status:403})}else if(y.requesterId!==t.id)return o.NextResponse.json({error:"Sadece alÄ±cÄ± QR kodu tarayabilir",hint:"\xdcr\xfcn\xfc talep eden kiÅŸi QR kodu taramalÄ±dÄ±r"},{status:403});let e=v?y.deliveryVerificationCodeB:y.deliveryVerificationCode;if(!e)return o.NextResponse.json({error:"DoÄŸrulama kodu bulunamadÄ±. SatÄ±cÄ±yla iletiÅŸime ge\xe7in."},{status:400});let r=v?y.owner:y.requester,a=v?y.requester:y.owner,i=v?y.offeredProduct:y.product,n=i?.title||"\xdcr\xfcn",s=await f(r.email,r.name||"KullanÄ±cÄ±",n,e,a.name||"SatÄ±cÄ±"),d=await x(a.id,r.id,i?.id||y.productId,n,e,y.id),u=v?{qrCodeBScannedAt:new Date,verificationCodeBSentAt:new Date,verificationCodeBSentViaEmail:s.success}:{qrScannedAt:new Date,verificationCodeSentAt:new Date,verificationCodeSentViaEmail:s.success};w||(u.status="qr_scanned"),await l.default.swapRequest.update({where:{id:y.id},data:u}),(0,c.LX)(a.id,c.j_.SWAP_QR_SCANNED,{productTitle:n,swapId:y.id,receiverName:r.name}).catch(e=>console.error("Push notification error:",e));let p=[];s.success&&p.push("email"),d&&p.push("mesajlarÄ±nÄ±z");let m=p.length>0?`QR kod tarandÄ±! 6 haneli doÄŸrulama kodu ${p.join(" ve ")} \xfczerinden g\xf6nderildi.`:"QR kod tarandÄ±! DoÄŸrulama kodu g\xf6nderilemedi, satÄ±cÄ±yla iletiÅŸime ge\xe7in.";if(w){let e=v?!!y.qrScannedAt:!!y.qrCodeBScannedAt,r=v?y.offeredProduct?.title:y.product.title;m+=`

ğŸ“¦ "${r}" i\xe7in QR tarandÄ±.`,e?m+=`
âœ… Her iki \xfcr\xfcn i\xe7in de QR tarandÄ±! KodlarÄ± girerek takasÄ± tamamlayÄ±n.`:m+=`
â³ DiÄŸer \xfcr\xfcn i\xe7in QR hen\xfcz taranmadÄ±.`}return o.NextResponse.json({success:s.success||d,message:m,emailSent:s.success,messageSent:d,emailError:s.error,requiresVerificationCode:!0,swapRequestId:y.id,product:v?y.offeredProduct:y.product,isQrCodeB:v,isProductToProductSwap:w,instructions:w?[`"${n}" i\xe7in doÄŸrulama kodu g\xf6nderildi`,"\xdcr\xfcn\xfc kontrol edin ve 1-2 fotoÄŸraf \xe7ekin","Kodu ve fotoÄŸraflarÄ± girerek onaylayÄ±n","Her iki taraf da onayladÄ±ÄŸÄ±nda takas tamamlanÄ±r"]:["Email ve mesajlarÄ±nÄ±za 6 haneli doÄŸrulama kodu g\xf6nderildi","\xdcr\xfcn\xfc kontrol edin ve 1-2 fotoÄŸraf \xe7ekin","Kodu ve fotoÄŸraflarÄ± girerek teslimatÄ± tamamlayÄ±n"]})}if(!["accepted","qr_generated","qr_scanned"].includes(y.status)){if("delivered"===y.status)return o.NextResponse.json({error:"Bu \xfcr\xfcn zaten teslim alÄ±nmÄ±ÅŸ"},{status:400});if("completed"===y.status)return o.NextResponse.json({error:"Bu takas zaten tamamlanmÄ±ÅŸ"},{status:400});return o.NextResponse.json({error:"Bu takas i\xe7in teslimat beklenmiyor"},{status:400})}if(w){if(!v&&y.requesterId!==t.id)return o.NextResponse.json({error:"Bu \xfcr\xfcn i\xe7in sadece alÄ±cÄ± (teklif eden) onay verebilir"},{status:403});if(v&&y.ownerId!==t.id)return o.NextResponse.json({error:"Bu \xfcr\xfcn i\xe7in sadece \xfcr\xfcn sahibi onay verebilir"},{status:403})}else if(y.requesterId!==t.id)return o.NextResponse.json({error:"Sadece alÄ±cÄ± teslimatÄ± onaylayabilir"},{status:403});if(w){if(v?y.ownerReceivedProduct:y.requesterReceivedProduct)return o.NextResponse.json({error:"Bu \xfcr\xfcn\xfc zaten onayladÄ±nÄ±z"},{status:400})}else if(y.deliveredAt)return o.NextResponse.json({error:"Bu \xfcr\xfcn zaten teslim alÄ±nmÄ±ÅŸ"},{status:400});if(!i)return o.NextResponse.json({error:"DoÄŸrulama kodu gerekli",hint:"Email adresinize g\xf6nderilen 6 haneli kodu girin",requiresVerificationCode:!0},{status:400});if((v?y.deliveryVerificationCodeB:y.deliveryVerificationCode)!==i)return o.NextResponse.json({error:"Ge\xe7ersiz doÄŸrulama kodu",hint:"L\xfctfen email adresinize g\xf6nderilen kodu kontrol edin"},{status:400});if(v?y.verificationCodeBUsed:y.verificationCodeUsed)return o.NextResponse.json({error:"Bu doÄŸrulama kodu zaten kullanÄ±lmÄ±ÅŸ"},{status:400});let R=v?y.verificationCodeBSentAt:y.verificationCodeSentAt;if(R&&Date.now()-new Date(R).getTime()>864e5)return o.NextResponse.json({error:"DoÄŸrulama kodunun s\xfcresi dolmuÅŸ",hint:"SatÄ±cÄ±dan yeni bir teslimat ayarlamasÄ± isteyin"},{status:400});if(!n||!Array.isArray(n)||n.length<1)return o.NextResponse.json({error:"\xdcr\xfcn\xfcn teslim sonrasÄ± en az 1 fotoÄŸrafÄ±nÄ± y\xfckleyin",hint:"Bu fotoÄŸraflar olasÄ± anlaÅŸmazlÄ±klarda kanÄ±t olarak kullanÄ±lacaktÄ±r",requiresPhotos:!0},{status:400});if(n.length>5)return o.NextResponse.json({error:"En fazla 5 fotoÄŸraf y\xfckleyebilirsiniz"},{status:400});let A=new Date,h=(0,p.AN)(A),q=new Date(A.getTime()+864e5),S=v?y.offeredProduct:y.product,I=S?.valorPrice||0;if(w){let e=v?{ownerReceivedProduct:!0,ownerReceivedAt:A,ownerReceiverPhotos:n,verificationCodeBUsed:!0}:{requesterReceivedProduct:!0,requesterReceivedAt:A,receiverPhotos:n,verificationCodeUsed:!0},r=await l.default.swapRequest.update({where:{id:y.id},data:e});v?r.requesterReceivedProduct:r.ownerReceivedProduct;let t=await l.default.swapRequest.findUnique({where:{id:y.id},select:{ownerReceivedProduct:!0,requesterReceivedProduct:!0}});if(t?.ownerReceivedProduct&&t?.requesterReceivedProduct)return await l.default.swapRequest.update({where:{id:y.id},data:{status:"delivered",deliveredAt:A,deliveryConfirmDeadline:q,disputeWindowEndsAt:h}}),await l.default.activityFeed.create({data:{type:"product_swap_completed",userId:y.requesterId,userName:y.requester.name,productId:y.productId,productTitle:y.product.title,targetUserId:y.ownerId,targetUserName:y.owner.name,city:"Ä°zmir",metadata:JSON.stringify({swapRequestId:y.id,isProductToProductSwap:!0,offeredProductTitle:y.offeredProduct?.title,photosCount:n.length})}}),(0,c.LX)(y.ownerId,c.j_.SWAP_COMPLETED,{productTitle:y.product.title,swapId:y.id}).catch(e=>console.error("Push notification error:",e)),(0,c.LX)(y.requesterId,c.j_.SWAP_COMPLETED,{productTitle:y.offeredProduct?.title||"Teklif edilen \xfcr\xfcn",swapId:y.id}).catch(e=>console.error("Push notification error:",e)),o.NextResponse.json({success:!0,message:"\uD83C\uDF89 \xdcR\xdcNE KARÅI \xdcR\xdcN TAKASI TAMAMLANDI! Her iki taraf da \xfcr\xfcnleri onayladÄ±.",swapRequestId:y.id,isProductToProductSwap:!0,bothConfirmed:!0,deliveredAt:A.toISOString(),disputeWindowEndsAt:h.toISOString(),instructions:["Her iki \xfcr\xfcn de baÅŸarÄ±yla teslim alÄ±ndÄ±!",`${p.kg} saat i\xe7inde sorun bildirmezseniz takas otomatik onaylanÄ±r`,"Takas tamamlandÄ±, iyi kullanÄ±mlar!"]});{let e=v?"AlÄ±cÄ±nÄ±n (requester)":"SatÄ±cÄ±nÄ±n (owner)";return o.NextResponse.json({success:!0,message:`âœ… "${S?.title}" \xfcr\xfcn\xfcn\xfc onayladÄ±nÄ±z! ${e} onayÄ± bekleniyor.`,swapRequestId:y.id,isProductToProductSwap:!0,bothConfirmed:!1,yourConfirmation:!0,waitingForOther:!0,instructions:[`"${S?.title}" i\xe7in onayÄ±nÄ±z alÄ±ndÄ±`,"KarÅŸÄ± tarafÄ±n onayÄ± bekleniyor","Her iki onay alÄ±ndÄ±ÄŸÄ±nda takas tamamlanacak"]})}}return await l.default.swapRequest.update({where:{id:y.id},data:{status:"delivered",deliveredAt:A,deliveryConfirmDeadline:q,disputeWindowEndsAt:h,pendingValorAmount:I,verificationCodeUsed:!0,receiverPhotos:n}}),await l.default.activityFeed.create({data:{type:"product_delivered",userId:y.requesterId,userName:y.requester.name,productId:y.productId,productTitle:y.product.title,targetUserId:y.ownerId,targetUserName:y.owner.name,city:"Ä°zmir",metadata:JSON.stringify({swapRequestId:y.id,valorAmount:I,photosCount:n.length,verificationUsed:!0})}}),(0,c.LX)(y.ownerId,c.j_.SWAP_COMPLETED,{productTitle:y.product.title,valorAmount:I,swapId:y.id}).catch(e=>console.error("Push notification error:",e)),o.NextResponse.json({success:!0,message:"Teslimat baÅŸarÄ±yla tamamlandÄ±! âœ…",swapRequestId:y.id,product:y.product,deliveredAt:A.toISOString(),confirmDeadline:q.toISOString(),disputeWindowEndsAt:h.toISOString(),disputeWindowHours:p.kg,pendingValorAmount:I,verification:{codeVerified:!0,photosUploaded:n.length,senderPhotosCount:y.senderPhotos?.length||0},instructions:["Teslimat baÅŸarÄ±yla tamamlandÄ±!",`${p.kg} saat i\xe7inde sorun bildirmezseniz takas otomatik onaylanÄ±r`,"SatÄ±cÄ±ya Valor puanÄ± aktarÄ±lacak"]})}catch(e){return console.error("QR scan error:",e),o.NextResponse.json({error:"QR kod taranamadÄ±"},{status:500})}}let k=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/swap-requests/scan/route",pathname:"/api/swap-requests/scan",filename:"route",bundlePath:"app/api/swap-requests/scan/route"},resolvedPagePath:"/home/ubuntu/takas-a-kodlar/nextjs_space/app/api/swap-requests/scan/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:v,staticGenerationAsyncStorage:y,serverHooks:w}=k,R="/api/swap-requests/scan/route";function A(){return(0,s.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:y})}},11826:(e,r,t)=>{t.d(r,{L:()=>l});var a=t(66291),i=t(64617),n=t(3390),s=t.n(n),o=t(83178),d=t(59521);let l={adapter:(0,i.N)(o.default),providers:[(0,a.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e,r){if(!e?.email||!e?.password)return null;let t=r?.headers?.["x-real-ip"],a=r?.headers?.["x-forwarded-for"],i=t?Array.isArray(t)?t[0]:t:a&&(Array.isArray(a)?a[0]:a).split(",").pop()?.trim()||"unknown",n=r?.headers?.["user-agent"]||"unknown";if(!(await (0,d.d5)(i,e.email)).allowed)throw await (0,d.Ky)(e.email,i,5,void 0),Error("ACCOUNT_LOCKED");let l=await o.default.user.findUnique({where:{email:e.email}});return l?await s().compare(e.password,l.password)?(await (0,d.LW)(i,l.id,l.email,n),await o.default.user.update({where:{id:l.id},data:{lastLoginAt:new Date}}),{id:l.id,email:l.email,name:l.name,role:l.role}):(await (0,d.Vm)(i,e.email,n,"Invalid password"),null):(await (0,d.Vm)(i,e.email,n,"User not found"),null)}})],session:{strategy:"jwt",maxAge:86400,updateAge:300},jwt:{maxAge:86400},callbacks:{jwt:async({token:e,user:r})=>(r&&(e.id=r.id,e.role=r.role),e),session:async({session:e,token:r})=>(e?.user&&(e.user.id=r?.id,e.user.role=r?.role),e)},pages:{signIn:"/giris"},secret:process.env.NEXTAUTH_SECRET,cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}}}},68247:(e,r,t)=>{t.d(r,{AN:()=>u,F6:()=>o,Qi:()=>i,Sq:()=>d,kg:()=>a,nk:()=>l,u2:()=>c,uF:()=>p});let a=parseInt(process.env.DISPUTE_WINDOW_HOURS||"48"),i=(parseInt(process.env.LOCK_TIMEOUT_HOURS||"48"),parseInt(process.env.QR_CODE_VALIDITY_HOURS||"72"),parseInt(process.env.VERIFICATION_CODE_VALIDITY_HOURS||"24"),"false"!==process.env.AUTO_COMPLETE_LOW_RISK),n=(parseInt(process.env.AUTO_COMPLETE_DELAY_HOURS||"0"),parseFloat(process.env.PREMIUM_RATE_BASE||"0.015"),parseFloat(process.env.PREMIUM_RATE_MIN||"0.01"),parseFloat(process.env.PREMIUM_RATE_MAX||"0.03"),parseFloat(process.env.TARGET_RESERVE_RATIO_30D||"0.05"),parseFloat(process.env.POOL_REBALANCE_STEP||"0.0025"),{LOW_MAX:parseInt(process.env.RISK_LOW_MAX||"100"),MEDIUM_MAX:parseInt(process.env.RISK_MEDIUM_MAX||"500")}),s={Elektronik:1.5,Bilgisayar:1.5,Telefon:1.5,"Oyun Konsolu":1.3,MÃ¼cevher:2,Saat:1.5,Antika:2,Sanat:2,default:1},o={PENDING:"pending",ACCEPTED:"accepted",REJECTED:"rejected",IN_DELIVERY:"in_delivery",DELIVERED:"delivered",COMPLETED:"completed",CANCELLED:"cancelled",DISPUTED:"disputed",RESOLVED:"resolved"},d={pending:["accepted","rejected","cancelled"],accepted:["in_delivery","delivered","completed","cancelled","disputed"],rejected:[],in_delivery:["delivered","disputed"],delivered:["completed","disputed"],completed:[],cancelled:[],disputed:["resolved","completed","cancelled"],resolved:["completed","cancelled"]};function l(e,r){let t=e*(r?s[r]||s.default:1);return t<=n.LOW_MAX?"low":t<=n.MEDIUM_MAX?"medium":"high"}function u(e){let r=new Date(e);return r.setHours(r.getHours()+a),r}let c={completedSwap:2,positiveReview:1,negativeReview:-5,disputeLost:-10,cancelledByUser:-3,noShow:-15,fakeProduct:-25,reportedAbuse:-20,phoneVerification:5,identityVerification:5,accountAgePerMonth:0};function p(e,r){return Math.max(0,Math.min(100,e+r))}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[8412,7609,3390,1472,7853,9521,9628],()=>t(28833));module.exports=a})();