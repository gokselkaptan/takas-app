"use strict";(()=>{var e={};e.id=3972,e.ids=[3972],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},71083:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>R,patchFetch:()=>S,requestAsyncStorage:()=>k,routeModule:()=>A,serverHooks:()=>E,staticGenerationAsyncStorage:()=>v});var s={};r.r(s),r.d(s,{GET:()=>x,POST:()=>q,dynamic:()=>w});var a=r(79182),i=r(72007),o=r(56719),n=r(93442),u=r(57978),l=r(83178),d=r(11826),p=r(30855),c=r(59628),m=r(68247);let w="force-dynamic",f=process.env.CRON_SECRET;async function x(e){try{let{searchParams:t}=new URL(e.url),r=t.get("secret");if(f&&r!==f){let e=await (0,u.getServerSession)(d.L);if(!e?.user?.email)return n.NextResponse.json({error:"Yetkisiz erişim"},{status:401});let t=await l.default.user.findUnique({where:{email:e.user.email}});if(!t||"admin"!==t.role)return n.NextResponse.json({error:"Sadece admin erişebilir"},{status:403})}let s=await g();return n.NextResponse.json({success:!0,...s,timestamp:new Date().toISOString()})}catch(e){return console.error("Auto-complete error:",e),n.NextResponse.json({error:"Auto-complete işlemi başarısız"},{status:500})}}async function q(e){try{let t=await (0,u.getServerSession)(d.L);if(!t?.user?.email)return n.NextResponse.json({error:"Giriş yapmalısınız"},{status:401});let r=await l.default.user.findUnique({where:{email:t.user.email}});if(!r||"admin"!==r.role)return n.NextResponse.json({error:"Sadece admin erişebilir"},{status:403});let{swapId:s,force:a}=await e.json().catch(()=>({}));if(s){let e=await h(s,a);return n.NextResponse.json(e)}let i=await g();return n.NextResponse.json({success:!0,...i,triggeredBy:r.email,timestamp:new Date().toISOString()})}catch(e){return console.error("Manual auto-complete error:",e),n.NextResponse.json({error:"Auto-complete işlemi başarısız"},{status:500})}}async function g(){let e=new Date,t=await l.default.swapRequest.findMany({where:{status:m.F6.DELIVERED,disputeWindowEndsAt:{lte:e},disputes:{none:{}}},include:{product:{include:{category:!0}},owner:{select:{id:!0,name:!0,email:!0}},requester:{select:{id:!0,name:!0,email:!0}}},take:100});console.log(`[Auto-Complete] ${t.length} takas auto-complete i\xe7in uygun`);let r={processed:0,completed:0,skipped:0,errors:0,details:[]};for(let e of t){r.processed++;try{let t=e.riskTier||(0,m.nk)(e.product.valorPrice,e.product.category?.name);if("low"!==t&&!m.Qi){r.skipped++,r.details.push({swapId:e.id,status:"skipped",reason:`Risk seviyesi y\xfcksek (${t}), manuel onay gerekli`});continue}await y(e),r.completed++,r.details.push({swapId:e.id,status:"completed",productTitle:e.product.title,valorAmount:e.pendingValorAmount})}catch(t){r.errors++,r.details.push({swapId:e.id,status:"error",error:t instanceof Error?t.message:"Bilinmeyen hata"}),console.error(`[Auto-Complete] Swap ${e.id} error:`,t)}}return await l.default.activityFeed.create({data:{type:"auto_complete_batch",userId:"system",userName:"Sistem",productId:null,productTitle:`${r.completed} takas otomatik tamamlandı`,city:"Sistem",metadata:JSON.stringify(r)}}),r}async function y(e){let t=new Date,r=e.pendingValorAmount||e.product.valorPrice;await l.default.swapRequest.update({where:{id:e.id},data:{status:m.F6.COMPLETED,receiverConfirmed:!0,receiverConfirmedAt:t,ownerConfirmed:!0,ownerConfirmedAt:t,valorReleased:!0,autoCompleteEligible:!1}});try{await (0,p.F1)(e.id)}catch(t){console.error(`[Auto-Complete] Escrow release error for ${e.id}:`,t)}await l.default.valorTransaction.create({data:{type:"auto_complete_release",amount:r,fee:0,netAmount:r,description:`Otomatik tamamlama - ${e.product.title}`,swapRequestId:e.id,toUserId:e.ownerId}}),await l.default.user.update({where:{id:e.ownerId},data:{valorBalance:{increment:r}}});let s=[(0,c.LX)(e.ownerId,c.j_.SWAP_COMPLETED,{productTitle:e.product.title,valorAmount:r,swapId:e.id}),(0,c.LX)(e.requesterId,c.j_.SWAP_COMPLETED,{productTitle:e.product.title,valorAmount:r,swapId:e.id})];await Promise.allSettled(s),console.log(`[Auto-Complete] Swap ${e.id} completed - ${r} VALOR released to ${e.owner.email}`)}async function h(e,t=!1){let r=await l.default.swapRequest.findUnique({where:{id:e},include:{product:{include:{category:!0}},owner:{select:{id:!0,name:!0,email:!0}},requester:{select:{id:!0,name:!0,email:!0}},disputes:{where:{status:{not:"resolved"}}}}});if(!r)return{success:!1,error:"Takas bulunamadı"};if(r.status!==m.F6.DELIVERED&&!t)return{success:!1,error:`Takas durumu: ${r.status}. Sadece 'delivered' durumundaki takaslar tamamlanabilir.`,currentStatus:r.status};if(r.disputes.length>0&&!t)return{success:!1,error:"A\xe7ık dispute var. Force parametresi ile zorla tamamlayabilirsiniz.",openDisputes:r.disputes.length};if(!t&&r.disputeWindowEndsAt&&new Date<r.disputeWindowEndsAt){let e=Math.ceil((r.disputeWindowEndsAt.getTime()-Date.now())/36e5);return{success:!1,error:`Dispute window hen\xfcz bitmedi. ${e} saat kaldı.`,disputeWindowEndsAt:r.disputeWindowEndsAt,remainingHours:e}}return await y(r),{success:!0,message:"Takas manuel olarak tamamlandı",swapId:r.id,productTitle:r.product.title,valorAmount:r.pendingValorAmount||r.product.valorPrice,forced:t}}let A=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/swap-requests/auto-complete/route",pathname:"/api/swap-requests/auto-complete",filename:"route",bundlePath:"app/api/swap-requests/auto-complete/route"},resolvedPagePath:"/home/ubuntu/takas-a-kodlar/nextjs_space/app/api/swap-requests/auto-complete/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:k,staticGenerationAsyncStorage:v,serverHooks:E}=A,R="/api/swap-requests/auto-complete/route";function S(){return(0,o.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:v})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8412,7609,3390,1472,7853,9521,9628,8373],()=>r(71083));module.exports=s})();