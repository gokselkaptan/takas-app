"use strict";(()=>{var e={};e.id=211,e.ids=[211],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},13102:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>g,patchFetch:()=>f,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>h,staticGenerationAsyncStorage:()=>w});var r={};a.r(r),a.d(r,{GET:()=>c,POST:()=>d});var n=a(79182),s=a(72007),i=a(56719),o=a(93442),u=a(83178),l=a(59628);async function d(e){try{let t=e.headers.get("authorization"),a=process.env.CRON_SECRET;if(a&&t!==`Bearer ${a}`&&a)return o.NextResponse.json({error:"Unauthorized"},{status:401});let r=new Date,n=new Date(r.getTime()-864e5),s=["pending","accepted","awaiting_delivery"],i=new Date(r.getTime()-648e5),d=new Date(r.getTime()-72e6),c=await u.default.swapRequest.findMany({where:{status:{in:s},updatedAt:{gte:d,lt:i}},include:{product:!0,owner:!0,requester:!0}}),p=[],m=0;for(let e of c){let t,a;let n=Math.ceil((e.updatedAt.getTime()+864e5-r.getTime())/36e5),s=`âš ï¸ "${e.product.title}" takasÄ±nÄ±z i\xe7in ${n} saat kaldÄ±! Ä°ÅŸlem yapmazsanÄ±z otomatik iptal edilecek.`;"pending"===e.status?(t=e.ownerId,a="Teklifi kabul veya reddedin."):"accepted"===e.status?(t=e.requesterId,a="Teslimat detaylarÄ±nÄ± ayarlayÄ±n."):(t=e.ownerId,a="Teslimat noktasÄ±na gelin.");try{await (0,l.LX)(t,l.j_.SYSTEM,{title:`â° Son ${n} Saat!`,body:`${s} ${a}`,url:"/takaslarim"}),m++,p.push(`ðŸ“¢ HatÄ±rlatma g\xf6nderildi: ${e.product.title} (${e.status}, ${n}h kaldÄ±)`),"awaiting_delivery"===e.status&&(await (0,l.LX)(e.requesterId,l.j_.SYSTEM,{title:`â° Son ${n} Saat!`,body:`${s} Teslimat noktasÄ±na gelin.`,url:"/takaslarim"}),m++)}catch(t){p.push(`âŒ HatÄ±rlatma g\xf6nderilemedi: ${e.id}`)}}let w=await u.default.swapRequest.findMany({where:{status:{in:s},updatedAt:{lt:n}},include:{product:!0,owner:!0,requester:!0}}),h=w.length,g=[],f=0;for(let e of w)try{let t=e.status,a=0;if(await u.default.swapRequest.update({where:{id:e.id},data:{status:"cancelled"}}),await u.default.product.update({where:{id:e.productId},data:{status:"active"}}),e.pendingValorAmount&&e.pendingValorAmount>0&&(await u.default.user.update({where:{id:e.requesterId},data:{valorBalance:{increment:e.pendingValorAmount}}}),await u.default.valorTransaction.create({data:{type:"escrow_refund",amount:e.pendingValorAmount,fee:0,netAmount:e.pendingValorAmount,description:`Zaman aÅŸÄ±mÄ± - Takas iadesi (${e.product.title})`,toUserId:e.requesterId}}),a+=e.pendingValorAmount,g.push(`ðŸ’° ${e.pendingValorAmount} Valor â†’ ${e.requester.email} (alÄ±cÄ±)`)),["accepted","awaiting_delivery"].includes(t)){let t=e.product.valorPrice||0;t>0&&(await u.default.user.update({where:{id:e.ownerId},data:{valorBalance:{increment:t}}}),await u.default.valorTransaction.create({data:{type:"escrow_refund",amount:t,fee:0,netAmount:t,description:`Zaman aÅŸÄ±mÄ± - Teminat iadesi (${e.product.title})`,toUserId:e.ownerId}}),a+=t,g.push(`ðŸ’° ${t} Valor â†’ ${e.owner.email} (satÄ±cÄ±)`))}f+=a;let r=`TakasÄ±nÄ±z zaman aÅŸÄ±mÄ±na uÄŸradÄ± ve otomatik iptal edildi. "${e.product.title}" i\xe7in Valor bakiyenize iade edildi.`;try{await (0,l.LX)(e.requesterId,l.j_.SYSTEM,{title:"Takas Zaman AÅŸÄ±mÄ± â°",body:r,url:"/takaslarim"})}catch(e){}try{await (0,l.LX)(e.ownerId,l.j_.SYSTEM,{title:"Takas Zaman AÅŸÄ±mÄ± â°",body:r,url:"/takaslarim"})}catch(e){}g.push(`âœ… Ä°ptal: ${e.product.title} (${t}) - ${a} Valor iade`)}catch(t){g.push(`âŒ Hata: ${e.id} - ${t.message}`)}let y=["",`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`,`[AUTO-CANCEL CRON] ${r.toISOString()}`,`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`,`ðŸ“Š \xd6ZET:`,`   â€¢ Ä°ptal edilen takas sayÄ±sÄ±: ${h}`,`   â€¢ Ä°ade edilen toplam Valor: ${f}`,`   â€¢ G\xf6nderilen hatÄ±rlatma: ${m}`,`   â€¢ YakÄ±nda dolacak (4-6h): ${c.length}`,""];return p.length>0&&(y.push(`ðŸ“¢ HATIRLATMALAR:`),p.forEach(e=>y.push(`   ${e}`)),y.push("")),g.length>0&&(y.push(`ðŸ”„ Ä°PTAL Ä°ÅžLEMLERÄ°:`),g.forEach(e=>y.push(`   ${e}`)),y.push("")),y.push(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`),console.log(y.join("\n")),o.NextResponse.json({success:!0,summary:{cancelledCount:h,totalRefundedValor:f,remindersSent:m,soonExpiringCount:c.length},details:{reminders:p,cancellations:g},timestamp:r.toISOString()})}catch(e){return console.error("[AUTO-CANCEL ERROR]",e),o.NextResponse.json({error:"Ä°ptal iÅŸlemi baÅŸarÄ±sÄ±z: "+e.message},{status:500})}}async function c(){try{let e=new Date,t=new Date(e.getTime()-864e5),a=["pending","accepted","awaiting_delivery"],r=await Promise.all(a.map(async e=>{let a=await u.default.swapRequest.count({where:{status:e,updatedAt:{lt:t}}});return{status:e,count:a}})),n=r.reduce((e,t)=>e+t.count,0),s=new Date(t.getTime()+144e5),i=await u.default.swapRequest.count({where:{status:{in:a},updatedAt:{gte:t,lt:s}}}),l=await u.default.swapRequest.count({where:{status:{in:a},updatedAt:{gte:t}}});return o.NextResponse.json({expiredCount:n,expiredByStatus:r,soonExpiring:i,activeSwaps:l,statusesChecked:a,timestamp:e.toISOString()})}catch(e){return o.NextResponse.json({error:e.message},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/swap-requests/auto-cancel/route",pathname:"/api/swap-requests/auto-cancel",filename:"route",bundlePath:"app/api/swap-requests/auto-cancel/route"},resolvedPagePath:"/home/ubuntu/takas-a-kodlar/nextjs_space/app/api/swap-requests/auto-cancel/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:w,serverHooks:h}=p,g="/api/swap-requests/auto-cancel/route";function f(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:w})}},83178:(e,t,a)=>{a.r(t),a.d(t,{default:()=>u});var r=a(53524);let n=globalThis,s="phase-production-build"===process.env.NEXT_PHASE||!0,i=n.prisma??(()=>{let e=new r.PrismaClient({log:["error"],datasources:{db:{url:function(){let e=process.env.DATABASE_URL||"";if(e.includes("connection_limit")||e.includes("pool_timeout"))return e;let t=e.includes("?")?"&":"?";return`${e}${t}connection_limit=${s?1:5}&pool_timeout=${s?60:10}&connect_timeout=5&socket_timeout=10&pgbouncer=true&statement_cache_size=0`}()}}});return e.$use(async(t,a)=>{let r=0;for(;r<=5;)try{let e=await a(t);return n.lastConnectTime=Date.now(),e}catch(a){let t=a instanceof Error?a.message:String(a);if((t.includes("idle-session timeout")||t.includes("terminating connection")||t.includes("ECONNRESET")||t.includes("Connection refused")||t.includes("connection closed")||t.includes("socket")||t.includes("ETIMEDOUT")||t.includes("connection timed out")||t.includes("prepared statement"))&&r<5){if(r++,console.log(`[Prisma] Connection error, retry ${r}/5: ${t.substring(0,100)}`),r>=2)try{await e.$disconnect(),await e.$connect(),console.log("[Prisma] Reconnected successfully")}catch{}await new Promise(e=>setTimeout(e,100*Math.pow(2,r-1)));continue}throw a}}),e})();n.prisma=i,"undefined"!=typeof process&&process.on("beforeExit",async()=>{await i.$disconnect()});let o=null;"undefined"==typeof process||s||!o&&(s||(o=setInterval(async()=>{try{await i.$queryRaw`SELECT 1`}catch(e){console.warn("[Prisma KeepAlive] BaÄŸlantÄ± hatasÄ±, yeniden baÄŸlanÄ±lÄ±yor:",e.message?.substring(0,80));try{await i.$connect(),console.log("[Prisma KeepAlive] Yeniden baÄŸlantÄ± baÅŸarÄ±lÄ±")}catch(e){console.error("[Prisma KeepAlive] Yeniden baÄŸlantÄ± baÅŸarÄ±sÄ±z!")}}},6e4)).unref());let u=i}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8412,7609,7853,9628],()=>a(13102));module.exports=r})();