"use strict";(()=>{var e={};e.id=6029,e.ids=[6029],e.modules={21841:e=>{e.exports=require("@aws-sdk/client-s3")},53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},93977:e=>{e.exports=require("node:fs/promises")},90148:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>k,patchFetch:()=>y,requestAsyncStorage:()=>w,routeModule:()=>m,serverHooks:()=>x,staticGenerationAsyncStorage:()=>f});var r={};a.r(r),a.d(r,{POST:()=>c,dynamic:()=>p});var s=a(79182),i=a(72007),d=a(56719),n=a(93442),o=a(57978),u=a(83178),l=a(11826);let p="force-dynamic";async function c(e){try{let t=await (0,o.getServerSession)(l.L);if(!t?.user?.email)return n.NextResponse.json({error:"Oturum a\xe7manÄ±z gerekiyor"},{status:401});let r=await u.default.user.findUnique({where:{email:t.user.email},select:{id:!0,name:!0}});if(!r)return n.NextResponse.json({error:"KullanÄ±cÄ± bulunamadÄ±"},{status:401});let s=await e.json(),{swapId:i,action:d}=s;if(!i||!d)return n.NextResponse.json({error:"swapId ve action gerekli"},{status:400});let p=await u.default.swapRequest.findUnique({where:{id:i},include:{product:{select:{id:!0,title:!0}},owner:{select:{id:!0,name:!0,email:!0}},requester:{select:{id:!0,name:!0,email:!0}}}});if(!p)return n.NextResponse.json({error:"Takas bulunamadÄ±"},{status:404});let c=p.ownerId===r.id,m=p.requesterId===r.id;if(!c&&!m)return n.NextResponse.json({error:"Bu takasa eriÅŸim yetkiniz yok"},{status:403});if("request_mutual_cancel"===d){let{cancelReason:e,cancelNote:t}=s;if(!e)return n.NextResponse.json({error:"Ä°ptal sebebi gerekli"},{status:400});await u.default.swapRequest.update({where:{id:i},data:{status:"cancel_requested"}}),await u.default.swapStatusLog.create({data:{swapRequestId:i,fromStatus:p.status,toStatus:"cancel_requested",changedBy:r.id,reason:`MUTUAL_CANCEL_REQUEST|${e}|${t||""}`}});let a=c?p.requesterId:p.ownerId;return await u.default.message.create({data:{senderId:r.id,receiverId:a,productId:p.productId,content:`âš ï¸ TAKAS Ä°PTAL TALEBÄ°

${r.name||"KullanÄ±cÄ±"} takasÄ± karÅŸÄ±lÄ±klÄ± iptal etmek istiyor.

ðŸ“‹ Sebep: ${e}
${t?`ðŸ“ Not: ${t}`:""}

âœ… Kabul ederseniz takas iptal edilir, iki tarafÄ±n da g\xfcven puanÄ± D\xdcÅžMEZ.
âŒ Reddederseniz takas devam eder.`,isModerated:!0,moderationResult:"approved",metadata:JSON.stringify({type:"cancel_request",swapRequestId:p.id})}}),n.NextResponse.json({success:!0,message:"Ä°ptal talebi g\xf6nderildi. KarÅŸÄ± tarafÄ±n onayÄ± bekleniyor."})}if("accept_mutual_cancel"===d){if("cancel_requested"!==p.status)return n.NextResponse.json({error:"Ä°ptal talebi bulunamadÄ±"},{status:400});let e=await u.default.swapStatusLog.findFirst({where:{swapRequestId:i,toStatus:"cancel_requested",reason:{startsWith:"MUTUAL_CANCEL_REQUEST"}},orderBy:{createdAt:"desc"}});if(e?.changedBy===r.id)return n.NextResponse.json({error:"Kendi talebinizi onaylayamazsÄ±nÄ±z"},{status:400});p.requesterDeposit&&await u.default.user.update({where:{id:p.requesterId},data:{lockedValor:{decrement:p.requesterDeposit}}}),p.ownerDeposit&&await u.default.user.update({where:{id:p.ownerId},data:{lockedValor:{decrement:p.ownerDeposit}}}),await u.default.product.update({where:{id:p.productId},data:{status:"active"}}),await u.default.swapRequest.update({where:{id:i},data:{status:"cancelled_mutual",escrowStatus:"refunded"}});let t=`âœ… TAKAS KARÅžILIKLI Ä°PTAL EDÄ°LDÄ°

Her iki taraf da iptal konusunda anlaÅŸtÄ±.
ðŸ›¡ï¸ G\xfcven puanÄ±nÄ±z ETKÄ°LENMEDÄ°.
ðŸ’° TeminatÄ±nÄ±z iade edildi.

Takas: "${p.product.title}"`;return await u.default.message.createMany({data:[{senderId:"system",receiverId:p.requesterId,productId:p.productId,content:t,isModerated:!0,moderationResult:"approved"},{senderId:"system",receiverId:p.ownerId,productId:p.productId,content:t,isModerated:!0,moderationResult:"approved"}]}),n.NextResponse.json({success:!0,message:"Takas karÅŸÄ±lÄ±klÄ± iptal edildi. G\xfcven puanlarÄ± etkilenmedi."})}if("reject_mutual_cancel"===d){if("cancel_requested"!==p.status)return n.NextResponse.json({error:"Ä°ptal talebi bulunamadÄ±"},{status:400});await u.default.swapRequest.update({where:{id:i},data:{status:"qr_scanned"}});let e=c?p.requesterId:p.ownerId;return await u.default.message.create({data:{senderId:r.id,receiverId:e,productId:p.productId,content:`âŒ Ä°ptal talebi reddedildi. Takas devam ediyor.`,isModerated:!0,moderationResult:"approved"}}),n.NextResponse.json({success:!0,message:"Ä°ptal talebi reddedildi, takas devam ediyor."})}if("open_dispute"===d){let{disputeType:e,disputeDescription:t,evidencePhotos:a}=s;if(!e||!t)return n.NextResponse.json({error:"AnlaÅŸmazlÄ±k t\xfcr\xfc ve a\xe7Ä±klama gerekli"},{status:400});let d=await u.default.disputeReport.create({data:{swapRequestId:i,reporterId:r.id,reportedUserId:m?p.ownerId:p.requesterId,type:e,description:t,evidence:a||[],status:"open",evidenceDeadline:new Date(Date.now()+1728e5)}});await u.default.swapRequest.update({where:{id:i},data:{status:"disputed"}});let o=c?p.requesterId:p.ownerId;return await u.default.message.create({data:{senderId:"system",receiverId:o,productId:p.productId,content:`âš ï¸ ANLAÅžMAZLIK BÄ°LDÄ°RÄ°MÄ°

"${p.product.title}" takasÄ± i\xe7in anlaÅŸmazlÄ±k bildirildi.

ðŸ“‹ T\xfcr: ${e}
ðŸ“ A\xe7Ä±klama: ${t}

ðŸ“¸ 48 saat i\xe7inde fotoÄŸraflÄ± kanÄ±t sunmanÄ±z gerekmektedir.
TakaslarÄ±m sayfasÄ±ndan kanÄ±tlarÄ±nÄ±zÄ± y\xfckleyebilirsiniz.

âš–ï¸ AI ve Admin incelemesinden sonra karar bildirilecektir.`,isModerated:!0,moderationResult:"approved"}}),await u.default.message.create({data:{senderId:"system",receiverId:"admin",productId:p.productId,content:`ðŸ”´ YENÄ° ANLAÅžMAZLIK

Takas: ${p.product.title}
Bildiren: ${r.name}
T\xfcr: ${e}
A\xe7Ä±klama: ${t}
KanÄ±t: ${(a||[]).length} fotoÄŸraf`,isModerated:!0,moderationResult:"approved"}}),n.NextResponse.json({success:!0,disputeId:d.id,message:"AnlaÅŸmazlÄ±k bildirildi. 48 saat i\xe7inde incelenecek."})}if("submit_dispute_evidence"===d){let{disputeId:e,evidencePhotos:t,evidenceNote:a}=s;if(!e)return n.NextResponse.json({error:"disputeId gerekli"},{status:400});let i=await u.default.disputeReport.findUnique({where:{id:e}});if(!i)return n.NextResponse.json({error:"AnlaÅŸmazlÄ±k bulunamadÄ±"},{status:404});if(i.reportedUserId!==r.id)return n.NextResponse.json({error:"Sadece raporlanan taraf kanÄ±t y\xfckleyebilir"},{status:403});return await u.default.disputeReport.update({where:{id:e},data:{reportedEvidence:t||[],reportedEvidenceAt:new Date,reportedEvidenceNote:a||"",status:"evidence_submitted"}}),n.NextResponse.json({success:!0,message:"KanÄ±tlar y\xfcklendi. Ä°nceleme baÅŸlayacak."})}if("upload_step_photo"===d){let{stepType:e,base64Photo:t}=s;if(!e||!t)return n.NextResponse.json({error:"FotoÄŸraf ve adÄ±m tipi gerekli"},{status:400});let{PutObjectCommand:r}=await Promise.resolve().then(a.t.bind(a,21841,23)),{createS3Client:d,getBucketConfig:o}=await a.e(4891).then(a.bind(a,94891)),l=t.replace(/^data:image\/\w+;base64,/,""),c=Buffer.from(l,"base64"),{bucketName:m,folderPrefix:w}=o(),f=`${w}public/uploads/swap-evidence/${i}/${e}-${Date.now()}.jpg`,x=d();await x.send(new r({Bucket:m,Key:f,Body:c,ContentType:"image/jpeg"}));let k="packaged"===e?"senderPhotos":"received"===e?"receiverPhotos":"senderPhotos",y=p[k]||[];await u.default.swapRequest.update({where:{id:i},data:{[k]:[...y,f]}});let{getFileUrl:q}=await Promise.all([a.e(4105),a.e(3455)]).then(a.bind(a,43455)),g=await q(f,!0);return n.NextResponse.json({success:!0,photoUrl:g,message:"FotoÄŸraf y\xfcklendi"})}return n.NextResponse.json({error:"Ge\xe7ersiz aksiyon"},{status:400})}catch(e){return console.error("Delivery agreement error:",e),n.NextResponse.json({error:"Ä°ÅŸlem sÄ±rasÄ±nda bir hata oluÅŸtu"},{status:500})}}let m=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/swap-requests/delivery-agreement/route",pathname:"/api/swap-requests/delivery-agreement",filename:"route",bundlePath:"app/api/swap-requests/delivery-agreement/route"},resolvedPagePath:"/home/ubuntu/takas-a-kodlar/nextjs_space/app/api/swap-requests/delivery-agreement/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:w,staticGenerationAsyncStorage:f,serverHooks:x}=m,k="/api/swap-requests/delivery-agreement/route";function y(){return(0,d.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:f})}},11826:(e,t,a)=>{a.d(t,{L:()=>u});var r=a(66291),s=a(64617),i=a(3390),d=a.n(i),n=a(83178),o=a(59521);let u={adapter:(0,s.N)(n.default),providers:[(0,r.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e,t){if(!e?.email||!e?.password)return null;let a=t?.headers?.["x-real-ip"],r=t?.headers?.["x-forwarded-for"],s=a?Array.isArray(a)?a[0]:a:r&&(Array.isArray(r)?r[0]:r).split(",").pop()?.trim()||"unknown",i=t?.headers?.["user-agent"]||"unknown";if(!(await (0,o.d5)(s,e.email)).allowed)throw await (0,o.Ky)(e.email,s,5,void 0),Error("ACCOUNT_LOCKED");let u=await n.default.user.findUnique({where:{email:e.email}});return u?await d().compare(e.password,u.password)?(await (0,o.LW)(s,u.id,u.email,i),await n.default.user.update({where:{id:u.id},data:{lastLoginAt:new Date}}),{id:u.id,email:u.email,name:u.name,role:u.role}):(await (0,o.Vm)(s,e.email,i,"Invalid password"),null):(await (0,o.Vm)(s,e.email,i,"User not found"),null)}})],session:{strategy:"jwt",maxAge:86400,updateAge:300},jwt:{maxAge:86400},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.role=t.role),e),session:async({session:e,token:t})=>(e?.user&&(e.user.id=t?.id,e.user.role=t?.role),e)},pages:{signIn:"/giris"},secret:process.env.NEXTAUTH_SECRET,cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8412,7609,3390,1472,9521],()=>a(90148));module.exports=r})();