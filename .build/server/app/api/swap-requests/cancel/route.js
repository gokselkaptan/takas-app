"use strict";(()=>{var e={};e.id=5418,e.ids=[5418],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},21237:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>g,patchFetch:()=>k,requestAsyncStorage:()=>A,routeModule:()=>v,serverHooks:()=>y,staticGenerationAsyncStorage:()=>I});var a={};r.r(a),r.d(a,{CANCELLATION_REASONS:()=>w,GET:()=>x,POST:()=>f,dynamic:()=>m});var s=r(79182),n=r(72007),i=r(56719),o=r(93442),l=r(57978),d=r(83178),u=r(11826),p=r(59628),c=r(68247);let m="force-dynamic",w={changed_mind:"Fikrim deÄŸiÅŸti",found_better_deal:"Daha iyi bir teklif buldum",item_unavailable:"\xdcr\xfcn artÄ±k mevcut deÄŸil",personal_reasons:"KiÅŸisel nedenler",communication_issues:"Ä°letiÅŸim sorunlarÄ± yaÅŸadÄ±m",schedule_conflict:"Zaman uyumsuzluÄŸu",other:"DiÄŸer"},_={after_agreement:c.u2.cancelledByUser};async function f(e){try{let t=await (0,l.getServerSession)(u.L);if(!t?.user?.email)return o.NextResponse.json({error:"GiriÅŸ yapmalÄ±sÄ±nÄ±z"},{status:401});let r=await d.default.user.findUnique({where:{email:t.user.email},select:{id:!0,name:!0,email:!0,trustScore:!0}});if(!r)return o.NextResponse.json({error:"KullanÄ±cÄ± bulunamadÄ±"},{status:404});let{swapId:a,reason:s,customReason:n}=await e.json();if(!a||!s)return o.NextResponse.json({error:"Takas ID ve iptal nedeni gerekli"},{status:400});if(!Object.keys(w).includes(s))return o.NextResponse.json({error:"Ge\xe7ersiz iptal nedeni"},{status:400});let i=await d.default.swapRequest.findUnique({where:{id:a},include:{product:!0,owner:{select:{id:!0,name:!0,email:!0,nickname:!0}},requester:{select:{id:!0,name:!0,email:!0,nickname:!0}}}});if(!i)return o.NextResponse.json({error:"Takas bulunamadÄ±"},{status:404});let m=i.ownerId===r.id,f=i.requesterId===r.id;if(!m&&!f)return o.NextResponse.json({error:"Bu takasÄ± iptal etme yetkiniz yok"},{status:403});if(!["accepted","in_delivery","awaiting_delivery"].includes(i.status)){if("delivered"===i.status)return o.NextResponse.json({error:"Teslimat onaylanmÄ±ÅŸ takaslar iptal edilemez. Ä°tiraz a\xe7mak i\xe7in l\xfctfen destek ile iletiÅŸime ge\xe7in."},{status:400});if("completed"===i.status)return o.NextResponse.json({error:"TamamlanmÄ±ÅŸ takaslar iptal edilemez."},{status:400});if("pending"===i.status)return o.NextResponse.json({error:"Hen\xfcz kabul edilmemiÅŸ teklifleri iptal etmek yerine reddedebilirsiniz."},{status:400});return o.NextResponse.json({error:`Bu durumdaki takaslar iptal edilemez: ${i.status}`},{status:400})}let x="other"===s&&n?n:w[s],v=await d.default.$transaction(async e=>{await e.swapRequest.update({where:{id:a},data:{status:"cancelled"}}),await e.product.update({where:{id:i.productId},data:{status:"available"}});let t=(0,c.uF)(r.trustScore||100,_.after_agreement);await e.user.update({where:{id:r.id},data:{trustScore:t}});let s=0,n=0;i.pendingValorAmount&&i.pendingValorAmount>0&&(await e.user.update({where:{id:i.requesterId},data:{valorBalance:{increment:i.pendingValorAmount},lockedValor:{decrement:Math.min(i.pendingValorAmount,await E(e,i.requesterId))}}}),await e.valorTransaction.create({data:{type:"escrow_refund",amount:i.pendingValorAmount,fee:0,netAmount:i.pendingValorAmount,description:`Manuel iptal - Takas iadesi (${i.product.title})`,toUserId:i.requesterId}}),s=i.pendingValorAmount);let o=Math.round(.1*i.product.valorPrice);o>0&&await E(e,i.ownerId)>=o&&(await e.user.update({where:{id:i.ownerId},data:{lockedValor:{decrement:o}}}),n=o);let l=m?i.requesterId:i.ownerId,d=m?i.owner.name:i.requester.name,u=m?"SatÄ±cÄ±":"AlÄ±cÄ±";return await e.message.create({data:{content:`âš ï¸ ${u} (${d}) takasÄ± iptal etti.

ðŸ“‹ Ä°ptal Nedeni: ${x}

ðŸ”„ "${i.product.title}" i\xe7in yapÄ±lan takas anlaÅŸmasÄ± iptal edilmiÅŸtir. Escrow'daki Valor bakiyenize iade edildi.`,senderId:r.id,receiverId:l,productId:i.productId}}),{refundedToRequester:s,refundedToOwner:n,otherPartyId:l,cancellerRole:u}}),A=m?i.requesterId:i.ownerId;try{await (0,p.LX)(A,p.j_.SWAP_CANCELLED,{productTitle:i.product.title,reason:x})}catch(e){console.error("Push bildirim g\xf6nderilemedi:",e)}return o.NextResponse.json({success:!0,message:"Takas baÅŸarÄ±yla iptal edildi",details:{swapId:a,reason:x,trustPenalty:_.after_agreement,refundedToRequester:v.refundedToRequester,refundedToOwner:v.refundedToOwner}})}catch(e){return console.error("Takas iptal hatasÄ±:",e),o.NextResponse.json({error:"Takas iptal edilemedi: "+e.message},{status:500})}}async function E(e,t){let r=await e.user.findUnique({where:{id:t},select:{lockedValor:!0}});return r?.lockedValor||0}async function x(){return o.NextResponse.json({reasons:w,trustPenalty:_.after_agreement})}let v=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/swap-requests/cancel/route",pathname:"/api/swap-requests/cancel",filename:"route",bundlePath:"app/api/swap-requests/cancel/route"},resolvedPagePath:"/home/ubuntu/takas-a-kodlar/nextjs_space/app/api/swap-requests/cancel/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:A,staticGenerationAsyncStorage:I,serverHooks:y}=v,g="/api/swap-requests/cancel/route";function k(){return(0,i.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:I})}},11826:(e,t,r)=>{r.d(t,{L:()=>d});var a=r(66291),s=r(64617),n=r(3390),i=r.n(n),o=r(83178),l=r(59521);let d={adapter:(0,s.N)(o.default),providers:[(0,a.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e,t){if(!e?.email||!e?.password)return null;let r=t?.headers?.["x-real-ip"],a=t?.headers?.["x-forwarded-for"],s=r?Array.isArray(r)?r[0]:r:a&&(Array.isArray(a)?a[0]:a).split(",").pop()?.trim()||"unknown",n=t?.headers?.["user-agent"]||"unknown";if(!(await (0,l.d5)(s,e.email)).allowed)throw await (0,l.Ky)(e.email,s,5,void 0),Error("ACCOUNT_LOCKED");let d=await o.default.user.findUnique({where:{email:e.email}});return d?await i().compare(e.password,d.password)?(await (0,l.LW)(s,d.id,d.email,n),await o.default.user.update({where:{id:d.id},data:{lastLoginAt:new Date}}),{id:d.id,email:d.email,name:d.name,role:d.role}):(await (0,l.Vm)(s,e.email,n,"Invalid password"),null):(await (0,l.Vm)(s,e.email,n,"User not found"),null)}})],session:{strategy:"jwt",maxAge:86400,updateAge:300},jwt:{maxAge:86400},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.role=t.role),e),session:async({session:e,token:t})=>(e?.user&&(e.user.id=t?.id,e.user.role=t?.role),e)},pages:{signIn:"/giris"},secret:process.env.NEXTAUTH_SECRET,cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}}}},68247:(e,t,r)=>{r.d(t,{AN:()=>u,F6:()=>o,Qi:()=>s,Sq:()=>l,kg:()=>a,nk:()=>d,u2:()=>p,uF:()=>c});let a=parseInt(process.env.DISPUTE_WINDOW_HOURS||"48"),s=(parseInt(process.env.LOCK_TIMEOUT_HOURS||"48"),parseInt(process.env.QR_CODE_VALIDITY_HOURS||"72"),parseInt(process.env.VERIFICATION_CODE_VALIDITY_HOURS||"24"),"false"!==process.env.AUTO_COMPLETE_LOW_RISK),n=(parseInt(process.env.AUTO_COMPLETE_DELAY_HOURS||"0"),parseFloat(process.env.PREMIUM_RATE_BASE||"0.015"),parseFloat(process.env.PREMIUM_RATE_MIN||"0.01"),parseFloat(process.env.PREMIUM_RATE_MAX||"0.03"),parseFloat(process.env.TARGET_RESERVE_RATIO_30D||"0.05"),parseFloat(process.env.POOL_REBALANCE_STEP||"0.0025"),{LOW_MAX:parseInt(process.env.RISK_LOW_MAX||"100"),MEDIUM_MAX:parseInt(process.env.RISK_MEDIUM_MAX||"500")}),i={Elektronik:1.5,Bilgisayar:1.5,Telefon:1.5,"Oyun Konsolu":1.3,MÃ¼cevher:2,Saat:1.5,Antika:2,Sanat:2,default:1},o={PENDING:"pending",ACCEPTED:"accepted",REJECTED:"rejected",IN_DELIVERY:"in_delivery",DELIVERED:"delivered",COMPLETED:"completed",CANCELLED:"cancelled",DISPUTED:"disputed",RESOLVED:"resolved"},l={pending:["accepted","rejected","cancelled"],accepted:["in_delivery","delivered","completed","cancelled","disputed"],rejected:[],in_delivery:["delivered","disputed"],delivered:["completed","disputed"],completed:[],cancelled:[],disputed:["resolved","completed","cancelled"],resolved:["completed","cancelled"]};function d(e,t){let r=e*(t?i[t]||i.default:1);return r<=n.LOW_MAX?"low":r<=n.MEDIUM_MAX?"medium":"high"}function u(e){let t=new Date(e);return t.setHours(t.getHours()+a),t}let p={completedSwap:2,positiveReview:1,negativeReview:-5,disputeLost:-10,cancelledByUser:-3,noShow:-15,fakeProduct:-25,reportedAbuse:-20,phoneVerification:5,identityVerification:5,accountAgePerMonth:0};function c(e,t){return Math.max(0,Math.min(100,e+t))}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8412,7609,3390,1472,7853,9521,9628],()=>r(21237));module.exports=a})();