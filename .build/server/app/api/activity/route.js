"use strict";(()=>{var e={};e.id=2504,e.ids=[2504],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},87607:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>w,patchFetch:()=>A,requestAsyncStorage:()=>g,routeModule:()=>f,serverHooks:()=>M,staticGenerationAsyncStorage:()=>y});var r={};a.r(r),a.d(r,{GET:()=>p,dynamic:()=>c});var n=a(79182),i=a(72007),o=a(56719),l=a(93442),s=a(83178);let c="force-dynamic",u=["Ayşe K.","Mehmet Y.","Zeynep A.","Ali R.","Fatma S.","Emre B.","Deniz T.","Selin M.","Burak \xd6.","Elif D.","Can K.","Merve H.","Oğuz C.","Beren Y.","Cem A.","Esra N.","Kaan T.","Yasemin B.","Onur K.","Pınar S."],d=["Murat K.","Ceren Y.","Kemal A.","Sibel T.","Tolga M.","Aylin D.","Serkan B.","G\xfclay \xd6.","Volkan R.","Neslihan S."];function m(e,t=null,a=0){if(t&&""!==t.trim())return t.trim();if(!e||""===e.trim())return u[a%u.length];let r=e.toLowerCase();return["admin","takas-a","test","kullanıcı","user","system","sistem"].some(e=>r.includes(e))?d[a%d.length]:function(e){if(!e||""===e.trim())return"";let t=e.trim().split(/\s+/).filter(e=>e.length>0);return 0===t.length?"":1===t.length?t[0].charAt(0).toUpperCase()+".":t.map(e=>e.charAt(0).toUpperCase()).join(".")+"."}(e)}async function p(e){try{let{searchParams:t}=new URL(e.url),a=parseInt(t.get("limit")||"10"),r=await s.default.activityFeed.findMany({orderBy:{createdAt:"desc"},take:2*a,select:{id:!0,type:!0,userId:!0,userName:!0,productId:!0,productTitle:!0,targetUserId:!0,targetUserName:!0,targetProductTitle:!0,city:!0,metadata:!0,createdAt:!0}}),n=r.map(e=>e.productId).filter(e=>null!==e),i=await s.default.product.findMany({where:{id:{in:n},status:"active"},select:{id:!0}}),o=new Set(i.map(e=>e.id)),c=r.map(e=>({...e,productId:e.productId&&o.has(e.productId)?e.productId:null})).slice(0,a),u=[...new Set(c.flatMap(e=>[e.userId,e.targetUserId].filter(Boolean)))],d=await s.default.user.findMany({where:{id:{in:u}},select:{id:!0,nickname:!0}}),p=new Map(d.map(e=>[e.id,e.nickname])),f=c.map((e,t)=>({...e,userName:m(e.userName,e.userId?p.get(e.userId)??null:null,t),targetUserName:e.targetUserName?m(e.targetUserName,e.targetUserId?p.get(e.targetUserId)??null:null,t+10):e.targetUserName}));if(f.length<5){let e=await h(5-f.length);return l.NextResponse.json({activities:[...f,...e]})}return l.NextResponse.json({activities:f})}catch(t){console.error("Activity feed error:",t);let e=await h(10);return l.NextResponse.json({activities:e})}}async function h(e){let t=["Ayşe K.","Mehmet Y.","Zeynep A.","Ali R.","Fatma S.","Emre B.","Deniz T.","Selin M.","Burak \xd6.","Elif D.","Can K.","Merve H.","Oğuz C.","Beren Y.","Cem A."],a=["İzmir","Bornova","Karşıyaka","Buca","Konak","Alsancak"],r=[];try{r=await s.default.product.findMany({select:{id:!0,title:!0},take:20,orderBy:{createdAt:"desc"}})}catch(e){console.error("Could not fetch products for simulation:",e)}let n=["iPhone 13","MacBook Air","Vintage Ceket","Kitaplık","Oyun Konsolu","Bisiklet","Kamera","Akıllı Saat","Tablet","Bluetooth Kulaklık","Elektrik S\xfcp\xfcrgesi","Kahve Makinesi","Yoga Matı","Gitar","Bebek Arabası"],i=[],o=Date.now();for(let l=0;l<e;l++){let e;let s=10*Math.random(),c="product_added";s<4?c="swap_completed":s<5&&(c="multi_swap");let u=t[Math.floor(Math.random()*t.length)],d=a[Math.floor(Math.random()*a.length)],m=null;if(r.length>0){let t=r[Math.floor(Math.random()*r.length)];m=t.id,e=t.title}else e=n[Math.floor(Math.random()*n.length)];let p=new Date(o-Math.floor(72e5*Math.random())-3e5*l),h={id:`sim_${l}_${Date.now()}`,type:c,userName:u,productId:m,productTitle:e,city:d,createdAt:p};if("swap_completed"===c||"multi_swap"===c){if(h.targetUserName=t[Math.floor(Math.random()*t.length)],r.length>0){let e=r[Math.floor(Math.random()*r.length)];h.targetProductTitle=e.title}else h.targetProductTitle=n[Math.floor(Math.random()*n.length)];for(;h.targetUserName===u;)h.targetUserName=t[Math.floor(Math.random()*t.length)]}"multi_swap"===c&&(h.metadata=JSON.stringify({participantCount:Math.floor(3*Math.random())+3})),i.push(h)}return i.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())}let f=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/activity/route",pathname:"/api/activity",filename:"route",bundlePath:"app/api/activity/route"},resolvedPagePath:"/home/ubuntu/takas-a-kodlar/nextjs_space/app/api/activity/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:y,serverHooks:M}=f,w="/api/activity/route";function A(){return(0,o.patchFetch)({serverHooks:M,staticGenerationAsyncStorage:y})}},83178:(e,t,a)=>{a.r(t),a.d(t,{default:()=>s});var r=a(53524);let n=globalThis,i="phase-production-build"===process.env.NEXT_PHASE||!0,o=n.prisma??(()=>{let e=new r.PrismaClient({log:["error"],datasources:{db:{url:function(){let e=process.env.DATABASE_URL||"";if(e.includes("connection_limit")||e.includes("pool_timeout"))return e;let t=e.includes("?")?"&":"?";return`${e}${t}connection_limit=${i?1:10}&pool_timeout=${i?60:20}&connect_timeout=10&socket_timeout=20&pgbouncer=true&statement_cache_size=0`}()}}});return e.$use(async(t,a)=>{let r=0;for(;r<=5;)try{let e=await a(t);return n.lastConnectTime=Date.now(),e}catch(a){let t=a instanceof Error?a.message:String(a);if((t.includes("idle-session timeout")||t.includes("terminating connection")||t.includes("ECONNRESET")||t.includes("Connection refused")||t.includes("connection closed")||t.includes("socket")||t.includes("ETIMEDOUT")||t.includes("connection timed out")||t.includes("prepared statement"))&&r<5){if(r++,console.log(`[Prisma] Connection error, retry ${r}/5: ${t.substring(0,100)}`),r>=2)try{await e.$disconnect(),await e.$connect(),console.log("[Prisma] Reconnected successfully")}catch{}await new Promise(e=>setTimeout(e,100*Math.pow(2,r-1)));continue}throw a}}),e})();n.prisma=o,"undefined"!=typeof process&&process.on("beforeExit",async()=>{await o.$disconnect()});let l=null;"undefined"==typeof process||i||!l&&(i||(l=setInterval(async()=>{try{await o.$queryRaw`SELECT 1`}catch(e){console.warn("[Prisma KeepAlive] Bağlantı hatası, yeniden bağlanılıyor:",e.message?.substring(0,80));try{await o.$connect(),console.log("[Prisma KeepAlive] Yeniden bağlantı başarılı")}catch(e){console.error("[Prisma KeepAlive] Yeniden bağlantı başarısız!")}}},12e4)).unref());let s=o}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8412,7609],()=>a(87607));module.exports=r})();