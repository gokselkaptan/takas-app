"use strict";(()=>{var e={};e.id=5223,e.ids=[5223],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},98053:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>h,patchFetch:()=>f,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>w,staticGenerationAsyncStorage:()=>m});var n={};a.r(n),a.d(n,{POST:()=>l,dynamic:()=>u});var r=a(79182),o=a(72007),s=a(56719),i=a(93442),c=a(83178);let u="force-dynamic";async function l(e){let t=e.headers.get("authorization"),a=process.env.CRON_SECRET;if(a&&t!==`Bearer ${a}`)return i.NextResponse.json({error:"Unauthorized"},{status:401});try{let e={date:new Date().toISOString(),userCount:await c.default.user.count(),productCount:await c.default.product.count(),swapCount:await c.default.swapRequest.count(),messageCount:await c.default.message.count(),newUsers24h:await c.default.user.count({where:{createdAt:{gte:new Date(Date.now()-864e5)}}}),newSwaps24h:await c.default.swapRequest.count({where:{createdAt:{gte:new Date(Date.now()-864e5)}}}),errors24h:await c.default.errorLog.count({where:{createdAt:{gte:new Date(Date.now()-864e5)},severity:{in:["error","critical"]}}})};await c.default.errorLog.create({data:{type:"daily_backup_snapshot",message:`Daily snapshot: ${e.userCount} users, ${e.productCount} products, ${e.swapCount} swaps`,severity:"info",metadata:JSON.stringify(e)}});let t=[];return e.errors24h>100&&t.push(`Son 24 saatte ${e.errors24h} hata!`),i.NextResponse.json({success:!0,snapshot:e,warnings:t})}catch(e){return i.NextResponse.json({error:e.message},{status:500})}}let d=new r.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/cron/daily-backup/route",pathname:"/api/cron/daily-backup",filename:"route",bundlePath:"app/api/cron/daily-backup/route"},resolvedPagePath:"/home/ubuntu/takas-a-kodlar/nextjs_space/app/api/cron/daily-backup/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:w}=d,h="/api/cron/daily-backup/route";function f(){return(0,s.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:m})}},83178:(e,t,a)=>{a.r(t),a.d(t,{default:()=>c});var n=a(53524);let r=globalThis,o="phase-production-build"===process.env.NEXT_PHASE||!0,s=r.prisma??(()=>{let e=new n.PrismaClient({log:["error"],datasources:{db:{url:function(){let e=process.env.DATABASE_URL||"";if(e.includes("connection_limit")||e.includes("pool_timeout"))return e;let t=e.includes("?")?"&":"?";return`${e}${t}connection_limit=${o?1:10}&pool_timeout=${o?60:20}&connect_timeout=10&socket_timeout=20&pgbouncer=true&statement_cache_size=0`}()}}});return e.$use(async(t,a)=>{let n=0;for(;n<=5;)try{let e=await a(t);return r.lastConnectTime=Date.now(),e}catch(a){let t=a instanceof Error?a.message:String(a);if((t.includes("idle-session timeout")||t.includes("terminating connection")||t.includes("ECONNRESET")||t.includes("Connection refused")||t.includes("connection closed")||t.includes("socket")||t.includes("ETIMEDOUT")||t.includes("connection timed out")||t.includes("prepared statement"))&&n<5){if(n++,console.log(`[Prisma] Connection error, retry ${n}/5: ${t.substring(0,100)}`),n>=2)try{await e.$disconnect(),await e.$connect(),console.log("[Prisma] Reconnected successfully")}catch{}await new Promise(e=>setTimeout(e,100*Math.pow(2,n-1)));continue}throw a}}),e})();r.prisma=s,"undefined"!=typeof process&&process.on("beforeExit",async()=>{await s.$disconnect()});let i=null;"undefined"==typeof process||o||!i&&(o||(i=setInterval(async()=>{try{await s.$queryRaw`SELECT 1`}catch(e){console.warn("[Prisma KeepAlive] Bağlantı hatası, yeniden bağlanılıyor:",e.message?.substring(0,80));try{await s.$connect(),console.log("[Prisma KeepAlive] Yeniden bağlantı başarılı")}catch(e){console.error("[Prisma KeepAlive] Yeniden bağlantı başarısız!")}}},12e4)).unref());let c=s}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[8412,7609],()=>a(98053));module.exports=n})();