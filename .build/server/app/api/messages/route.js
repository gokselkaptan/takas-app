"use strict";(()=>{var e={};e.id=7217,e.ids=[7217],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},94694:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>h,patchFetch:()=>j,requestAsyncStorage:()=>w,routeModule:()=>k,serverHooks:()=>b,staticGenerationAsyncStorage:()=>v});var a={};t.r(a),t.d(a,{DELETE:()=>x,GET:()=>z,POST:()=>y,dynamic:()=>f});var n=t(79182),i=t(72007),s=t(56719),o=t(93442),l=t(57978),d=t(83178),u=t(11826),c=t(2158),p=t(59628),m=t(81510),g=t(92054);let f="force-dynamic";async function z(e){try{let r=await (0,l.getServerSession)(u.L);if(!r?.user?.email)return o.NextResponse.json({error:"GiriÅŸ yapmalÄ±sÄ±nÄ±z"},{status:401});let t=await d.default.user.findUnique({where:{email:r.user.email}});if(!t)return o.NextResponse.json({error:"KullanÄ±cÄ± bulunamadÄ±"},{status:404});let{searchParams:a}=new URL(e.url),n=a.get("userId"),i=a.get("productId"),s=a.get("unreadOnly");if("true"===s){let e=await d.default.message.count({where:{receiverId:t.id,isRead:!1}});return o.NextResponse.json({unreadCount:e})}if(n&&i){let e=await d.default.message.findMany({where:{productId:i,OR:[{senderId:t.id,receiverId:n},{senderId:n,receiverId:t.id}]},include:{sender:{select:{id:!0,name:!0,image:!0}}},orderBy:{createdAt:"asc"}});return await d.default.message.updateMany({where:{productId:i,senderId:n,receiverId:t.id,isRead:!1},data:{isRead:!0}}),o.NextResponse.json(e)}let c=await d.default.message.findMany({where:{OR:[{senderId:t.id},{receiverId:t.id}]},select:{id:!0,content:!0,createdAt:!0,isRead:!0,senderId:!0,receiverId:!0,productId:!0,sender:{select:{id:!0,name:!0,nickname:!0,image:!0}},receiver:{select:{id:!0,name:!0,nickname:!0,image:!0}},product:{select:{id:!0,title:!0,images:!0}}},orderBy:{createdAt:"desc"},take:500}),p=new Map,m=0,g=0,f=0;for(let e of c){let r=e.senderId===t.id?e.receiver:e.sender,a=`${r.id}-${e.productId||"general"}`;if(p.has(a)||p.set(a,{otherUser:r,product:e.product,lastMessage:{content:e.content,createdAt:e.createdAt,senderId:e.senderId},unreadCount:0}),e.receiverId===t.id){if(m++,e.isRead)g++;else{f++;let e=p.get(a);e&&e.unreadCount++}}}return o.NextResponse.json({conversations:Array.from(p.values()),stats:{totalMessages:m,readMessages:g,unreadMessages:f}})}catch(e){return console.error("Messages fetch error:",e),o.NextResponse.json({error:"Mesajlar y\xfcklenirken hata oluÅŸtu"},{status:500})}}async function y(e){try{let r=await (0,l.getServerSession)(u.L);if(!r?.user?.email)return o.NextResponse.json({error:"GiriÅŸ yapmalÄ±sÄ±nÄ±z"},{status:401});let t=await d.default.user.findUnique({where:{email:r.user.email}});if(!t)return o.NextResponse.json({error:"KullanÄ±cÄ± bulunamadÄ±"},{status:404});let a=await (0,c.LP)(t.id);if(a.isSuspended)return o.NextResponse.json({error:a.reason,suspended:!0,suspendedUntil:a.suspendedUntil},{status:403});let{receiverId:n,content:i,productId:s,location:f,lang:z="tr"}=await e.json();if(i){let{success:e,error:r}=(0,m.Gu)(m.qi,{receiverId:n,content:i,productId:s});if(!e)return o.NextResponse.json({error:r},{status:400})}if(!n||!i&&!f)return o.NextResponse.json({error:"AlÄ±cÄ± ve mesaj i\xe7eriÄŸi veya konum gerekli"},{status:400});if(n===t.id)return o.NextResponse.json({error:"Kendinize mesaj g\xf6nderemezsiniz"},{status:400});if(f&&!i){let e=await d.default.message.create({data:{senderId:t.id,receiverId:n,content:`ðŸ“ Konum paylaÅŸÄ±ldÄ±`,productId:s,isModerated:!0,moderationResult:"approved",metadata:JSON.stringify({type:"location",latitude:f.latitude,longitude:f.longitude,address:f.address||null})},include:{sender:{select:{id:!0,name:!0,image:!0}}}});return(0,p.LX)(n,p.j_.NEW_MESSAGE,{senderName:t.name||"Birisi",preview:"\uD83D\uDCCD Konum paylaÅŸÄ±ldÄ±",conversationId:s||n}).catch(e=>console.error("Push notification error:",e)),o.NextResponse.json({...e,location:{latitude:f.latitude,longitude:f.longitude,address:f.address}})}let y=(0,c._0)(i,z);if("policy_violation"===y.result)return console.log(`[POLICY VIOLATION] User ${t.id} message blocked. Type: ${y.violationType}, Patterns: ${y.detectedPatterns?.join(", ")}`),o.NextResponse.json({error:"policy_violation",blocked:!0,warningMessage:y.warningMessage,violationType:y.violationType,reason:y.reason},{status:422});let x=(0,g.oO)(i),k=await d.default.message.create({data:{senderId:t.id,receiverId:n,content:x,productId:s,isModerated:!0,moderationResult:y.result,moderationReason:y.reason,containsPersonalInfo:y.containsPersonalInfo,metadata:f?JSON.stringify({type:"location",latitude:f.latitude,longitude:f.longitude,address:f.address||null}):void 0},include:{sender:{select:{id:!0,name:!0,image:!0}}}});return(0,p.LX)(n,p.j_.NEW_MESSAGE,{senderName:t.name||"Birisi",preview:x.substring(0,50)+(x.length>50?"...":""),conversationId:s||n}).catch(e=>console.error("Push notification error:",e)),o.NextResponse.json(k)}catch(e){return console.error("Message create error:",e),o.NextResponse.json({error:"Mesaj g\xf6nderilirken hata oluÅŸtu"},{status:500})}}async function x(e){try{let r=await (0,l.getServerSession)(u.L);if(!r?.user?.email)return o.NextResponse.json({error:"GiriÅŸ yapmalÄ±sÄ±nÄ±z"},{status:401});if("join@takas-a.com"!==r.user.email)return o.NextResponse.json({error:"Yetkisiz eriÅŸim"},{status:403});let t=await d.default.user.findUnique({where:{email:r.user.email}});if(!t)return o.NextResponse.json({error:"KullanÄ±cÄ± bulunamadÄ±"},{status:404});let{messageId:a,messageIds:n,conversationUserId:i,productId:s,deleteType:c}=await e.json();if(a){if(!await d.default.message.findFirst({where:{id:a,OR:[{senderId:t.id},{receiverId:t.id}]}}))return o.NextResponse.json({error:"Mesaj bulunamadÄ± veya silme yetkiniz yok"},{status:404});return await d.default.message.delete({where:{id:a}}),o.NextResponse.json({success:!0,deleted:1})}if(n&&Array.isArray(n)){let e=await d.default.message.deleteMany({where:{id:{in:n},OR:[{senderId:t.id},{receiverId:t.id}]}});return o.NextResponse.json({success:!0,deleted:e.count})}if(i){let e={OR:[{senderId:t.id,receiverId:i},{senderId:i,receiverId:t.id}]};"sent"===c?e.OR=[{senderId:t.id,receiverId:i}]:"received"===c&&(e.OR=[{senderId:i,receiverId:t.id}]),s&&(e.productId=s);let r=await d.default.message.deleteMany({where:e});return o.NextResponse.json({success:!0,deleted:r.count})}return o.NextResponse.json({error:"messageId, messageIds veya conversationUserId gerekli"},{status:400})}catch(e){return console.error("Message delete error:",e),o.NextResponse.json({error:"Mesaj silinirken hata oluÅŸtu"},{status:500})}}let k=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/messages/route",pathname:"/api/messages",filename:"route",bundlePath:"app/api/messages/route"},resolvedPagePath:"/home/ubuntu/takas-a-kodlar/nextjs_space/app/api/messages/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:w,staticGenerationAsyncStorage:v,serverHooks:b}=k,h="/api/messages/route";function j(){return(0,s.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:v})}},11826:(e,r,t)=>{t.d(r,{L:()=>d});var a=t(66291),n=t(64617),i=t(3390),s=t.n(i),o=t(83178),l=t(59521);let d={adapter:(0,n.N)(o.default),providers:[(0,a.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e,r){if(!e?.email||!e?.password)return null;let t=r?.headers?.["x-real-ip"],a=r?.headers?.["x-forwarded-for"],n=t?Array.isArray(t)?t[0]:t:a&&(Array.isArray(a)?a[0]:a).split(",").pop()?.trim()||"unknown",i=r?.headers?.["user-agent"]||"unknown";if(!(await (0,l.d5)(n,e.email)).allowed)throw await (0,l.Ky)(e.email,n,5,void 0),Error("ACCOUNT_LOCKED");let d=await o.default.user.findUnique({where:{email:e.email}});return d?await s().compare(e.password,d.password)?(await (0,l.LW)(n,d.id,d.email,i),await o.default.user.update({where:{id:d.id},data:{lastLoginAt:new Date}}),{id:d.id,email:d.email,name:d.name,role:d.role}):(await (0,l.Vm)(n,e.email,i,"Invalid password"),null):(await (0,l.Vm)(n,e.email,i,"User not found"),null)}})],session:{strategy:"jwt",maxAge:86400,updateAge:300},jwt:{maxAge:86400},callbacks:{jwt:async({token:e,user:r})=>(r&&(e.id=r.id,e.role=r.role),e),session:async({session:e,token:r})=>(e?.user&&(e.user.id=r?.id,e.user.role=r?.role),e)},pages:{signIn:"/giris"},secret:process.env.NEXTAUTH_SECRET,cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}}}},2158:(e,r,t)=>{t.d(r,{LP:()=>l,_0:()=>s,lo:()=>o});var a=t(83178);let n=[/\b0\s*5\s*[0-9]{2}\s*[0-9]{3}\s*[0-9]{2}\s*[0-9]{2}\b/gi,/\b05[0-9]{9}\b/g,/\+\s*90\s*5[0-9]{9}\b/gi,/\+\s*90\s*5\s*[0-9]{2}\s*[0-9]{3}\s*[0-9]{2}\s*[0-9]{2}\b/gi,/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/gi],i={external_contact:{tr:"\uD83D\uDCF5 Telefon numarasÄ± veya email adresi paylaÅŸamazsÄ±nÄ±z.\n\n\uD83D\uDD12 G\xfcvenliÄŸiniz i\xe7in bu bilgiler engellenmiÅŸtir.\n\nâœ… MesajlaÅŸmaya devam edebilirsiniz!",en:"\uD83D\uDCF5 You cannot share phone numbers or email addresses.\n\n\uD83D\uDD12 This information is blocked for your safety.\n\nâœ… You can continue messaging!",es:"\uD83D\uDCF5 No puede compartir n\xfameros de tel\xe9fono o direcciones de email.\n\n\uD83D\uDD12 Esta informaci\xf3n est\xe1 bloqueada por seguridad.\n\nâœ… \xa1Puede continuar mensajeando!",ca:"\uD83D\uDCF5 No podeu compartir n\xfameros de tel\xe8fon o adreces de correu.\n\n\uD83D\uDD12 Aquesta informaci\xf3 est\xe0 bloquejada per seguretat.\n\nâœ… Podeu continuar enviant missatges!"}};function s(e,r="tr"){for(let t of n)if(t.lastIndex=0,t.test(e))return{isApproved:!1,result:"policy_violation",reason:"Platform dÄ±ÅŸÄ± iletiÅŸim bilgisi tespit edildi",containsPersonalInfo:!0,detectedPatterns:["external_contact"],warningMessage:i.external_contact[r]||i.external_contact.tr,violationType:"external_contact"};return{isApproved:!0,result:"approved",containsPersonalInfo:!1,detectedPatterns:[]}}async function o(e){try{let r=await fetch("https://routellm.abacus.ai/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${process.env.ABACUSAI_API_KEY}`},body:JSON.stringify({model:"gpt-4.1-mini",messages:[{role:"system",content:`Sen bir mesaj moderasyon asistanÄ±sÄ±n. KullanÄ±cÄ± mesajlarÄ±nÄ± aÅŸaÄŸÄ±daki kriterlere g\xf6re deÄŸerlendir:

1. KÄ°ÅžÄ°SEL BÄ°LGÄ° KONTROL\xdc:
   - Telefon numarasÄ± (05XX, +90, vb.)
   - Email adresi
   - Ev/iÅŸ adresi
   - Sosyal medya hesaplarÄ± (Instagram, WhatsApp, Telegram kullanÄ±cÄ± adÄ±)
   
2. UYGUNSUZ Ä°\xc7ERÄ°K KONTROL\xdc:
   - K\xfcf\xfcr, hakaret
   - Cinsel i\xe7erik, pornografik ifadeler
   - Taciz, tehdit
   - Irk\xe7Ä±lÄ±k, nefret s\xf6ylemi
   - Spam, dolandÄ±rÄ±cÄ±lÄ±k giriÅŸimi

3. ETÄ°K KONTROL:
   - Platformu yanlÄ±ÅŸ kullanma (para isteme, satÄ±ÅŸ yapma)
   - DiÄŸer kullanÄ±cÄ±larÄ± platforma dÄ±ÅŸÄ±na y\xf6nlendirme

YANÄ°T FORMATÄ° (sadece JSON):
{
  "result": "approved" | "warning" | "blocked",
  "reason": "varsa a\xe7Ä±klama",
  "containsPersonalInfo": true | false,
  "severity": "low" | "medium" | "high"
}

EÄŸer mesaj tamamen uygunsa: {"result": "approved", "reason": null, "containsPersonalInfo": false, "severity": "low"}
EÄŸer kiÅŸisel bilgi varsa ama diÄŸer i\xe7erik uygunsa: result="warning"
EÄŸer uygunsuz i\xe7erik varsa: result="blocked"`},{role:"user",content:`MesajÄ± deÄŸerlendir:
"${e}"`}],temperature:.1,max_tokens:200})});if(!r.ok)return console.error("AI moderation API error:",r.status),s(e);let t=await r.json(),a=t.choices?.[0]?.message?.content||"";try{let e=a.match(/\{[\s\S]*\}/);if(e){let r=JSON.parse(e[0]);return{isApproved:"approved"===r.result,result:r.result,reason:r.reason,containsPersonalInfo:r.containsPersonalInfo||!1,detectedPatterns:r.severity?[r.severity]:[]}}}catch(e){console.error("AI response parse error:",e)}return s(e)}catch(r){return console.error("AI moderation error:",r),s(e)}}async function l(e){let r=await a.default.user.findUnique({where:{id:e},select:{suspendedUntil:!0,suspensionCount:!0}});if(!r?.suspendedUntil)return{isSuspended:!1};let t=new Date;if(r.suspendedUntil>t){let e=r.suspendedUntil.getFullYear()>=2099;return{isSuspended:!0,suspendedUntil:r.suspendedUntil,reason:e?"HesabÄ±nÄ±z kalÄ±cÄ± olarak askÄ±ya alÄ±nmÄ±ÅŸtÄ±r.":`HesabÄ±nÄ±z ${r.suspendedUntil.toLocaleDateString("tr-TR")} tarihine kadar askÄ±da.`}}return await a.default.user.update({where:{id:e},data:{suspendedUntil:null}}),{isSuspended:!1}}},92054:(e,r,t)=>{t.d(r,{oO:()=>a});function a(e){return e&&"string"==typeof e?e.trim().replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/on\w+\s*=\s*["'][^"']*["']/gi,"").replace(/javascript\s*:/gi,"").replace(/data\s*:\s*text\/html/gi,"").replace(/<iframe/gi,"&lt;iframe").replace(/<object/gi,"&lt;object").replace(/<embed/gi,"&lt;embed").replace(/<form/gi,"&lt;form"):""}},81510:(e,r,t)=>{t.d(r,{C$:()=>i,Gu:()=>d,QT:()=>l,if:()=>c,lw:()=>o,qi:()=>s,td:()=>n});var a=t(91209);let n=a.z.object({title:a.z.string().min(3,"BaÅŸlÄ±k en az 3 karakter").max(200,"BaÅŸlÄ±k en fazla 200 karakter").trim(),description:a.z.string().min(10,"A\xe7Ä±klama en az 10 karakter").max(5e3).trim(),valorPrice:a.z.number().int().min(1,"DeÄŸer en az 1 Valor").max(1e5,"DeÄŸer en fazla 100000 Valor"),condition:a.z.enum(["new","like_new","good","fair","poor"]).default("good"),categoryId:a.z.string().min(1,"Kategori se\xe7iniz"),city:a.z.string().default("Ä°zmir"),district:a.z.string().optional(),images:a.z.array(a.z.string()).max(10,"En fazla 10 g\xf6rsel").optional(),latitude:a.z.number().optional(),longitude:a.z.number().optional(),usageInfo:a.z.string().optional(),checklistData:a.z.string().optional(),userValorPrice:a.z.number().optional(),acceptsNegotiation:a.z.boolean().optional(),isFreeAvailable:a.z.boolean().optional()}),i=a.z.object({productId:a.z.string().min(1,"\xdcr\xfcn ID gerekli"),message:a.z.string().max(1e3,"Mesaj en fazla 1000 karakter").optional(),offeredProductId:a.z.string().nullable().optional(),offeredValor:a.z.number().int().min(0).max(1e5).optional(),quickOffer:a.z.boolean().optional(),smartMatch:a.z.boolean().optional()}),s=a.z.object({receiverId:a.z.string().min(1,"AlÄ±cÄ± ID gerekli"),content:a.z.string().min(1,"Mesaj boÅŸ olamaz").max(5e3,"Mesaj en fazla 5000 karakter").trim(),productId:a.z.string().optional(),image:a.z.string().optional()});a.z.object({name:a.z.string().min(2,"Ä°sim en az 2 karakter").max(100).trim().optional(),phone:a.z.string().regex(/^(\+90|0)?[0-9]{10}$/,"Ge\xe7ersiz telefon numarasÄ±").optional().nullable(),city:a.z.string().max(100).optional(),district:a.z.string().max(100).optional(),bio:a.z.string().max(500).optional()});let o=a.z.object({title:a.z.string().min(3,"BaÅŸlÄ±k en az 3 karakter").max(200).trim(),description:a.z.string().min(10,"A\xe7Ä±klama en az 10 karakter").max(5e3).trim(),category:a.z.enum(["cleaning","electrical","plumbing","beauty","education","cooking","repair","delivery","design","photography","other"]),duration:a.z.string().max(50),valorPrice:a.z.number().int().min(1,"DeÄŸer en az 1 Valor").max(1e5),city:a.z.string().default("Ä°zmir"),district:a.z.string().optional(),serviceArea:a.z.string().optional(),wantCategory:a.z.string().optional(),wantDescription:a.z.string().max(500).optional(),listingType:a.z.enum(["individual","business"]).default("individual"),businessName:a.z.string().max(200).optional(),businessType:a.z.string().optional(),unitType:a.z.string().optional(),unitCount:a.z.number().int().optional(),images:a.z.array(a.z.string()).optional()}),l=a.z.object({wantTitle:a.z.string().min(3,"BaÅŸlÄ±k en az 3 karakter").max(200).trim(),wantDescription:a.z.string().max(2e3).optional(),wantCategory:a.z.string().min(1,"Kategori gerekli"),wantMinValue:a.z.number().int().min(0).optional(),wantMaxValue:a.z.number().int().max(1e5).optional(),offerType:a.z.enum(["specific_product","category","any"]).default("any"),preferredCity:a.z.string().optional(),isUrgent:a.z.boolean().default(!1),offerProductId:a.z.string().optional(),offerCategory:a.z.string().optional(),offerTitle:a.z.string().optional(),offerDescription:a.z.string().optional(),offerMinValue:a.z.number().optional(),offerMaxValue:a.z.number().optional(),deadline:a.z.string().optional(),urgencyBonus:a.z.number().optional()});function d(e,r){try{let t=e.parse(r);return{success:!0,data:t}}catch(e){if(e instanceof a.z.ZodError)return{success:!1,error:e.errors.map(e=>e.message).join(", ")};return{success:!1,error:"Ge\xe7ersiz veri"}}}let u=a.z.string().min(8,"Åžifre en az 8 karakter olmalÄ±").max(128,"Åžifre en fazla 128 karakter olabilir").refine(e=>/[A-Z]/.test(e),"En az 1 b\xfcy\xfck harf gerekli").refine(e=>/[a-z]/.test(e),"En az 1 k\xfc\xe7\xfck harf gerekli").refine(e=>/[0-9]/.test(e),"En az 1 rakam gerekli"),c=a.z.object({email:a.z.string().email("Ge\xe7erli bir e-posta girin").trim().toLowerCase(),password:u,name:a.z.string().min(2,"Ä°sim en az 2 karakter").max(100).trim(),nickname:a.z.string().min(2).max(50).trim().optional()});a.z.object({currentPassword:a.z.string().min(1,"Mevcut ÅŸifre gerekli"),newPassword:u})}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[8412,7609,3390,1472,7853,1209,9521,9628],()=>t(94694));module.exports=a})();