"use strict";(()=>{var e={};e.id=4569,e.ids=[4569],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},67779:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>T,patchFetch:()=>v,requestAsyncStorage:()=>x,routeModule:()=>_,serverHooks:()=>g,staticGenerationAsyncStorage:()=>q});var s={};r.r(s),r.d(s,{GET:()=>E,PATCH:()=>h,POST:()=>R,PUT:()=>y,dynamic:()=>m});var a=r(79182),i=r(72007),n=r(56719),o=r(93442),d=r(57978),u=r(83178),l=r(11826),p=r(59628),c=r(68247);let m="force-dynamic",w={defect:"\xdcr\xfcn kusurlu",not_as_described:"A\xe7ıklamayla uyuşmuyor",missing_parts:"Eksik par\xe7a",damaged:"Hasar var",wrong_item:"Yanlış \xfcr\xfcn g\xf6nderilmiş",no_show:"Karşı taraf gelmedi",other:"Diğer"},f=[{id:"50_50",title:"Eşit Paylaşım",description:"Teminatın %50'si her iki tarafa iade edilir",reporterRefundPercent:50,reportedRefundPercent:50,trustScorePenalty:3},{id:"70_30",title:"Alıcı Lehine",description:"Teminatın %70'i alıcıya, %30'u satıcıya iade",reporterRefundPercent:70,reportedRefundPercent:30,trustScorePenalty:8},{id:"full_refund",title:"Tam İade",description:"T\xfcm teminat alıcıya iade, satıcıya trust puanı cezası",reporterRefundPercent:100,reportedRefundPercent:0,trustScorePenalty:15},{id:"cancel_no_penalty",title:"Cezasız İptal",description:"Takas iptal, teminat iade, trust puanı etkilenmez",reporterRefundPercent:100,reportedRefundPercent:100,trustScorePenalty:0}];async function R(e){try{let t=await (0,d.getServerSession)(l.L);if(!t?.user?.email)return o.NextResponse.json({error:"Oturum a\xe7manız gerekiyor"},{status:401});let r=await u.default.user.findUnique({where:{email:t.user.email},select:{id:!0}});if(!r)return o.NextResponse.json({error:"Kullanıcı bulunamadı"},{status:401});let{swapRequestId:s,type:a,description:i,evidence:n}=await e.json();if(!s)return o.NextResponse.json({error:"Takas ID gerekli"},{status:400});if(!a||!["defect","not_as_described","missing_parts","damaged","wrong_item","no_show","other"].includes(a))return o.NextResponse.json({error:"Ge\xe7erli bir sorun t\xfcr\xfc se\xe7in"},{status:400});if(!i||i.length<20)return o.NextResponse.json({error:"A\xe7ıklama en az 20 karakter olmalı"},{status:400});let m=await u.default.swapRequest.findUnique({where:{id:s},include:{product:{select:{id:!0,title:!0}},owner:{select:{id:!0,name:!0}},requester:{select:{id:!0,name:!0}},disputes:!0}});if(!m)return o.NextResponse.json({error:"Takas isteği bulunamadı"},{status:404});if("delivered"!==m.status)return o.NextResponse.json({error:"Sadece teslim alınmış takaslar i\xe7in sorun bildirilebilir"},{status:400});if(m.requesterId!==r.id)return o.NextResponse.json({error:"Sadece alıcı sorun bildirebilir"},{status:403});if(m.disputes.find(e=>"open"===e.status||"under_review"===e.status))return o.NextResponse.json({error:"Bu takas i\xe7in zaten a\xe7ık bir rapor var"},{status:400});let R=new Date,E=m.disputeWindowEndsAt||m.deliveryConfirmDeadline;if(E&&R>E)return o.NextResponse.json({error:`${c.kg} saatlik itiraz s\xfcresi dolmuş. Takas otomatik onaylandı.`},{status:400});let h=new Date;h.setHours(h.getHours()+48);let y=await u.default.disputeReport.create({data:{swapRequestId:s,reporterId:r.id,reportedUserId:m.ownerId,type:a,description:i,evidence:n||[],status:"evidence_pending",evidenceDeadline:h,settlementOptions:JSON.stringify(f)}});return await u.default.swapRequest.update({where:{id:s},data:{status:"disputed"}}),await u.default.activityFeed.create({data:{type:"dispute_opened",userId:r.id,userName:m.requester.name,productId:m.productId,productTitle:m.product.title,targetUserId:m.ownerId,targetUserName:m.owner.name,metadata:JSON.stringify({disputeId:y.id,type:a})}}),(0,p.LX)(m.ownerId,p.j_.SWAP_DISPUTE,{productTitle:m.product.title,swapId:s,reporterName:m.requester.name||"Alıcı",reason:w[a]||a}).catch(e=>console.error("Push notification error:",e)),(0,p.LX)(m.ownerId,p.j_.DISPUTE_EVIDENCE_REQUEST,{productTitle:m.product.title,disputeId:y.id}).catch(e=>console.error("Push notification error:",e)),(0,p.LX)(r.id,p.j_.DISPUTE_EVIDENCE_REQUEST,{productTitle:m.product.title,disputeId:y.id}).catch(e=>console.error("Push notification error:",e)),o.NextResponse.json({success:!0,disputeId:y.id,message:"Sorun raporu oluşturuldu. 48 saat i\xe7inde kanıt y\xfckleyebilirsiniz.",status:"evidence_pending",evidenceDeadline:h,settlementOptions:f})}catch(e){return console.error("Dispute creation error:",e),o.NextResponse.json({error:"Rapor oluşturulamadı"},{status:500})}}async function E(e){try{let t=await (0,d.getServerSession)(l.L);if(!t?.user?.email)return o.NextResponse.json({error:"Oturum a\xe7manız gerekiyor"},{status:401});let r=await u.default.user.findUnique({where:{email:t.user.email},select:{id:!0}});if(!r)return o.NextResponse.json({error:"Kullanıcı bulunamadı"},{status:401});let{searchParams:s}=new URL(e.url),a=s.get("swapRequestId"),i=await u.default.disputeReport.findMany({where:a?{swapRequestId:a}:{OR:[{reporterId:r.id},{reportedUserId:r.id}]},include:{swapRequest:{include:{product:{select:{id:!0,title:!0,images:!0}},owner:{select:{id:!0,name:!0}},requester:{select:{id:!0,name:!0}}}}},orderBy:{createdAt:"desc"}});return o.NextResponse.json(i)}catch(e){return console.error("Disputes fetch error:",e),o.NextResponse.json({error:"Raporlar y\xfcklenemedi"},{status:500})}}async function h(e){try{let t=await (0,d.getServerSession)(l.L);if(!t?.user?.email)return o.NextResponse.json({error:"Oturum a\xe7manız gerekiyor"},{status:401});let r=await u.default.user.findUnique({where:{email:t.user.email},select:{id:!0,role:!0}});if(!r)return o.NextResponse.json({error:"Kullanıcı bulunamadı"},{status:401});if("admin"!==r.role)return o.NextResponse.json({error:"Admin yetkisi gerekli"},{status:403});let{disputeId:s,status:a,resolution:i,penaltyAmount:n,refundApproved:m,adminNotes:w}=await e.json();if(!s)return o.NextResponse.json({error:"Rapor ID gerekli"},{status:400});let f=await u.default.disputeReport.findUnique({where:{id:s},include:{swapRequest:{include:{product:!0,owner:!0,requester:!0}}}});if(!f)return o.NextResponse.json({error:"Rapor bulunamadı"},{status:404});let R=await u.default.$transaction(async e=>{let t=await e.disputeReport.update({where:{id:s},data:{status:a||f.status,resolution:i,penaltyApplied:!!n,penaltyAmount:n,refundApproved:m||!1,adminNotes:w}});if(n&&n>0){let t=await e.user.findUnique({where:{id:f.reportedUserId},select:{trustScore:!0}}),r=(0,c.uF)(t?.trustScore||100,-n);await e.user.update({where:{id:f.reportedUserId},data:{trustScore:r,totalWarnings:{increment:1}}}),await e.userWarning.create({data:{userId:f.reportedUserId,type:"dispute_penalty",severity:n>=20?"high":n>=10?"medium":"low",description:`Takas anlaşmazlığı: ${i}`}})}return m&&f.swapRequest.pendingValorAmount&&(await e.user.update({where:{id:f.swapRequest.requesterId},data:{valorBalance:{increment:f.swapRequest.pendingValorAmount}}}),await e.swapRequest.update({where:{id:f.swapRequestId},data:{status:"refunded"}}),await e.valorTransaction.create({data:{toUserId:f.swapRequest.requesterId,amount:f.swapRequest.pendingValorAmount,fee:0,netAmount:f.swapRequest.pendingValorAmount,type:"refund",swapRequestId:f.swapRequestId,description:`İade: ${f.swapRequest.product.title}`}})),"resolved"!==a||m||await e.swapRequest.update({where:{id:f.swapRequestId},data:{status:"completed"}}),t});return m?((0,p.LX)(f.swapRequest.requesterId,p.j_.SWAP_REFUNDED,{productTitle:f.swapRequest.product.title,swapId:f.swapRequestId,valorAmount:f.swapRequest.pendingValorAmount}).catch(e=>console.error("Push notification error:",e)),(0,p.LX)(f.swapRequest.ownerId,p.j_.SYSTEM,{title:"Takas İptal Edildi",body:`"${f.swapRequest.product.title}" takası iptal edildi ve alıcıya iade yapıldı.`,url:"/profil?tab=swaps"}).catch(e=>console.error("Push notification error:",e))):"resolved"===a&&((0,p.LX)(f.swapRequest.requesterId,p.j_.SYSTEM,{title:"Sorun \xc7\xf6z\xfcld\xfc",body:`"${f.swapRequest.product.title}" i\xe7in bildirdiğiniz sorun \xe7\xf6z\xfcld\xfc.`,url:"/profil?tab=swaps"}).catch(e=>console.error("Push notification error:",e)),(0,p.LX)(f.swapRequest.ownerId,p.j_.SYSTEM,{title:"Sorun \xc7\xf6z\xfcld\xfc",body:`"${f.swapRequest.product.title}" i\xe7in bildirilen sorun \xe7\xf6z\xfcld\xfc.`,url:"/profil?tab=swaps"}).catch(e=>console.error("Push notification error:",e))),o.NextResponse.json({success:!0,dispute:R,message:"Rapor g\xfcncellendi"})}catch(e){return console.error("Dispute update error:",e),o.NextResponse.json({error:"Rapor g\xfcncellenemedi"},{status:500})}}async function y(e){try{let t=await (0,d.getServerSession)(l.L);if(!t?.user?.email)return o.NextResponse.json({error:"Oturum a\xe7manız gerekiyor"},{status:401});let r=await u.default.user.findUnique({where:{email:t.user.email},select:{id:!0,name:!0}});if(!r)return o.NextResponse.json({error:"Kullanıcı bulunamadı"},{status:401});let{disputeId:s,action:a,evidence:i,evidenceNote:n,settlementChoice:c}=await e.json();if(!s)return o.NextResponse.json({error:"Rapor ID gerekli"},{status:400});let m=await u.default.disputeReport.findUnique({where:{id:s},include:{swapRequest:{include:{product:{select:{id:!0,title:!0}},owner:{select:{id:!0,name:!0}},requester:{select:{id:!0,name:!0}}}}}});if(!m)return o.NextResponse.json({error:"Rapor bulunamadı"},{status:404});let w=m.reporterId===r.id,R=m.reportedUserId===r.id;if(!w&&!R)return o.NextResponse.json({error:"Bu rapora erişim yetkiniz yok"},{status:403});if("upload_evidence"===a){if(m.evidenceDeadline&&new Date>m.evidenceDeadline)return o.NextResponse.json({error:"Kanıt y\xfckleme s\xfcresi dolmuş"},{status:400});if(!i||!Array.isArray(i)||0===i.length)return o.NextResponse.json({error:"En az bir kanıt y\xfcklemelisiniz"},{status:400});if(i.length>5)return o.NextResponse.json({error:"En fazla 5 kanıt y\xfckleyebilirsiniz"},{status:400});let e=w?{reporterEvidence:i,reporterEvidenceNote:n||null,reporterEvidenceAt:new Date}:{reportedEvidence:i,reportedEvidenceNote:n||null,reportedEvidenceAt:new Date},t=await u.default.disputeReport.update({where:{id:s},data:e}),a=w?m.reportedUserId:m.reporterId;return(0,p.LX)(a,p.j_.DISPUTE_EVIDENCE_SUBMITTED,{productTitle:m.swapRequest.product.title,disputeId:s,submitterName:r.name||"Kullanıcı"}).catch(e=>console.error("Push notification error:",e)),t.reporterEvidenceAt&&t.reportedEvidenceAt&&await u.default.disputeReport.update({where:{id:s},data:{status:"settlement_pending"}}),o.NextResponse.json({success:!0,message:"Kanıtlarınız başarıyla y\xfcklendi",evidenceCount:i.length})}if("submit_settlement"===a){if(!c)return o.NextResponse.json({error:"Uzlaşma se\xe7imi gerekli"},{status:400});if(!f.map(e=>e.id).includes(c))return o.NextResponse.json({error:"Ge\xe7ersiz uzlaşma se\xe7imi"},{status:400});let e=w?{reporterSettlementChoice:c}:{reportedSettlementChoice:c},t=await u.default.disputeReport.update({where:{id:s},data:e}),r=w?m.reportedUserId:m.reporterId,a=f.find(e=>e.id===c);if((0,p.LX)(r,p.j_.DISPUTE_SETTLEMENT_OFFER,{productTitle:m.swapRequest.product.title,disputeId:s,offerDescription:a?.title||c}).catch(e=>console.error("Push notification error:",e)),t.reporterSettlementChoice&&t.reportedSettlementChoice){if(t.reporterSettlementChoice!==t.reportedSettlementChoice)return await u.default.disputeReport.update({where:{id:s},data:{status:"under_review"}}),o.NextResponse.json({success:!0,message:"Uzlaşma sağlanamadı. Rapor admin incelemesine alındı.",settlementReached:!1});{let e=f.find(e=>e.id===t.reporterSettlementChoice);if(e)return await I(m,e),(0,p.LX)(m.reporterId,p.j_.DISPUTE_SETTLEMENT_ACCEPTED,{productTitle:m.swapRequest.product.title,disputeId:s,resolution:e.title}).catch(e=>console.error("Push notification error:",e)),(0,p.LX)(m.reportedUserId,p.j_.DISPUTE_SETTLEMENT_ACCEPTED,{productTitle:m.swapRequest.product.title,disputeId:s,resolution:e.title}).catch(e=>console.error("Push notification error:",e)),o.NextResponse.json({success:!0,message:"Uzlaşma sağlandı! Her iki taraf aynı se\xe7imi yaptı.",settlementReached:!0,settlementType:e.id,settlementTitle:e.title})}}return o.NextResponse.json({success:!0,message:"Uzlaşma tercihiniz kaydedildi. Karşı tarafın se\xe7imi bekleniyor.",yourChoice:c})}return o.NextResponse.json({error:"Ge\xe7ersiz action"},{status:400})}catch(e){return console.error("Dispute PUT error:",e),o.NextResponse.json({error:"İşlem başarısız"},{status:500})}}async function I(e,t){let{swapRequest:r}=e;await u.default.$transaction(async s=>{await s.disputeReport.update({where:{id:e.id},data:{status:"resolved",settlementType:t.id,settlementReachedAt:new Date,resolution:`Otomatik uzlaşma: ${t.title}`}});let a=r.pendingValorAmount?Math.floor(r.pendingValorAmount*t.reporterRefundPercent/100):0;if(a>0&&(await s.user.update({where:{id:r.requesterId},data:{valorBalance:{increment:a}}}),await s.valorTransaction.create({data:{toUserId:r.requesterId,amount:a,fee:0,netAmount:a,type:"settlement_refund",swapRequestId:r.id,description:`Uzlaşma iadesi: ${t.title}`}})),t.trustScorePenalty>0){let r=await s.user.findUnique({where:{id:e.reportedUserId},select:{trustScore:!0}}),a=(0,c.uF)(r?.trustScore||100,-t.trustScorePenalty);await s.user.update({where:{id:e.reportedUserId},data:{trustScore:a}})}await s.swapRequest.update({where:{id:r.id},data:{status:"full_refund"===t.id?"refunded":"completed",valorReleased:!0}})})}let _=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/disputes/route",pathname:"/api/disputes",filename:"route",bundlePath:"app/api/disputes/route"},resolvedPagePath:"/home/ubuntu/takas-a-kodlar/nextjs_space/app/api/disputes/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:x,staticGenerationAsyncStorage:q,serverHooks:g}=_,T="/api/disputes/route";function v(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:q})}},11826:(e,t,r)=>{r.d(t,{L:()=>u});var s=r(66291),a=r(64617),i=r(3390),n=r.n(i),o=r(83178),d=r(59521);let u={adapter:(0,a.N)(o.default),providers:[(0,s.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e,t){if(!e?.email||!e?.password)return null;let r=t?.headers?.["x-real-ip"],s=t?.headers?.["x-forwarded-for"],a=r?Array.isArray(r)?r[0]:r:s&&(Array.isArray(s)?s[0]:s).split(",").pop()?.trim()||"unknown",i=t?.headers?.["user-agent"]||"unknown";if(!(await (0,d.d5)(a,e.email)).allowed)throw await (0,d.Ky)(e.email,a,5,void 0),Error("ACCOUNT_LOCKED");let u=await o.default.user.findUnique({where:{email:e.email}});return u?await n().compare(e.password,u.password)?(await (0,d.LW)(a,u.id,u.email,i),await o.default.user.update({where:{id:u.id},data:{lastLoginAt:new Date}}),{id:u.id,email:u.email,name:u.name,role:u.role}):(await (0,d.Vm)(a,e.email,i,"Invalid password"),null):(await (0,d.Vm)(a,e.email,i,"User not found"),null)}})],session:{strategy:"jwt",maxAge:86400,updateAge:300},jwt:{maxAge:86400},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.role=t.role),e),session:async({session:e,token:t})=>(e?.user&&(e.user.id=t?.id,e.user.role=t?.role),e)},pages:{signIn:"/giris"},secret:process.env.NEXTAUTH_SECRET,cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}}}},68247:(e,t,r)=>{r.d(t,{AN:()=>l,F6:()=>o,Qi:()=>a,Sq:()=>d,kg:()=>s,nk:()=>u,u2:()=>p,uF:()=>c});let s=parseInt(process.env.DISPUTE_WINDOW_HOURS||"48"),a=(parseInt(process.env.LOCK_TIMEOUT_HOURS||"48"),parseInt(process.env.QR_CODE_VALIDITY_HOURS||"72"),parseInt(process.env.VERIFICATION_CODE_VALIDITY_HOURS||"24"),"false"!==process.env.AUTO_COMPLETE_LOW_RISK),i=(parseInt(process.env.AUTO_COMPLETE_DELAY_HOURS||"0"),parseFloat(process.env.PREMIUM_RATE_BASE||"0.015"),parseFloat(process.env.PREMIUM_RATE_MIN||"0.01"),parseFloat(process.env.PREMIUM_RATE_MAX||"0.03"),parseFloat(process.env.TARGET_RESERVE_RATIO_30D||"0.05"),parseFloat(process.env.POOL_REBALANCE_STEP||"0.0025"),{LOW_MAX:parseInt(process.env.RISK_LOW_MAX||"100"),MEDIUM_MAX:parseInt(process.env.RISK_MEDIUM_MAX||"500")}),n={Elektronik:1.5,Bilgisayar:1.5,Telefon:1.5,"Oyun Konsolu":1.3,Mücevher:2,Saat:1.5,Antika:2,Sanat:2,default:1},o={PENDING:"pending",ACCEPTED:"accepted",REJECTED:"rejected",IN_DELIVERY:"in_delivery",DELIVERED:"delivered",COMPLETED:"completed",CANCELLED:"cancelled",DISPUTED:"disputed",RESOLVED:"resolved"},d={pending:["accepted","rejected","cancelled"],accepted:["in_delivery","delivered","completed","cancelled","disputed"],rejected:[],in_delivery:["delivered","disputed"],delivered:["completed","disputed"],completed:[],cancelled:[],disputed:["resolved","completed","cancelled"],resolved:["completed","cancelled"]};function u(e,t){let r=e*(t?n[t]||n.default:1);return r<=i.LOW_MAX?"low":r<=i.MEDIUM_MAX?"medium":"high"}function l(e){let t=new Date(e);return t.setHours(t.getHours()+s),t}let p={completedSwap:2,positiveReview:1,negativeReview:-5,disputeLost:-10,cancelledByUser:-3,noShow:-15,fakeProduct:-25,reportedAbuse:-20,phoneVerification:5,identityVerification:5,accountAgePerMonth:0};function c(e,t){return Math.max(0,Math.min(100,e+t))}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8412,7609,3390,1472,7853,9521,9628],()=>r(67779));module.exports=s})();