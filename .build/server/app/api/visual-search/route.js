"use strict";(()=>{var e={};e.id=3637,e.ids=[3637],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},97930:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>w,patchFetch:()=>k,requestAsyncStorage:()=>x,routeModule:()=>g,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f});var a={};t.r(a),t.d(a,{POST:()=>y,dynamic:()=>p});var s=t(79182),i=t(72007),o=t(56719),n=t(93442),l=t(57978),c=t(11826),u=t(83178),d=t(54413);let p="force-dynamic",m=new d.ZP({apiKey:process.env.ABACUSAI_API_KEY,baseURL:"https://routellm.abacus.ai/v1"});async function y(e){try{let r;let t=await (0,l.getServerSession)(c.L);if(!t?.user?.email)return n.NextResponse.json({error:"Giriş yapmalısınız"},{status:401});let a=(await e.formData()).get("image");if(!a)return n.NextResponse.json({error:"G\xf6rsel gerekli"},{status:400});let s=await a.arrayBuffer(),i=Buffer.from(s).toString("base64"),o=a.type||"image/jpeg",d=await m.chat.completions.create({model:"gpt-4.1-mini",messages:[{role:"system",content:`Sen bir \xfcr\xfcn tanımlama uzmanısın. Verilen g\xf6rseldeki \xfcr\xfcn\xfc analiz et ve şu bilgileri JSON formatında d\xf6nd\xfcr:
{
  "category": "\xfcr\xfcn kategorisi (elektronik, giyim, ev-esya, kitap-hobi, spor, diger)",
  "keywords": ["anahtar", "kelimeler", "listesi"],
  "description": "\xfcr\xfcn\xfcn kısa a\xe7ıklaması",
  "color": "renk",
  "brand": "varsa marka",
  "type": "\xfcr\xfcn tipi"
}
Sadece JSON d\xf6nd\xfcr, başka bir şey yazma.`},{role:"user",content:[{type:"image_url",image_url:{url:`data:${o};base64,${i}`}},{type:"text",text:"Bu g\xf6rseldeki \xfcr\xfcn\xfc analiz et."}]}],max_tokens:500}),p=d.choices[0]?.message?.content||"{}";try{let e=p.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim();r=JSON.parse(e)}catch{r={keywords:[],category:"diger",description:""}}let y=(r.keywords||[]).filter(e=>e&&e.length>2),g=(r.category||"").toLowerCase(),x=r.color||"",f=r.brand||"",h=r.type||"",w={elektronik:["elektronik"],giyim:["giyim"],"ev-esya":["ev-yasam","ev-esya"],ev:["ev-yasam","ev-esya"],mobilya:["ev-yasam","ev-esya"],kitap:["kitap-hobi"],"kitap-hobi":["kitap-hobi"],hobi:["kitap-hobi"],spor:["spor-outdoor","spor"],outdoor:["spor-outdoor"],bebek:["bebek-cocuk"],cocuk:["bebek-cocuk"],diger:[]}[g]||[],k=y.flatMap(e=>[{title:{contains:e,mode:"insensitive"}},{description:{contains:e,mode:"insensitive"}}]);f&&k.push({title:{contains:f,mode:"insensitive"}}),x&&k.push({title:{contains:x,mode:"insensitive"}}),h&&k.push({title:{contains:h,mode:"insensitive"}});let v=[];if(k.length>0&&(v=await u.default.product.findMany({where:{status:"active",OR:k},include:{category:!0,user:{select:{id:!0,name:!0}}},take:12,orderBy:[{isPopular:"desc"},{views:"desc"}]})),v.length<6&&w.length>0){let e=await u.default.product.findMany({where:{status:"active",category:{slug:{in:w}}},include:{category:!0,user:{select:{id:!0,name:!0}}},take:12,orderBy:[{isPopular:"desc"},{views:"desc"}]}),r=new Set(v.map(e=>e.id)),t=e.filter(e=>!r.has(e.id));v=[...v,...t].slice(0,12)}if(v.length<3){let e=await u.default.product.findMany({where:{status:"active"},include:{category:!0,user:{select:{id:!0,name:!0}}},take:12,orderBy:[{isPopular:"desc"},{views:"desc"}]}),r=new Set(v.map(e=>e.id)),t=e.filter(e=>!r.has(e.id));v=[...v,...t].slice(0,12)}let b=v;return n.NextResponse.json({success:!0,analysis:{category:r.category,description:r.description,keywords:y.slice(0,5)},products:b,count:b.length})}catch(e){return console.error("Visual search error:",e),n.NextResponse.json({error:"G\xf6rsel arama sırasında hata oluştu"},{status:500})}}let g=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/visual-search/route",pathname:"/api/visual-search",filename:"route",bundlePath:"app/api/visual-search/route"},resolvedPagePath:"/home/ubuntu/takas-a-kodlar/nextjs_space/app/api/visual-search/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:x,staticGenerationAsyncStorage:f,serverHooks:h}=g,w="/api/visual-search/route";function k(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}},11826:(e,r,t)=>{t.d(r,{L:()=>c});var a=t(66291),s=t(64617),i=t(3390),o=t.n(i),n=t(83178),l=t(59521);let c={adapter:(0,s.N)(n.default),providers:[(0,a.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e,r){if(!e?.email||!e?.password)return null;let t=r?.headers?.["x-real-ip"],a=r?.headers?.["x-forwarded-for"],s=t?Array.isArray(t)?t[0]:t:a&&(Array.isArray(a)?a[0]:a).split(",").pop()?.trim()||"unknown",i=r?.headers?.["user-agent"]||"unknown";if(!(await (0,l.d5)(s,e.email)).allowed)throw await (0,l.Ky)(e.email,s,5,void 0),Error("ACCOUNT_LOCKED");let c=await n.default.user.findUnique({where:{email:e.email}});return c?await o().compare(e.password,c.password)?(await (0,l.LW)(s,c.id,c.email,i),await n.default.user.update({where:{id:c.id},data:{lastLoginAt:new Date}}),{id:c.id,email:c.email,name:c.name,role:c.role}):(await (0,l.Vm)(s,e.email,i,"Invalid password"),null):(await (0,l.Vm)(s,e.email,i,"User not found"),null)}})],session:{strategy:"jwt",maxAge:86400,updateAge:300},jwt:{maxAge:86400},callbacks:{jwt:async({token:e,user:r})=>(r&&(e.id=r.id,e.role=r.role),e),session:async({session:e,token:r})=>(e?.user&&(e.user.id=r?.id,e.user.role=r?.role),e)},pages:{signIn:"/giris"},secret:process.env.NEXTAUTH_SECRET,cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}}}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[8412,7609,3390,1472,4413,9521],()=>t(97930));module.exports=a})();