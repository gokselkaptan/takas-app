"use strict";(()=>{var e={};e.id=4195,e.ids=[4195,4891,3455],e.modules={21841:e=>{e.exports=require("@aws-sdk/client-s3")},53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},93977:e=>{e.exports=require("node:fs/promises")},40688:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>w,requestAsyncStorage:()=>f,routeModule:()=>y,serverHooks:()=>g,staticGenerationAsyncStorage:()=>h});var i={};r.r(i),r.d(i,{POST:()=>m,dynamic:()=>p});var a=r(79182),s=r(72007),n=r(56719),o=r(93442),u=r(57978),l=r(83178),d=r(11826),c=r(43455);let p="force-dynamic";async function m(e){try{let t;let r=await (0,u.getServerSession)(d.L);if(!r?.user?.email)return o.NextResponse.json({error:"Oturum gerekli"},{status:401});let i=await l.default.user.findUnique({where:{email:r.user.email},select:{id:!0,name:!0,isIdentityVerified:!0,trustScore:!0,identityDocUrl:!0}});if(!i)return o.NextResponse.json({error:"Kullanıcı bulunamadı"},{status:404});if(i.isIdentityVerified)return o.NextResponse.json({error:"Kimliğiniz zaten doğrulanmış"},{status:400});let a=(await e.formData()).get("image");if(!a)return o.NextResponse.json({error:"Kimlik fotoğrafı gerekli"},{status:400});if(a.size>10485760)return o.NextResponse.json({error:"Dosya boyutu 10MB'ı aşamaz"},{status:400});if(!a.type.startsWith("image/"))return o.NextResponse.json({error:"Sadece resim dosyaları kabul edilir"},{status:400});let s=await a.arrayBuffer(),n=Buffer.from(s),p=n.toString("base64"),m=a.type,y=a.name.split(".").pop()||"jpg",f=`identity_${i.id}_${Date.now()}.${y}`,h=null;try{h=await (0,c.hM)(n,f,m,!1),console.log("[Identity] Document uploaded to S3:",h)}catch(e){console.error("[Identity] S3 upload error:",e)}let g=process.env.ABACUSAI_API_KEY;if(!g)return o.NextResponse.json({error:"AI servisi yapılandırılmamış"},{status:500});let x=await fetch("https://routellm.abacus.ai/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${g}`},body:JSON.stringify({model:"gpt-4.1-mini",messages:[{role:"system",content:`You are an international identity document verification expert. Analyze whether the uploaded photo is a valid government-issued ID document.

ACCEPTED DOCUMENT TYPES (any country):
- National ID cards (TC Kimlik, DNI, Carta d'Identit\xe0, Personalausweis, etc.)
- Passports (all countries)
- Driver's licenses (all countries)
- Residence permits / Green cards
- Any other official government-issued photo ID

VERIFICATION CHECKS:
1. Is this a valid government-issued ID document?
2. Is the document clearly readable?
3. Is the photo side (with face) visible?
4. Are there signs of manipulation or forgery?
5. What type and country is the document from?

CRITICAL SECURITY RULES:
- NEVER reveal ID numbers, birthdates, addresses or sensitive personal data
- Only confirm validity and return the name for matching
- For privacy, only extract and return the full name

Respond in JSON format:
{
  "isValidIdCard": boolean,
  "isReadable": boolean,
  "isFrontSide": boolean,
  "suspiciousActivity": boolean,
  "documentType": "national_id" | "passport" | "drivers_license" | "residence_permit" | "other",
  "documentCountry": "Country name or code (e.g., Turkey, Spain, USA)",
  "extractedName": "Full Name" or null (if unreadable),
  "reason": "Brief explanation in English"
}`},{role:"user",content:[{type:"text",text:"Analyze this photo and verify if it is a valid government-issued identity document."},{type:"image_url",image_url:{url:`data:${m};base64,${p}`}}]}],max_tokens:500,temperature:.1})});if(!x.ok)return console.error("AI API error:",await x.text()),o.NextResponse.json({error:"Kimlik analizi başarısız"},{status:500});let w=await x.json(),v=w.choices?.[0]?.message?.content||"";try{let e=v.match(/\{[\s\S]*\}/);if(e)t=JSON.parse(e[0]);else throw Error("JSON bulunamadı")}catch{return console.error("AI yanıtı parse edilemedi:",v),o.NextResponse.json({error:"Kimlik analizi sonucu işlenemedi. L\xfctfen daha net bir fotoğraf \xe7ekin."},{status:400})}if(!t.isValidIdCard)return o.NextResponse.json({success:!1,error:"No valid government ID detected. Please upload a clear photo of your ID card, passport, or driver's license.",errorTR:"Ge\xe7erli bir kimlik belgesi tespit edilemedi. L\xfctfen kimlik kartı, pasaport veya ehliyet fotoğrafı y\xfckleyin.",reason:t.reason},{status:400});if(!t.isReadable)return o.NextResponse.json({success:!1,error:"Document is not clearly readable. Please take a photo with better lighting.",errorTR:"Belge net okunamıyor. L\xfctfen daha iyi aydınlatılmış bir fotoğraf \xe7ekin.",reason:t.reason},{status:400});if(!t.isFrontSide)return o.NextResponse.json({success:!1,error:"Please show the front side of your ID (the side with your photo).",errorTR:"L\xfctfen kimliğinizin \xf6n y\xfcz\xfcn\xfc (fotoğraflı tarafını) g\xf6sterin.",reason:t.reason},{status:400});if(t.suspiciousActivity)return o.NextResponse.json({success:!1,error:"Suspicious activity detected. Please use your original ID document.",errorTR:"Ş\xfcpheli aktivite tespit edildi. Orijinal kimlik belgenizi kullanın.",reason:t.reason},{status:400});let k=t.extractedName?.toLowerCase().trim(),C=i.name?.toLowerCase().trim();if(!k)return o.NextResponse.json({success:!1,error:"Could not read the name on your document. Please upload a clearer photo.",errorTR:"Belgedeki isim okunamadı. L\xfctfen daha net bir fotoğraf y\xfckleyin.",reason:t.reason},{status:400});let b=k.split(/\s+/),R=C?.split(/\s+/)||[];if(!b.some(e=>R.some(t=>e.length>2&&t.length>2&&(e.includes(t)||t.includes(e))))&&C)return o.NextResponse.json({success:!1,error:"The name on your ID does not match your account. Please update your profile or contact support@takas-a.com",errorTR:"Belgedeki isim hesap bilgilerinizle eşleşmiyor. Profil bilgilerinizi g\xfcncelleyin veya support@takas-a.com ile iletişime ge\xe7in.",reason:"Name mismatch"},{status:400});return console.log(`[Identity] Verified: ${t.documentType} from ${t.documentCountry} for user ${i.id}`),await l.default.user.update({where:{id:i.id},data:{isIdentityVerified:!0,trustScore:Math.min(100,i.trustScore+15),identityDocUrl:h,identityVerifiedAt:new Date,identityVerifyStatus:"verified"}}),o.NextResponse.json({success:!0,message:"Your identity has been verified! \uD83C\uDF89",messageTR:"Kimliğiniz başarıyla doğrulandı! \uD83C\uDF89",trustScoreBonus:15,documentType:t.documentType,documentCountry:t.documentCountry,newBenefit:"You now only need 5% deposit for swaps.",newBenefitTR:"Artık takaslarda sadece %5 teminat yatırmanız yeterli."})}catch(e){return console.error("Identity verification error:",e),o.NextResponse.json({error:"Bir hata oluştu"},{status:500})}}let y=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/verify-identity/route",pathname:"/api/verify-identity",filename:"route",bundlePath:"app/api/verify-identity/route"},resolvedPagePath:"/home/ubuntu/takas-a-kodlar/nextjs_space/app/api/verify-identity/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:f,staticGenerationAsyncStorage:h,serverHooks:g}=y,x="/api/verify-identity/route";function w(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:h})}},11826:(e,t,r)=>{r.d(t,{L:()=>l});var i=r(66291),a=r(64617),s=r(3390),n=r.n(s),o=r(83178),u=r(59521);let l={adapter:(0,a.N)(o.default),providers:[(0,i.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e,t){if(!e?.email||!e?.password)return null;let r=t?.headers?.["x-real-ip"],i=t?.headers?.["x-forwarded-for"],a=r?Array.isArray(r)?r[0]:r:i&&(Array.isArray(i)?i[0]:i).split(",").pop()?.trim()||"unknown",s=t?.headers?.["user-agent"]||"unknown";if(!(await (0,u.d5)(a,e.email)).allowed)throw await (0,u.Ky)(e.email,a,5,void 0),Error("ACCOUNT_LOCKED");let l=await o.default.user.findUnique({where:{email:e.email}});return l?await n().compare(e.password,l.password)?(await (0,u.LW)(a,l.id,l.email,s),await o.default.user.update({where:{id:l.id},data:{lastLoginAt:new Date}}),{id:l.id,email:l.email,name:l.name,role:l.role}):(await (0,u.Vm)(a,e.email,s,"Invalid password"),null):(await (0,u.Vm)(a,e.email,s,"User not found"),null)}})],session:{strategy:"jwt",maxAge:86400,updateAge:300},jwt:{maxAge:86400},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.role=t.role),e),session:async({session:e,token:t})=>(e?.user&&(e.user.id=t?.id,e.user.role=t?.role),e)},pages:{signIn:"/giris"},secret:process.env.NEXTAUTH_SECRET,cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}}}},94891:(e,t,r)=>{r.d(t,{createS3Client:()=>s,getBucketConfig:()=>a});var i=r(21841);function a(){return{bucketName:process.env.AWS_BUCKET_NAME??"",folderPrefix:process.env.AWS_FOLDER_PREFIX??""}}function s(){return new i.S3Client({})}},43455:(e,t,r)=>{r.d(t,{RP:()=>o,getFileUrl:()=>u,hM:()=>l});var i=r(21841),a=r(44105),s=r(94891);let n=(0,s.createS3Client)();async function o(e,t,r=!1,o=!1){let{bucketName:u,folderPrefix:l}=(0,s.getBucketConfig)(),d=r?`${l}public/uploads/${Date.now()}-${e}`:`${l}uploads/${Date.now()}-${e}`,c=new i.PutObjectCommand({Bucket:u,Key:d,ContentType:t,...o?{ContentDisposition:"attachment"}:{}});return{uploadUrl:await (0,a.e)(n,c,{expiresIn:3600}),cloud_storage_path:d,requiresContentDisposition:o}}async function u(e,t=!1){let{bucketName:r}=(0,s.getBucketConfig)();if(t){let t=process.env.AWS_REGION||"us-east-1";return`https://${r}.s3.${t}.amazonaws.com/${e}`}let o=new i.GetObjectCommand({Bucket:r,Key:e,ResponseContentDisposition:"attachment"});return await (0,a.e)(n,o,{expiresIn:3600})}async function l(e,t,r,a=!1){let{bucketName:o,folderPrefix:u}=(0,s.getBucketConfig)(),l=a?`${u}public/uploads/${Date.now()}-${t}`:`${u}uploads/identity/${Date.now()}-${t}`,d=new i.PutObjectCommand({Bucket:o,Key:l,Body:e,ContentType:r,ContentDisposition:a?"attachment":void 0});return await n.send(d),l}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[8412,7609,3390,1472,4105,9521],()=>r(40688));module.exports=i})();