"use strict";(()=>{var e={};e.id=3625,e.ids=[3625],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},76282:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>T,patchFetch:()=>A,requestAsyncStorage:()=>j,routeModule:()=>q,serverHooks:()=>V,staticGenerationAsyncStorage:()=>R});var r={};a.r(r),a.d(r,{GET:()=>D,POST:()=>C});var i=a(79182),n=a(72007),s=a(56719),o=a(93442),l=a(57978),u=a(11826),d=a(83178);async function c(e){if(await d.default.wishItem.count({where:{userId:e.userId,status:"active"}})>=10)throw Error("Maksimum 10 aktif istek oluşturabilirsiniz");let t=new Date(e.expiresInDays?Date.now()+864e5*e.expiresInDays:Date.now()+2592e6),a=await d.default.wishItem.create({data:{userId:e.userId,wantTitle:e.wantTitle,wantDescription:e.wantDescription,wantCategory:e.wantCategory,wantMinValue:e.wantMinValue,wantMaxValue:e.wantMaxValue,wantImages:e.wantImages?JSON.stringify(e.wantImages):null,offerType:e.offerType,offerProductId:e.offerProductId,offerCategory:e.offerCategory,offerDescription:e.offerDescription,preferredCity:e.preferredCity,preferredDistrict:e.preferredDistrict,maxDistance:e.maxDistance,isUrgent:e.isUrgent||!1,expiresAt:t},include:{user:{select:{id:!0,name:!0,image:!0,location:!0}}}});return await f(a.id),a}async function w(e,t,a){let r=await d.default.wishItem.findUnique({where:{id:e}});if(!r||r.userId!==t)throw Error("Yetki yok");if("active"!==r.status)throw Error("Sadece aktif istekler g\xfcncellenebilir");let i=await d.default.wishItem.update({where:{id:e},data:{...a.wantTitle&&{wantTitle:a.wantTitle},...void 0!==a.wantDescription&&{wantDescription:a.wantDescription},...a.wantCategory&&{wantCategory:a.wantCategory},...void 0!==a.wantMinValue&&{wantMinValue:a.wantMinValue},...void 0!==a.wantMaxValue&&{wantMaxValue:a.wantMaxValue},...void 0!==a.preferredCity&&{preferredCity:a.preferredCity},...void 0!==a.isUrgent&&{isUrgent:a.isUrgent},...void 0!==a.offerDescription&&{offerDescription:a.offerDescription}}});return await f(e),i}async function m(e,t){let a=await d.default.wishItem.findUnique({where:{id:e}});if(!a||a.userId!==t)throw Error("Yetki yok");await d.default.wishItem.update({where:{id:e},data:{status:"cancelled"}})}async function p(e,t){let a=await d.default.wishItem.findUnique({where:{id:e}});if(!a||a.userId!==t)throw Error("Yetki yok");await d.default.wishItem.update({where:{id:e},data:{status:"fulfilled"}})}async function f(e){let t=await d.default.wishItem.findUnique({where:{id:e},include:{user:{select:{id:!0,location:!0}}}});if(!t||"active"!==t.status)return{wishItemId:e,matches:[]};let a=[];a.push(...await g(t)),a.push(...await y(t)),a.sort((e,t)=>t.score-e.score);let r=a.slice(0,10);for(let t of(await d.default.wishMatch.deleteMany({where:{wishItemId:e}}),r))await d.default.wishMatch.create({data:{wishItemId:e,matchType:t.type,matchedUserId:t.matchedUserId,matchedProductId:t.matchedProductId,cycleData:t.cycleData?JSON.stringify(t.cycleData):null,score:t.score}});return await d.default.wishItem.update({where:{id:e},data:{matchCount:r.length}}),{wishItemId:e,matches:r}}async function g(e){let t=await d.default.category.findFirst({where:{OR:[{slug:e.wantCategory},{name:e.wantCategory}]}}),a={status:"active",userId:{not:e.userId}};return t&&(a.categoryId=t.id),e.wantMinValue&&(a.valorpiyadegeri={...a.valorpiyadegeri,gte:e.wantMinValue}),e.wantMaxValue&&(a.valorpiyadegeri={...a.valorpiyadegeri,lte:e.wantMaxValue}),(await d.default.product.findMany({where:a,include:{user:{select:{id:!0,name:!0,image:!0,location:!0}},category:{select:{name:!0,slug:!0}}},take:20})).map(t=>{let a=50;if((t.category?.slug===e.wantCategory||t.category?.name===e.wantCategory)&&(a+=20),e.wantMinValue&&e.wantMaxValue){let r=(e.wantMinValue+e.wantMaxValue)/2;a+=Math.max(0,15-Math.abs((t.valorpiyadegeri||0)-r)/r*30)}let r=t.city||t.user?.location?.split(",")[0]?.trim();e.preferredCity&&r&&r.toLowerCase().includes(e.preferredCity.toLowerCase())&&(a+=10);let i=e.wantTitle.toLowerCase().split(/\s+/),n=t.title.toLowerCase().split(/\s+/);a+=Math.min(10,3*i.filter(e=>n.includes(e)&&e.length>2).length);let s=[];try{s=t.images?"string"==typeof t.images?JSON.parse(t.images):t.images:[]}catch{s=[]}return{type:"direct",score:Math.min(100,Math.round(a)),matchedUserId:t.userId,matchedProductId:t.id,productTitle:t.title,productImage:s[0]||void 0,userName:t.user?.name||void 0,userCity:r||void 0,description:`${t.title} - ${t.valorpiyadegeri||0}V`}})}async function y(e){if(!e.offerCategory)return[];let t=await d.default.wishItem.findMany({where:{status:"active",userId:{not:e.userId},wantCategory:e.offerCategory},include:{user:{select:{id:!0,name:!0,image:!0,location:!0}}},take:50}),a=[];for(let r of t){let t=r.wantCategory===e.offerCategory,i=!!r.offerCategory&&e.wantCategory===r.offerCategory;if(t&&i){let t=60;e.preferredCity&&r.user?.location?.includes(e.preferredCity)&&(t+=15),a.push({type:"direct",score:Math.min(100,t),matchedUserId:r.userId,userName:r.user?.name||void 0,userCity:r.user?.location||void 0,description:`Karşılıklı eşleşme: ${r.wantTitle} ↔ ${e.wantTitle}`})}}return a}async function h(e){let t={status:"active",expiresAt:{gt:new Date}};e.category&&(t.wantCategory=e.category),e.city&&(t.preferredCity=e.city),e.district&&(t.preferredDistrict=e.district),e.isUrgent&&(t.isUrgent=!0),e.minValue&&(t.wantMinValue={gte:e.minValue}),e.maxValue&&(t.wantMaxValue={lte:e.maxValue}),e.search&&(t.OR=[{wantTitle:{contains:e.search,mode:"insensitive"}},{wantDescription:{contains:e.search,mode:"insensitive"}}]);let[a,r]=await Promise.all([d.default.wishItem.findMany({where:t,include:{user:{select:{id:!0,name:!0,image:!0,location:!0}},matches:{where:{score:{gte:50}},orderBy:{score:"desc"},take:3}},orderBy:[{isUrgent:"desc"},{createdAt:"desc"}],take:e.limit||20,skip:e.offset||0}),d.default.wishItem.count({where:t})]);return{wishes:a,total:r}}async function x(e){return d.default.wishItem.findMany({where:{userId:e},include:{matches:{orderBy:{score:"desc"},take:5}},orderBy:{createdAt:"desc"}})}async function z(e){let t=await d.default.wishItem.findUnique({where:{id:e},include:{user:{select:{id:!0,name:!0,image:!0,location:!0,trustScore:!0}},matches:{orderBy:{score:"desc"},take:10}}});return t&&await d.default.wishItem.update({where:{id:e},data:{viewCount:{increment:1}}}),t}async function k(e,t,a){let r=await d.default.wishMatch.findUnique({where:{id:e},include:{wishItem:{select:{userId:!0}}}});if(!r||r.wishItem.userId!==t)throw Error("Yetki yok");await d.default.wishMatch.update({where:{id:e},data:{status:a,respondedAt:["accepted","rejected"].includes(a)?new Date:void 0}})}async function I(){return{topCategories:await d.default.wishItem.groupBy({by:["wantCategory"],where:{status:"active"},_count:{id:!0},orderBy:{_count:{id:"desc"}},take:10}),totalActive:await d.default.wishItem.count({where:{status:"active"}}),totalMatches:await d.default.wishMatch.count({where:{score:{gte:50}}})}}var M=a(81510),v=a(92054),b=a(85698);async function C(e){let t=await (0,l.getServerSession)(u.L),a=t?.user?.id;if(!a)return o.NextResponse.json({error:"Oturum a\xe7manız gerekiyor"},{status:401});let r=e.headers.get("x-forwarded-for")?.split(",")[0]?.trim()||"unknown";if(!(await (0,b.Dn)(r,"api/wishboard")).allowed)return o.NextResponse.json({error:"\xc7ok fazla istek. L\xfctfen biraz bekleyin."},{status:429});try{let t=await e.json(),{action:r}=t;switch(r){case"create":{let{success:e,error:r}=(0,M.Gu)(M.QT,t);if(!e)return o.NextResponse.json({error:r},{status:400});let i=(0,v.oO)(t.wantTitle),n=t.wantDescription?(0,v.oO)(t.wantDescription):void 0,s=await c({userId:a,wantTitle:i,wantDescription:n,wantCategory:t.wantCategory,wantMinValue:t.wantMinValue,wantMaxValue:t.wantMaxValue,wantImages:t.wantImages,offerType:t.offerType,offerProductId:t.offerProductId,offerCategory:t.offerCategory,offerDescription:t.offerDescription,preferredCity:t.preferredCity,preferredDistrict:t.preferredDistrict,maxDistance:t.maxDistance,isUrgent:t.isUrgent,expiresInDays:t.expiresInDays});return o.NextResponse.json({success:!0,wish:s})}case"update":{let e=await w(t.wishId,a,t.updates);return o.NextResponse.json({success:!0,wish:e})}case"cancel":return await m(t.wishId,a),o.NextResponse.json({success:!0});case"fulfill":return await p(t.wishId,a),o.NextResponse.json({success:!0});case"find_matches":{let e=await f(t.wishId);return o.NextResponse.json({success:!0,...e})}case"update_match_status":return await k(t.matchId,a,t.status),o.NextResponse.json({success:!0});default:return o.NextResponse.json({error:"Ge\xe7ersiz işlem"},{status:400})}}catch(e){return console.error("Wishboard API error:",e),o.NextResponse.json({error:e.message||"Bir hata oluştu"},{status:400})}}async function D(e){let{searchParams:t}=new URL(e.url);try{let e=t.get("id");if(e){let t=await z(e);if(!t)return o.NextResponse.json({error:"İstek bulunamadı"},{status:404});return o.NextResponse.json({wish:t})}if("true"===t.get("my")){let e=await (0,l.getServerSession)(u.L),t=e?.user?.id;if(!t)return o.NextResponse.json({error:"Oturum a\xe7manız gerekiyor"},{status:401});let a=await x(t);return o.NextResponse.json({wishes:a})}if("true"===t.get("stats")){let e=await I();return o.NextResponse.json(e)}let a=await h({category:t.get("category")||void 0,city:t.get("city")||void 0,district:t.get("district")||void 0,isUrgent:"true"===t.get("urgent"),search:t.get("q")||void 0,minValue:t.get("minValue")?parseInt(t.get("minValue")):void 0,maxValue:t.get("maxValue")?parseInt(t.get("maxValue")):void 0,limit:parseInt(t.get("limit")||"20"),offset:parseInt(t.get("offset")||"0")});return o.NextResponse.json(a)}catch(e){return console.error("Wishboard GET error:",e),o.NextResponse.json({error:e.message||"Bir hata oluştu"},{status:400})}}let q=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/wishboard/route",pathname:"/api/wishboard",filename:"route",bundlePath:"app/api/wishboard/route"},resolvedPagePath:"/home/ubuntu/takas-a-kodlar/nextjs_space/app/api/wishboard/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:j,staticGenerationAsyncStorage:R,serverHooks:V}=q,T="/api/wishboard/route";function A(){return(0,s.patchFetch)({serverHooks:V,staticGenerationAsyncStorage:R})}},11826:(e,t,a)=>{a.d(t,{L:()=>u});var r=a(66291),i=a(64617),n=a(3390),s=a.n(n),o=a(83178),l=a(59521);let u={adapter:(0,i.N)(o.default),providers:[(0,r.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e,t){if(!e?.email||!e?.password)return null;let a=t?.headers?.["x-real-ip"],r=t?.headers?.["x-forwarded-for"],i=a?Array.isArray(a)?a[0]:a:r&&(Array.isArray(r)?r[0]:r).split(",").pop()?.trim()||"unknown",n=t?.headers?.["user-agent"]||"unknown";if(!(await (0,l.d5)(i,e.email)).allowed)throw await (0,l.Ky)(e.email,i,5,void 0),Error("ACCOUNT_LOCKED");let u=await o.default.user.findUnique({where:{email:e.email}});return u?await s().compare(e.password,u.password)?(await (0,l.LW)(i,u.id,u.email,n),await o.default.user.update({where:{id:u.id},data:{lastLoginAt:new Date}}),{id:u.id,email:u.email,name:u.name,role:u.role}):(await (0,l.Vm)(i,e.email,n,"Invalid password"),null):(await (0,l.Vm)(i,e.email,n,"User not found"),null)}})],session:{strategy:"jwt",maxAge:86400,updateAge:300},jwt:{maxAge:86400},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.role=t.role),e),session:async({session:e,token:t})=>(e?.user&&(e.user.id=t?.id,e.user.role=t?.role),e)},pages:{signIn:"/giris"},secret:process.env.NEXTAUTH_SECRET,cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}}}},85698:(e,t,a)=>{a.d(t,{Dn:()=>s,s$:()=>o});var r=a(83178),i=a(59521);let n={"api/products":{windowMs:6e4,maxRequests:100},"api/favorites":{windowMs:6e4,maxRequests:60},"api/messages":{windowMs:6e4,maxRequests:30},"api/signup":{windowMs:36e5,maxRequests:5},"api/swap-requests":{windowMs:6e4,maxRequests:20},"api/services":{windowMs:6e4,maxRequests:30},"api/wishboard":{windowMs:6e4,maxRequests:20},"api/profile/photo":{windowMs:3e5,maxRequests:10},"api/admin/backup":{windowMs:36e5,maxRequests:3},"api/auth/two-factor":{windowMs:3e5,maxRequests:5},"api/valor/calculate":{windowMs:6e4,maxRequests:5},"api/ai-visualize":{windowMs:6e4,maxRequests:5},"api/visual-search":{windowMs:6e4,maxRequests:5},"api/ai-moderation":{windowMs:6e4,maxRequests:10},"api/ai-translate":{windowMs:6e4,maxRequests:10},default:{windowMs:6e4,maxRequests:100}};async function s(e,t){if(["join@takas-a.com"].includes(e))return{allowed:!0,remaining:999,resetAt:new Date(Date.now()+6e4)};let a=n[t]||n.default,i=new Date,s=new Date(i.getTime()-a.windowMs);try{let n=await r.default.rateLimit.findUnique({where:{identifier_endpoint:{identifier:e,endpoint:t}}});if(!n)return await r.default.rateLimit.create({data:{identifier:e,endpoint:t,count:1,windowStart:i}}),{allowed:!0,remaining:a.maxRequests-1,resetAt:new Date(i.getTime()+a.windowMs)};if(n.windowStart<s)return await r.default.rateLimit.update({where:{id:n.id},data:{count:1,windowStart:i}}),{allowed:!0,remaining:a.maxRequests-1,resetAt:new Date(i.getTime()+a.windowMs)};if(n.count>=a.maxRequests){let e=new Date(n.windowStart.getTime()+a.windowMs);return{allowed:!1,remaining:0,resetAt:e}}return await r.default.rateLimit.update({where:{id:n.id},data:{count:n.count+1}}),{allowed:!0,remaining:a.maxRequests-n.count-1,resetAt:new Date(n.windowStart.getTime()+a.windowMs)}}catch(e){return console.error("Rate limit check error:",e),{allowed:!1,remaining:0,resetAt:new Date(i.getTime()+a.windowMs)}}}function o(e){return(0,i.H9)(e)}},92054:(e,t,a)=>{a.d(t,{oO:()=>r});function r(e){return e&&"string"==typeof e?e.trim().replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/on\w+\s*=\s*["'][^"']*["']/gi,"").replace(/javascript\s*:/gi,"").replace(/data\s*:\s*text\/html/gi,"").replace(/<iframe/gi,"&lt;iframe").replace(/<object/gi,"&lt;object").replace(/<embed/gi,"&lt;embed").replace(/<form/gi,"&lt;form"):""}},81510:(e,t,a)=>{a.d(t,{C$:()=>n,Gu:()=>u,QT:()=>l,if:()=>c,lw:()=>o,qi:()=>s,td:()=>i});var r=a(91209);let i=r.z.object({title:r.z.string().min(3,"Başlık en az 3 karakter").max(200,"Başlık en fazla 200 karakter").trim(),description:r.z.string().min(10,"A\xe7ıklama en az 10 karakter").max(5e3).trim(),valorPrice:r.z.number().int().min(1,"Değer en az 1 Valor").max(1e5,"Değer en fazla 100000 Valor"),condition:r.z.enum(["new","like_new","good","fair","poor"]).default("good"),categoryId:r.z.string().min(1,"Kategori se\xe7iniz"),city:r.z.string().default("İzmir"),district:r.z.string().optional(),images:r.z.array(r.z.string()).max(10,"En fazla 10 g\xf6rsel").optional(),latitude:r.z.number().optional(),longitude:r.z.number().optional(),usageInfo:r.z.string().optional(),checklistData:r.z.string().optional(),userValorPrice:r.z.number().optional(),acceptsNegotiation:r.z.boolean().optional(),isFreeAvailable:r.z.boolean().optional()}),n=r.z.object({productId:r.z.string().min(1,"\xdcr\xfcn ID gerekli"),message:r.z.string().max(1e3,"Mesaj en fazla 1000 karakter").optional(),offeredProductId:r.z.string().nullable().optional(),offeredValor:r.z.number().int().min(0).max(1e5).optional(),quickOffer:r.z.boolean().optional(),smartMatch:r.z.boolean().optional()}),s=r.z.object({receiverId:r.z.string().min(1,"Alıcı ID gerekli"),content:r.z.string().min(1,"Mesaj boş olamaz").max(5e3,"Mesaj en fazla 5000 karakter").trim(),productId:r.z.string().optional(),image:r.z.string().optional()});r.z.object({name:r.z.string().min(2,"İsim en az 2 karakter").max(100).trim().optional(),phone:r.z.string().regex(/^(\+90|0)?[0-9]{10}$/,"Ge\xe7ersiz telefon numarası").optional().nullable(),city:r.z.string().max(100).optional(),district:r.z.string().max(100).optional(),bio:r.z.string().max(500).optional()});let o=r.z.object({title:r.z.string().min(3,"Başlık en az 3 karakter").max(200).trim(),description:r.z.string().min(10,"A\xe7ıklama en az 10 karakter").max(5e3).trim(),category:r.z.enum(["cleaning","electrical","plumbing","beauty","education","cooking","repair","delivery","design","photography","other"]),duration:r.z.string().max(50),valorPrice:r.z.number().int().min(1,"Değer en az 1 Valor").max(1e5),city:r.z.string().default("İzmir"),district:r.z.string().optional(),serviceArea:r.z.string().optional(),wantCategory:r.z.string().optional(),wantDescription:r.z.string().max(500).optional(),listingType:r.z.enum(["individual","business"]).default("individual"),businessName:r.z.string().max(200).optional(),businessType:r.z.string().optional(),unitType:r.z.string().optional(),unitCount:r.z.number().int().optional(),images:r.z.array(r.z.string()).optional()}),l=r.z.object({wantTitle:r.z.string().min(3,"Başlık en az 3 karakter").max(200).trim(),wantDescription:r.z.string().max(2e3).optional(),wantCategory:r.z.string().min(1,"Kategori gerekli"),wantMinValue:r.z.number().int().min(0).optional(),wantMaxValue:r.z.number().int().max(1e5).optional(),offerType:r.z.enum(["specific_product","category","any"]).default("any"),preferredCity:r.z.string().optional(),isUrgent:r.z.boolean().default(!1),offerProductId:r.z.string().optional(),offerCategory:r.z.string().optional(),offerTitle:r.z.string().optional(),offerDescription:r.z.string().optional(),offerMinValue:r.z.number().optional(),offerMaxValue:r.z.number().optional(),deadline:r.z.string().optional(),urgencyBonus:r.z.number().optional()});function u(e,t){try{let a=e.parse(t);return{success:!0,data:a}}catch(e){if(e instanceof r.z.ZodError)return{success:!1,error:e.errors.map(e=>e.message).join(", ")};return{success:!1,error:"Ge\xe7ersiz veri"}}}let d=r.z.string().min(8,"Şifre en az 8 karakter olmalı").max(128,"Şifre en fazla 128 karakter olabilir").refine(e=>/[A-Z]/.test(e),"En az 1 b\xfcy\xfck harf gerekli").refine(e=>/[a-z]/.test(e),"En az 1 k\xfc\xe7\xfck harf gerekli").refine(e=>/[0-9]/.test(e),"En az 1 rakam gerekli"),c=r.z.object({email:r.z.string().email("Ge\xe7erli bir e-posta girin").trim().toLowerCase(),password:d,name:r.z.string().min(2,"İsim en az 2 karakter").max(100).trim(),nickname:r.z.string().min(2).max(50).trim().optional()});r.z.object({currentPassword:r.z.string().min(1,"Mevcut şifre gerekli"),newPassword:d})}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8412,7609,3390,1472,1209,9521],()=>a(76282));module.exports=r})();