"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8392],{38392:function(e,t,s){s.r(t),s.d(t,{PWAProvider:function(){return w},usePushNotifications:function(){return f}});var i=s(15444),n=s(89300),a=s(75762),r=s(79047),l=s(33485),o=s(95181),c=s(26584),d=s(20321),u=s(39551),h=s(29046),m=s(82717);let p="BOlBaaC047bCq8RXHRkz7Eg3pp66EiiH5GgjYncOeWPhVwtPtE-fCMeguexDcpp3sdNC8XBdMP0CKyexg8kOA4w";function x(e){let t="=".repeat((4-e.length%4)%4),s=(e+t).replace(/-/g,"+").replace(/_/g,"/"),i=window.atob(s),n=new Uint8Array(i.length);for(let e=0;e<i.length;++e)n[e]=i.charCodeAt(e);return n}function g(){let e=navigator.userAgent.match(/OS (\d+)_(\d+)/);return e?parseFloat(`${e[1]}.${e[2]}`):null}function w({children:e}){let{data:t}=(0,a.useSession)(),s=(0,r.useRouter)(),{t:w}=(0,m.Z)(),[f,b]=(0,n.useState)(null),[v,j]=(0,n.useState)(!1),[N,S]=(0,n.useState)(!1),[y,k]=(0,n.useState)(!1),[P,A]=(0,n.useState)(!1),[E,C]=(0,n.useState)(!1),[W,O]=(0,n.useState)(!1),[D,I]=(0,n.useState)(!1),[T,L]=(0,n.useState)(!1),[M,Z]=(0,n.useState)(null),z=(0,n.useRef)(new Map),B=(0,n.useRef)(!1),R=(0,n.useCallback)(e=>{if(!z.current.has(e)){let t=new Audio(e);t.preload="auto",z.current.set(e,t)}return z.current.get(e)},[]),_=(0,n.useCallback)(()=>{B.current||(["/sounds/message.mp3","/sounds/notification.mp3","/sounds/swap-offer.mp3","/sounds/coin.mp3","/sounds/match.mp3"].forEach(e=>{let t=R(e);t.volume=0,t.play().then(()=>t.pause()).catch(()=>{})}),B.current=!0,console.log("[PWA] Sounds unlocked"))},[R]);(0,n.useEffect)(()=>{if(!("serviceWorker"in navigator))return;let e=e=>{let{type:t,sound:i,url:n}=e.data||{};if("PLAY_SOUND"===t&&i){console.log("[PWA] Playing sound:",i);try{let e=R(i);e.volume=1,e.currentTime=0,e.play().catch(e=>console.warn("[PWA] Sound play failed:",e))}catch(e){console.warn("[PWA] Sound error:",e)}}"NAVIGATE"===t&&n&&(console.log("[PWA] Navigating to:",n),s.push(n))};navigator.serviceWorker.addEventListener("message",e);let t=()=>{_(),document.removeEventListener("touchstart",t),document.removeEventListener("click",t)};return document.addEventListener("touchstart",t,{once:!0}),document.addEventListener("click",t,{once:!0}),()=>{navigator.serviceWorker.removeEventListener("message",e),document.removeEventListener("touchstart",t),document.removeEventListener("click",t)}},[R,s,_]),(0,n.useEffect)(()=>{let e=window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone;A(e);let t=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;if(k(t),t){let e=g();Z(e),console.log("[PWA] iOS version:",e)}"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(s=>{if(console.log("[PWA] Service Worker registered:",s.scope),"PushManager"in window&&"Notification"in window){if(t){let t=g();e?t&&t<16.4?(console.log("[Push] iOS - Push requires iOS 16.4+, current:",t),C(!1)):(console.log("[Push] iOS PWA - Push supported"),C(!0),q(s)):(console.log("[Push] iOS - Push requires PWA installation first"),C(!1))}else console.log("[Push] Push supported (Android/Desktop)"),C(!0),q(s)}}).catch(e=>{console.error("[PWA] Service Worker registration failed:",e)});let s=e=>{e.preventDefault(),console.log("[PWA] beforeinstallprompt event received"),b(e);let t=localStorage.getItem("pwa-install-dismissed"),s=t?parseInt(t):0,i=(Date.now()-s)/36e5;!t||i>6?(console.log("[PWA] Showing install banner in 1 second"),setTimeout(()=>j(!0),1e3)):console.log("[PWA] Install banner dismissed recently, waiting")};if(window.addEventListener("beforeinstallprompt",s),window.addEventListener("appinstalled",()=>{console.log("[PWA] App installed"),j(!1),S(!1),b(null),window.dispatchEvent(new CustomEvent("pwaInstallEnded"))}),t&&!e){let e=localStorage.getItem("pwa-install-dismissed"),t=e?parseInt(e):0,s=(Date.now()-t)/36e5;(!e||s>6)&&(console.log("[PWA] iOS - Showing install instructions in 1.5 seconds"),setTimeout(()=>S(!0),1500))}return()=>{window.removeEventListener("beforeinstallprompt",s)}},[]),(0,n.useEffect)(()=>{t?.user&&E&&H()},[t,E]),(0,n.useEffect)(()=>{if(t?.user&&E&&!W&&!localStorage.getItem("push-banner-dismissed")){let e=setTimeout(()=>{v||I(!0)},5e3);return()=>clearTimeout(e)}},[t,E,W,v]);let q=async e=>{try{let t=await e.pushManager.getSubscription();O(!!t)}catch(e){console.error("[Push] Check subscription error:",e)}},H=async()=>{try{let e=await fetch("/api/push/subscribe"),t=await e.json();O(t.subscribed)}catch(e){console.error("[Push] Server check error:",e)}},J=async()=>{if(E&&p){L(!0);try{let e=await navigator.serviceWorker.ready,t=await Notification.requestPermission();if("granted"!==t){console.log("[Push] Permission denied"),L(!1);return}let s=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:x(p)});(await fetch("/api/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscription:s.toJSON(),userAgent:navigator.userAgent})})).ok&&(O(!0),I(!1),console.log("[Push] Subscribed successfully"))}catch(e){console.error("[Push] Subscribe error:",e)}L(!1)}},K=async()=>{if(!f)return;window.dispatchEvent(new CustomEvent("pwaInstallStarted")),await f.prompt();let{outcome:e}=await f.userChoice;"accepted"===e?console.log("[PWA] User accepted install"):window.dispatchEvent(new CustomEvent("pwaInstallEnded")),b(null),j(!1)},V=()=>{j(!1),localStorage.setItem("pwa-install-dismissed",Date.now().toString())},U=()=>{I(!1),localStorage.setItem("push-banner-dismissed",Date.now().toString())};return P?(0,i.jsx)(i.Fragment,{children:e}):(0,i.jsxs)(i.Fragment,{children:[e,v&&f&&(0,i.jsxs)("div",{className:"fixed inset-0 flex items-center justify-center z-[100] px-4",children:[(0,i.jsx)("div",{className:"absolute inset-0 bg-black/40 backdrop-blur-sm",onClick:V}),(0,i.jsxs)("div",{className:"relative bg-gradient-to-br from-sky-500 via-cyan-500 to-teal-500 text-white rounded-3xl shadow-2xl p-6 w-full max-w-sm animate-scale-in",children:[(0,i.jsx)("button",{onClick:V,className:"absolute top-3 right-3 p-2 hover:bg-white/20 rounded-full transition-colors",children:(0,i.jsx)(l.Z,{className:"w-5 h-5"})}),(0,i.jsxs)("div",{className:"flex flex-col items-center text-center gap-4",children:[(0,i.jsx)("div",{className:"w-20 h-20 bg-white/20 rounded-2xl flex items-center justify-center",children:(0,i.jsx)(o.Z,{className:"w-10 h-10"})}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h3",{className:"font-bold text-xl",children:w("installApp")}),(0,i.jsx)("p",{className:"text-sm text-white/90 mt-2",children:w("addToHomeDesc")})]}),(0,i.jsxs)("button",{onClick:K,className:"w-full px-6 py-3 bg-white text-sky-600 font-bold rounded-xl hover:bg-white/90 transition-colors flex items-center justify-center gap-2 text-lg shadow-lg",children:[(0,i.jsx)(c.Z,{className:"w-5 h-5"}),w("install")]}),(0,i.jsx)("button",{onClick:V,className:"text-white/70 text-sm hover:text-white transition-colors",children:w("notNow")})]})]})]}),N&&y&&(0,i.jsxs)("div",{className:"fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-[420px] bg-gradient-to-r from-sky-500 to-cyan-500 text-white rounded-2xl shadow-2xl p-4 z-50 animate-slide-up",children:[(0,i.jsx)("button",{onClick:()=>{S(!1),localStorage.setItem("pwa-install-dismissed",Date.now().toString())},className:"absolute top-2 right-2 p-1 hover:bg-white/20 rounded-full transition-colors",children:(0,i.jsx)(l.Z,{className:"w-5 h-5"})}),(0,i.jsxs)("div",{className:"flex items-start gap-3",children:[(0,i.jsx)("div",{className:"w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center flex-shrink-0",children:(0,i.jsx)(o.Z,{className:"w-6 h-6"})}),(0,i.jsxs)("div",{className:"flex-1",children:[(0,i.jsx)("h3",{className:"font-semibold text-lg",children:w("installOnIphone")}),(0,i.jsxs)("div",{className:"text-sm text-white/90 mt-2 space-y-2",children:[(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)("span",{className:"w-5 h-5 bg-white/30 rounded-full flex items-center justify-center text-xs font-bold",children:"1"}),(0,i.jsxs)("span",{children:[(0,i.jsx)(d.Z,{className:"w-4 h-4 inline"})," ",w("iosStep1")]})]}),(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)("span",{className:"w-5 h-5 bg-white/30 rounded-full flex items-center justify-center text-xs font-bold",children:"2"}),(0,i.jsxs)("span",{children:[(0,i.jsx)(u.Z,{className:"w-4 h-4 inline"})," ",w("iosStep2")]})]}),(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)("span",{className:"w-5 h-5 bg-white/30 rounded-full flex items-center justify-center text-xs font-bold",children:"3"}),(0,i.jsx)("span",{children:w("iosStep3")})]})]}),M&&M>=16.4&&(0,i.jsxs)("p",{className:"text-xs text-white/70 mt-2 bg-white/10 rounded p-2",children:["\uD83D\uDCA1 ",w("notificationsAfterInstall")]})]})]})]}),D&&t?.user&&E&&(0,i.jsxs)("div",{className:"fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-96 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-2xl shadow-2xl p-4 z-50 animate-slide-up",children:[(0,i.jsx)("button",{onClick:U,className:"absolute top-2 right-2 p-1 hover:bg-white/20 rounded-full transition-colors",children:(0,i.jsx)(l.Z,{className:"w-5 h-5"})}),(0,i.jsxs)("div",{className:"flex items-start gap-3",children:[(0,i.jsx)("div",{className:"w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center flex-shrink-0",children:(0,i.jsx)(h.Z,{className:"w-6 h-6"})}),(0,i.jsxs)("div",{className:"flex-1",children:[(0,i.jsx)("h3",{className:"font-semibold text-lg",children:w("enableNotifications")}),(0,i.jsx)("p",{className:"text-sm text-white/90 mt-1",children:w("notificationsDesc")}),(0,i.jsxs)("button",{onClick:J,disabled:T,className:"mt-3 px-4 py-2 bg-white text-purple-600 font-medium rounded-lg hover:bg-white/90 transition-colors flex items-center gap-2 disabled:opacity-50",children:[(0,i.jsx)(h.Z,{className:"w-4 h-4"}),w(T?"enablingNotifications":"enableNotifications")]})]})]})]}),D&&t?.user&&y&&!P&&!E&&(0,i.jsxs)("div",{className:"fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-96 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-2xl shadow-2xl p-4 z-50 animate-slide-up",children:[(0,i.jsx)("button",{onClick:U,className:"absolute top-2 right-2 p-1 hover:bg-white/20 rounded-full transition-colors",children:(0,i.jsx)(l.Z,{className:"w-5 h-5"})}),(0,i.jsxs)("div",{className:"flex items-start gap-3",children:[(0,i.jsx)("div",{className:"w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center flex-shrink-0",children:(0,i.jsx)(h.Z,{className:"w-6 h-6"})}),(0,i.jsxs)("div",{className:"flex-1",children:[(0,i.jsx)("h3",{className:"font-semibold text-lg",children:"Bildirimler İ\xe7in"}),(0,i.jsx)("p",{className:"text-sm text-white/90 mt-1",children:"iPhone'da bildirim almak i\xe7in \xf6nce TAKAS-A'yı ana ekrana eklemelisiniz."}),M&&M<16.4&&(0,i.jsxs)("p",{className:"text-xs text-white/70 mt-2",children:["⚠️ iOS ",M," kullanıyorsunuz. Bildirimler i\xe7in iOS 16.4+ gerekli."]})]})]})]})]})}function f(){let[e,t]=(0,n.useState)(!1),[s,i]=(0,n.useState)(!1),[a,r]=(0,n.useState)(!1);(0,n.useEffect)(()=>{"serviceWorker"in navigator&&"PushManager"in window&&(t(!0),l())},[]);let l=async()=>{try{let e=await fetch("/api/push/subscribe"),t=await e.json();i(t.subscribed)}catch(e){console.error("Check subscription error:",e)}},o=async()=>{if(!e)return!1;r(!0);try{let e=await navigator.serviceWorker.ready,t=await Notification.requestPermission();if("granted"!==t)return r(!1),!1;let s=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:x("BOlBaaC047bCq8RXHRkz7Eg3pp66EiiH5GgjYncOeWPhVwtPtE-fCMeguexDcpp3sdNC8XBdMP0CKyexg8kOA4w")});if((await fetch("/api/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscription:s.toJSON(),userAgent:navigator.userAgent})})).ok)return i(!0),r(!1),!0}catch(e){console.error("Subscribe error:",e)}return r(!1),!1};return{supported:e,subscribed:s,loading:a,subscribe:o,unsubscribe:async()=>{r(!0);try{let e=await navigator.serviceWorker.ready,t=await e.pushManager.getSubscription();t&&(await t.unsubscribe(),await fetch("/api/push/subscribe",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({endpoint:t.endpoint})})),i(!1)}catch(e){console.error("Unsubscribe error:",e)}r(!1)},checkSubscription:l}}}}]);