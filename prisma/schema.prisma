generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
    output = "/home/ubuntu/takas_a_website/nextjs_space/node_modules/.prisma/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
  id                      String                    @id @default(cuid())
  name                    String?
  email                   String                    @unique
  password                String
  emailVerified           DateTime?
  image                   String?
  role                    String                    @default("user")
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  valorBalance            Int                       @default(0)
  verificationCode        String?
  verificationCodeExpiry  DateTime?
  dailyProductCount       Int                       @default(0)
  isPremium               Boolean                   @default(false)
  lastProductDate         DateTime?
  lastReferralAt          DateTime?
  premiumExpiresAt        DateTime?
  referralCode            String?                   @unique
  referredBy              String?
  stripeCustomerId        String?
  stripeSubscriptionId    String?
  totalReferrals          Int                       @default(0)
  trustScore              Int                       @default(100)
  bio                     String?
  location                String?
  phone                   String?
  surveyCompleted         Boolean                   @default(false)
  surveyData              String?
  lastActiveAt            DateTime                  @default(now())
  welcomeBonusGiven       Boolean                   @default(false)
  lastWarningAt           DateTime?
  suspendedUntil          DateTime?
  suspensionCount         Int                       @default(0)
  totalWarnings           Int                       @default(0)
  aiVisualizationCredits  Int                       @default(3)
  aiCreditsResetAt        DateTime?
  nickname                String?
  identityDocUrl          String?
  identityVerifiedAt      DateTime?
  identityVerifyStatus    String?
  isIdentityVerified      Boolean                   @default(false)
  isPhoneVerified         Boolean                   @default(false)
  lockedValor             Int                       @default(0)
  completedAchievements   String?
  lastDailyBonusAt        DateTime?
  productBonusCount       Int                       @default(0)
  reviewBonusCount        Int                       @default(0)
  pendingProductBonus     Int                       @default(0)
  loginStreak             Int                       @default(0)
  lastStreakDate          DateTime?
  totalValorEarned        Int                       @default(0)
  lastReferralResetAt     DateTime?
  monthlyReferralCount    Int                       @default(0)
  lastLoginAt             DateTime?
  errorLogs               ErrorLog[]
  exchangesReceived       Exchange[]                @relation("ExchangeReceiver")
  exchangesSent           Exchange[]                @relation("ExchangeSender")
  favorites               Favorite[]
  groupConversations      GroupConversationMember[]
  groupMessages           GroupMessage[]
  messagesReceived        Message[]                 @relation("MessageReceiver")
  messagesSent            Message[]                 @relation("MessageSender")
  multiSwapParticipations MultiSwapParticipant[]
  products                Product[]
  referredUsers           Referral[]                @relation("ReferredUser")
  referrals               Referral[]                @relation("Referrer")
  reviewsGiven            Review[]                  @relation("ReviewAuthor")
  reviewsReceived         Review[]                  @relation("ReviewTarget")
  securityLogs            SecurityLog[]
  swapRequestsReceived    SwapRequest[]             @relation("SwapOwner")
  swapRequestsSent        SwapRequest[]             @relation("SwapRequester")
  warnings                UserWarning[]
  valorSent               ValorTransaction[]        @relation("ValorSender")
  valorReceived           ValorTransaction[]        @relation("ValorReceiver")
}

model Category {
  id          String    @id @default(cuid())
  name        String
  nameEn      String?
  slug        String    @unique
  icon        String?
  description String?
  createdAt   DateTime  @default(now())
  nameCa      String?
  nameEs      String?
  products    Product[]
}

model Product {
  id                     String                 @id @default(cuid())
  title                  String
  description            String
  valorPrice             Int
  condition              String                 @default("good")
  images                 String[]
  categoryId             String
  userId                 String
  latitude               Float?
  longitude              Float?
  city                   String                 @default("İzmir")
  district               String?
  status                 String                 @default("active")
  views                  Int                    @default(0)
  aiValorReason          String?
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  usageInfo              String?
  aiValorPrice           Int?
  checklistData          String?
  userValorPrice         Int?
  isPopular              Boolean                @default(false)
  descriptionCa          String?
  descriptionEn          String?
  descriptionEs          String?
  titleCa                String?
  titleEn                String?
  titleEs                String?
  acceptsNegotiation     Boolean                @default(true)
  isFreeAvailable        Boolean                @default(false)
  exchangesSent          Exchange[]             @relation("ExchangeProduct")
  exchangesReceived      Exchange[]             @relation("ExchangeTargetProduct")
  favorites              Favorite[]
  messages               Message[]
  multiSwapItems         MultiSwapParticipant[]
  category               Category               @relation(fields: [categoryId], references: [id])
  user                   User                   @relation(fields: [userId], references: [id])
  swapRequestsAsOffer    SwapRequest[]          @relation("OfferedProduct")
  swapRequestsForProduct SwapRequest[]          @relation("RequestedProduct")

  @@index([userId])
  @@index([categoryId])
  @@index([status])
  @@index([createdAt])
  @@index([valorPrice])
}

model DeliveryPoint {
  id           String        @id @default(cuid())
  name         String
  address      String
  city         String        @default("İzmir")
  district     String
  latitude     Float
  longitude    Float
  hours        String?
  phone        String?
  isActive     Boolean       @default(true)
  image        String?
  createdAt    DateTime      @default(now())
  addressCa    String?
  addressEn    String?
  addressEs    String?
  nameCa       String?
  nameEn       String?
  nameEs       String?
  swapRequests SwapRequest[]
}

model Exchange {
  id              String   @id @default(cuid())
  senderId        String
  receiverId      String
  productId       String
  targetProductId String?
  valorAmount     Int?
  status          String   @default("pending")
  message         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  product         Product  @relation("ExchangeProduct", fields: [productId], references: [id])
  receiver        User     @relation("ExchangeReceiver", fields: [receiverId], references: [id])
  sender          User     @relation("ExchangeSender", fields: [senderId], references: [id])
  targetProduct   Product? @relation("ExchangeTargetProduct", fields: [targetProductId], references: [id])
}

model Contact {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  subject   String?
  message   String
  status    String   @default("new")
  createdAt DateTime @default(now())
}

model Message {
  id                   String   @id @default(cuid())
  content              String
  senderId             String
  receiverId           String
  productId            String?
  isRead               Boolean  @default(false)
  createdAt            DateTime @default(now())
  containsPersonalInfo Boolean  @default(false)
  isModerated          Boolean  @default(false)
  moderationReason     String?
  moderationResult     String?
  metadata             String?
  product              Product? @relation(fields: [productId], references: [id])
  receiver             User     @relation("MessageReceiver", fields: [receiverId], references: [id])
  sender               User     @relation("MessageSender", fields: [senderId], references: [id])
}

model UserWarning {
  id          String   @id @default(cuid())
  userId      String
  type        String
  severity    String
  messageId   String?
  description String?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model SwapRequest {
  id                       String             @id @default(cuid())
  requesterId              String
  ownerId                  String
  productId                String
  offeredProductId         String?
  message                  String?
  status                   String             @default("pending")
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt
  customLocation           String?
  deliveredAt              DateTime?
  deliveryConfirmDeadline  DateTime?
  deliveryMethod           String?
  deliveryPointId          String?
  pendingValorAmount       Int?
  qrCode                   String?            @unique
  qrCodeGeneratedAt        DateTime?
  receiverConfirmed        Boolean            @default(false)
  receiverConfirmedAt      DateTime?
  valorReleased            Boolean            @default(false)
  depositsLocked           Boolean            @default(false)
  escrowStatus             String?
  ownerConfirmed           Boolean            @default(false)
  ownerConfirmedAt         DateTime?
  ownerDeposit             Int?
  requesterDeposit         Int?
  deliveryVerificationCode String?
  receiverPhotos           String[]
  senderPhotos             String[]
  verificationCodeSentAt   DateTime?
  verificationCodeUsed     Boolean            @default(false)
  agreedPriceOwner         Int?
  agreedPriceRequester     Int?
  negotiationStatus        String?            @default("chatting")
  priceAgreedAt            DateTime?
  qrScannedAt              DateTime?
  disputes                 DisputeReport[]
  reviews                  Review[]
  feedback                 SwapFeedback?
  deliveryPoint            DeliveryPoint?     @relation(fields: [deliveryPointId], references: [id])
  offeredProduct           Product?           @relation("OfferedProduct", fields: [offeredProductId], references: [id])
  owner                    User               @relation("SwapOwner", fields: [ownerId], references: [id])
  product                  Product            @relation("RequestedProduct", fields: [productId], references: [id])
  requester                User               @relation("SwapRequester", fields: [requesterId], references: [id])
  valorTransactions        ValorTransaction[]

  @@index([requesterId])
  @@index([ownerId])
  @@index([productId])
  @@index([status])
  @@index([createdAt])
}

model MultiSwap {
  id              String                 @id @default(cuid())
  status          String                 @default("pending")
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  confirmedAt     DateTime?
  deliveryPointId String?
  expiresAt       DateTime
  initiatorId     String
  meetingDetails  String?
  rejectedAt      DateTime?
  rejectedById    String?
  rejectionReason String?
  participants    MultiSwapParticipant[]

  @@index([status])
  @@index([expiresAt])
  @@index([initiatorId])
}

model MultiSwapParticipant {
  id                 String    @id @default(cuid())
  multiSwapId        String
  userId             String
  givesProductId     String
  receivesFromUserId String?
  confirmed          Boolean   @default(false)
  createdAt          DateTime  @default(now())
  notifiedAt         DateTime?
  respondedAt        DateTime?
  givesProduct       Product   @relation(fields: [givesProductId], references: [id])
  multiSwap          MultiSwap @relation(fields: [multiSwapId], references: [id])
  user               User      @relation(fields: [userId], references: [id])

  @@index([multiSwapId])
  @@index([userId])
}

model Referral {
  id                  String   @id @default(cuid())
  referrerId          String
  referredUserId      String
  bonusGiven          Boolean  @default(false)
  createdAt           DateTime @default(now())
  activeBonusGiven    Boolean  @default(false)
  friendLoginCount    Int      @default(0)
  firstSwapCompleted  Boolean  @default(false)
  firstSwapCompletedAt DateTime?
  referredUser        User     @relation("ReferredUser", fields: [referredUserId], references: [id])
  referrer            User     @relation("Referrer", fields: [referrerId], references: [id])
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
}

model DisputeReport {
  id                       String      @id @default(cuid())
  swapRequestId            String
  reporterId               String
  reportedUserId           String
  type                     String
  description              String
  evidence                 String[]
  status                   String      @default("open")
  resolution               String?
  penaltyApplied           Boolean     @default(false)
  penaltyAmount            Int?
  refundApproved           Boolean     @default(false)
  adminNotes               String?
  createdAt                DateTime    @default(now())
  updatedAt                DateTime    @updatedAt
  evidenceDeadline         DateTime?
  evidenceReminderSent     Boolean     @default(false)
  reportedEvidence         String[]
  reportedEvidenceAt       DateTime?
  reportedEvidenceNote     String?
  reportedSettlementChoice String?
  reporterEvidence         String[]
  reporterEvidenceAt       DateTime?
  reporterEvidenceNote     String?
  reporterSettlementChoice String?
  settlementOptions        String?
  settlementReachedAt      DateTime?
  settlementType           String?
  swapRequest              SwapRequest @relation(fields: [swapRequestId], references: [id])

  @@index([swapRequestId])
  @@index([reporterId])
  @@index([status])
  @@index([evidenceDeadline])
}

model ActivityFeed {
  id                 String   @id @default(cuid())
  type               String
  userId             String?
  userName           String?
  productId          String?
  productTitle       String?
  targetUserId       String?
  targetUserName     String?
  targetProductTitle String?
  city               String?
  metadata           String?
  createdAt          DateTime @default(now())

  @@index([createdAt])
  @@index([type])
}

model RateLimit {
  id          String   @id @default(cuid())
  identifier  String
  endpoint    String
  count       Int      @default(1)
  windowStart DateTime @default(now())

  @@unique([identifier, endpoint])
  @@index([windowStart])
}

model SystemConfig {
  id                    String    @id @default("main")
  totalValorSupply      BigInt    @default(1000000000)
  distributedValor      BigInt    @default(0)
  communityPoolValor    BigInt    @default(0)
  reserveValor          BigInt    @default(200000000)
  totalTransactions     Int       @default(0)
  totalFeesCollected    BigInt    @default(0)
  totalSwapsCompleted   Int       @default(0)
  totalMeltedValor      BigInt    @default(0)
  lastMeltProcessedAt   DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  // Dynamic Config - A/B Test ve Enflasyon Kontrolü için
  welcomeBonusAmount    Int       @default(50)
  dailyBonusBase        Int       @default(3)
  productBonusAmount    Int       @default(30)
  referralBonusAmount   Int       @default(15)
  reviewBonusAmount     Int       @default(10)
  minAccountAgeDays     Int       @default(7)
  requireVerification   Boolean   @default(true)
  // Haftalık Enflasyon İzleme
  weeklyDistributedValor BigInt   @default(0)
  lastWeeklyResetAt     DateTime?
}

model SwapFeedback {
  id            String      @id @default(cuid())
  swapRequestId String      @unique
  userId        String
  targetUserId  String
  isFair        Boolean
  fairnessScore Int         @default(3)
  priceAccuracy Int         @default(3)
  comment       String?
  createdAt     DateTime    @default(now())
  swapRequest   SwapRequest @relation(fields: [swapRequestId], references: [id])

  @@index([userId])
  @@index([targetUserId])
  @@index([createdAt])
  @@index([isFair])
}

model ValorTransaction {
  id            String       @id @default(cuid())
  fromUserId    String?
  toUserId      String?
  amount        Int
  fee           Int          @default(0)
  netAmount     Int
  type          String
  swapRequestId String?
  multiSwapId   String?
  feeBreakdown  String?
  description   String?
  createdAt     DateTime     @default(now())
  fromUser      User?        @relation("ValorSender", fields: [fromUserId], references: [id])
  swapRequest   SwapRequest? @relation(fields: [swapRequestId], references: [id])
  toUser        User?        @relation("ValorReceiver", fields: [toUserId], references: [id])

  @@index([fromUserId])
  @@index([toUserId])
  @@index([type])
  @@index([createdAt])
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String   @unique
  p256dh    String
  auth      String
  userAgent String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isActive])
}

model Review {
  id            String      @id @default(cuid())
  authorId      String
  targetUserId  String
  swapRequestId String
  rating        Int
  comment       String?
  tags          String[]
  response      String?
  responseAt    DateTime?
  isPublic      Boolean     @default(true)
  isVerified    Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  author        User        @relation("ReviewAuthor", fields: [authorId], references: [id])
  swapRequest   SwapRequest @relation(fields: [swapRequestId], references: [id])
  targetUser    User        @relation("ReviewTarget", fields: [targetUserId], references: [id])

  @@unique([authorId, swapRequestId])
  @@index([targetUserId])
  @@index([rating])
  @@index([createdAt])
}

model SystemMetrics {
  id          String   @id
  data        String
  lastUpdated DateTime @default(now())
}

model ErrorLog {
  id             String    @id @default(cuid())
  type           String
  message        String
  stack          String?
  componentStack String?
  url            String?
  userAgent      String?
  userId         String?
  metadata       String?
  severity       String    @default("error")
  resolved       Boolean   @default(false)
  resolvedAt     DateTime?
  resolvedBy     String?
  createdAt      DateTime  @default(now())
  user           User?     @relation(fields: [userId], references: [id])

  @@index([type])
  @@index([severity])
  @@index([resolved])
  @@index([createdAt])
  @@index([userId])
}

model SecurityLog {
  id        String   @id @default(cuid())
  eventType String
  ip        String
  userAgent String?
  userId    String?
  email     String?
  metadata  String?
  severity  String   @default("low")
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([ip])
  @@index([eventType])
  @@index([severity])
  @@index([createdAt])
  @@index([userId])
  @@index([email])
}

model GroupConversation {
  id          String                    @id @default(cuid())
  name        String?
  type        String                    @default("multi_swap")
  multiSwapId String?                   @unique
  createdAt   DateTime                  @default(now())
  updatedAt   DateTime                  @updatedAt
  creatorId   String
  isActive    Boolean                   @default(true)
  members     GroupConversationMember[]
  messages    GroupMessage[]

  @@index([multiSwapId])
  @@index([creatorId])
  @@index([type])
}

model GroupConversationMember {
  id                  String            @id @default(cuid())
  groupConversationId String
  userId              String
  role                String            @default("member")
  joinedAt            DateTime          @default(now())
  lastReadAt          DateTime?
  isActive            Boolean           @default(true)
  groupConversation   GroupConversation @relation(fields: [groupConversationId], references: [id], onDelete: Cascade)
  user                User              @relation(fields: [userId], references: [id])

  @@unique([groupConversationId, userId])
  @@index([userId])
}

model GroupMessage {
  id                  String            @id @default(cuid())
  groupConversationId String
  senderId            String
  content             String
  createdAt           DateTime          @default(now())
  isModerated         Boolean           @default(false)
  moderationReason    String?
  metadata            String?
  isRead              Boolean           @default(false)
  isSystem            Boolean           @default(false)
  groupConversation   GroupConversation @relation(fields: [groupConversationId], references: [id], onDelete: Cascade)
  sender              User              @relation(fields: [senderId], references: [id])

  @@index([groupConversationId])
  @@index([senderId])
  @@index([createdAt])
}
